<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HealthAI Pro — Nền Tảng Sức Khỏe Thông Minh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
<style>
/* ═══════════════════════════════════════════════
   HEALTHAI PRO — HealthTech Startup UI Redesign
   Palette: Blue/White Clean SaaS
═══════════════════════════════════════════════ */
:root {
  --primary: #0a68ff;
  --primary-dark: #0050d8;
  --primary-light: #3d87ff;
  --bg-main: #f4f9ff;
  --card-bg: #ffffff;
  --border: #e6eefc;
  --text-main: #1f2d3d;
  --text-sub: #6b7c93;
  --shadow-sm: 0 1px 4px rgba(10,104,255,0.06), 0 2px 12px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 24px rgba(10,104,255,0.10), 0 2px 8px rgba(0,0,0,0.05);
  --shadow-lg: 0 8px 40px rgba(10,104,255,0.14), 0 4px 16px rgba(0,0,0,0.07);
  --radius-sm: 12px;
  --radius-md: 16px;
  --radius-lg: 20px;
  --font-display: 'Plus Jakarta Sans', sans-serif;
  --font-body: 'DM Sans', sans-serif;
  --font-mono: 'Sora', monospace;
}

/* ═══════════════════════════════════════════════
   DYNAMIC THEME SYSTEM — Temperature-based
   Themes: body.theme-normal | .theme-warning | .theme-danger
═══════════════════════════════════════════════ */

/* --- Theme: Normal (default blue medical) --- */
body.theme-normal,
body:not(.theme-warning):not(.theme-danger) {
  --primary: #0a68ff;
  --primary-dark: #0050d8;
  --primary-light: #3d87ff;
  --background: #f4f9ff;
  --bg-main: #f4f9ff;
  --card-bg: #ffffff;
  --text-main: #1f2d3d;
  --text-secondary: #6b7c93;
  --text-sub: #6b7c93;
  --border: #e6eefc;
  --shadow-sm: 0 1px 4px rgba(10,104,255,0.06), 0 2px 12px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 24px rgba(10,104,255,0.10), 0 2px 8px rgba(0,0,0,0.05);
  --shadow-lg: 0 8px 40px rgba(10,104,255,0.14), 0 4px 16px rgba(0,0,0,0.07);
  --theme-glow: rgba(10,104,255,0.12);
  --theme-badge-bg: rgba(10,104,255,0.08);
  --theme-badge-border: rgba(10,104,255,0.2);
}

/* --- Theme: Warning (orange - elevated temperature) --- */
body.theme-warning {
  --primary: #ff9800;
  --primary-dark: #e65100;
  --primary-light: #ffb74d;
  --background: #fff8e1;
  --bg-main: #fff8e1;
  --card-bg: #fffdf5;
  --text-main: #2d1f00;
  --text-secondary: #8a6a2a;
  --text-sub: #8a6a2a;
  --border: #ffe0b2;
  --shadow-sm: 0 1px 4px rgba(255,152,0,0.10), 0 2px 12px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 24px rgba(255,152,0,0.15), 0 2px 8px rgba(0,0,0,0.05);
  --shadow-lg: 0 8px 40px rgba(255,152,0,0.18), 0 4px 16px rgba(0,0,0,0.07);
  --theme-glow: rgba(255,152,0,0.15);
  --theme-badge-bg: rgba(255,152,0,0.10);
  --theme-badge-border: rgba(255,152,0,0.3);
}

/* --- Theme: Danger (red - high fever) --- */
body.theme-danger {
  --primary: #e53935;
  --primary-dark: #b71c1c;
  --primary-light: #ef5350;
  --background: #ffebee;
  --bg-main: #ffebee;
  --card-bg: #fff5f5;
  --text-main: #2d0a0a;
  --text-secondary: #8a2a2a;
  --text-sub: #8a2a2a;
  --border: #ffcdd2;
  --shadow-sm: 0 1px 4px rgba(229,57,53,0.10), 0 2px 12px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 24px rgba(229,57,53,0.15), 0 2px 8px rgba(0,0,0,0.05);
  --shadow-lg: 0 8px 40px rgba(229,57,53,0.18), 0 4px 16px rgba(0,0,0,0.07);
  --theme-glow: rgba(229,57,53,0.15);
  --theme-badge-bg: rgba(229,57,53,0.08);
  --theme-badge-border: rgba(229,57,53,0.25);
}

/* --- Dark mode overlay --- */
body.dark-mode {
  --bg-main: #111827 !important;
  --background: #111827 !important;
  --card-bg: #1f2937 !important;
  --text-main: #f9fafb !important;
  --text-secondary: #9ca3af !important;
  --text-sub: #9ca3af !important;
  --border: #374151 !important;
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.3), 0 2px 12px rgba(0,0,0,0.2) !important;
  --shadow-md: 0 4px 24px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.25) !important;
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.5), 0 4px 16px rgba(0,0,0,0.3) !important;
}

/* ── Theme Indicator Banner ── */
#theme-alert-banner {
  position: fixed;
  top: 72px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  z-index: 9999;
  padding: 10px 24px;
  border-radius: 999px;
  font-family: var(--font-display);
  font-size: 0.82rem;
  font-weight: 700;
  color: #fff;
  background: var(--primary);
  box-shadow: 0 4px 20px var(--theme-glow);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease, transform 0.35s ease;
  white-space: nowrap;
}
#theme-alert-banner.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ── Theme Settings Panel ── */
#theme-settings-panel {
  position: fixed;
  bottom: 110px;
  right: 20px;
  width: 300px;
  background: var(--card-bg);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  z-index: 600;
  overflow: hidden;
  transform: scale(0.92) translateY(10px);
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  transform-origin: bottom right;
}
#theme-settings-panel.open {
  transform: scale(1) translateY(0);
  opacity: 1;
  pointer-events: all;
}
.tsp-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-main);
}
.tsp-title {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 0.88rem;
  color: var(--text-main);
}
.tsp-close {
  background: none;
  border: none;
  font-size: 1.1rem;
  cursor: pointer;
  color: var(--text-sub);
  line-height: 1;
  padding: 2px;
}
.tsp-body { padding: 16px; display: flex; flex-direction: column; gap: 14px; }
.tsp-row { display: flex; flex-direction: column; gap: 6px; }
.tsp-label {
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-sub);
}
.tsp-colors { display: flex; gap: 8px; flex-wrap: wrap; }
.tsp-color-btn {
  width: 32px; height: 32px;
  border-radius: 50%;
  border: 3px solid transparent;
  cursor: pointer;
  transition: transform 0.15s, border-color 0.15s;
  outline: none;
  position: relative;
}
.tsp-color-btn:hover { transform: scale(1.15); }
.tsp-color-btn.active { border-color: var(--text-main); }
.tsp-toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.tsp-toggle-lbl { font-size: 0.82rem; color: var(--text-main); font-weight: 500; }
/* iOS-style toggle */
.tsp-toggle {
  position: relative; width: 44px; height: 24px;
  appearance: none; -webkit-appearance: none;
  background: #d1d5db; border-radius: 999px;
  cursor: pointer; transition: background 0.2s;
  outline: none;
}
.tsp-toggle:checked { background: var(--primary); }
.tsp-toggle::after {
  content: '';
  position: absolute;
  width: 18px; height: 18px;
  background: #fff;
  border-radius: 50%;
  top: 3px; left: 3px;
  transition: transform 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.tsp-toggle:checked::after { transform: translateX(20px); }

/* Temp simulation input inside sidebar */
.temp-sim-wrap {
  background: var(--bg-main);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  margin-top: 8px;
}
.temp-sim-label {
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-sub);
  margin-bottom: 8px;
  display: block;
}
.temp-sim-row { display: flex; gap: 8px; }
.temp-sim-input {
  flex: 1;
  padding: 7px 11px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 0.88rem;
  font-family: var(--font-body);
  color: var(--text-main);
  background: var(--card-bg);
  outline: none;
  transition: border-color 0.2s;
}
.temp-sim-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--theme-badge-bg); }
.temp-sim-btn {
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 7px 14px;
  font-size: 0.82rem;
  font-weight: 700;
  font-family: var(--font-display);
  cursor: pointer;
  transition: background 0.2s;
  white-space: nowrap;
}
.temp-sim-btn:hover { background: var(--primary-dark); }


/* ── HA History Box ── */
#ha-history-wrap { display:none; margin-top:12px; }
.ha-hist-head { display:flex; justify-content:space-between; align-items:center;
  font-weight:700; font-size:0.85rem; color:var(--text-main);
  padding:10px 14px; background:var(--bg-main);
  border-bottom:1px solid var(--border); border-radius:var(--radius-sm) var(--radius-sm) 0 0; }
.ha-hist-head button { background:none; border:none; color:var(--text-sub);
  font-size:0.78rem; cursor:pointer; }
.ha-hist-head button:hover { color:var(--primary); }
.ha-hist-list { display:flex; flex-direction:column; gap:6px; padding:10px 14px; }
.ha-hist-item { display:flex; align-items:center; gap:8px; font-size:0.78rem;
  padding:7px 10px; background:var(--bg-main); border:1px solid var(--border);
  border-radius:8px; cursor:default; }
.ha-hist-item-time { color:var(--text-sub); white-space:nowrap; font-size:0.72rem; }
.ha-hist-item-vals { color:var(--text-main); flex:1; }

/* Theme settings FAB button */
#theme-settings-fab {
  position: fixed;
  bottom: 100px;
  right: 20px;
  width: 44px; height: 44px;
  border-radius: 50%;
  background: var(--card-bg);
  border: 1.5px solid var(--border);
  box-shadow: var(--shadow-md);
  cursor: pointer;
  z-index: 601;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
  transition: all 0.2s;
  color: var(--text-main);
}
#theme-settings-fab:hover { transform: scale(1.1); box-shadow: var(--shadow-lg); }

/* ── Base ── */
*, *::before, *::after { box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--font-body);
  background: var(--bg-main);
  color: var(--text-main);
  line-height: 1.7;
  overflow-x: hidden;
  /* Smooth theme transition */
  transition: background-color 0.5s ease, color 0.5s ease;
}
h1,h2,h3,h4,h5,h6 {
  font-family: var(--font-display);
  color: var(--text-main);
  letter-spacing: -0.3px;
}

/* ══════════════════════════════════════
   NAVBAR
══════════════════════════════════════ */
.navbar {
  background: rgba(255,255,255,0.96) !important;
  border-bottom: 1px solid var(--border) !important;
  box-shadow: 0 1px 12px rgba(10,104,255,0.07) !important;
  padding: 0.6rem 0;
}
.navbar-brand {
  font-family: var(--font-display) !important;
  font-size: 1.25rem !important;
  font-weight: 800 !important;
  color: var(--primary) !important;
  letter-spacing: -0.5px !important;
}
.navbar-brand span { color: var(--text-main); }
.navbar-nav .nav-link {
  font-family: var(--font-body) !important;
  font-size: 0.875rem !important;
  font-weight: 500 !important;
  color: var(--text-sub) !important;
  padding: 0.45rem 0.75rem !important;
  border-radius: 8px;
  transition: background 0.2s, color 0.2s;
}
.navbar-nav .nav-link:hover {
  background: rgba(10,104,255,0.06) !important;
  color: var(--primary) !important;
}
.navbar-nav .dropdown-toggle::after { transition: transform 0.2s; }
@media (min-width: 992px) {
  .navbar-nav .dropdown:hover > .dropdown-menu { display: block; margin-top: 0; }
  .navbar-nav .dropdown:hover > .dropdown-toggle::after { transform: rotate(180deg); }
}
.dropdown-menu {
  border: 1px solid var(--border) !important;
  border-radius: var(--radius-sm) !important;
  box-shadow: var(--shadow-md) !important;
  padding: 0.5rem 0;
  min-width: 220px;
}
.dropdown-item {
  font-size: 0.875rem;
  color: var(--text-sub);
  padding: 0.45rem 1rem;
  transition: background 0.15s, color 0.15s;
}
.dropdown-item:hover { background: rgba(10,104,255,0.06) !important; color: var(--primary) !important; }
.navbar-toggler { border-color: var(--border) !important; }

/* Lang buttons */
.lang-toggle-wrap { display:flex; align-items:center; gap:4px; flex-shrink:0; }
.lang-btn {
  background: transparent;
  border: 1.5px solid var(--border);
  border-radius: 999px;
  padding: 4px 12px;
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--text-sub);
  cursor: pointer;
  transition: all 0.18s ease;
  white-space: nowrap;
}
.lang-btn:hover { background: rgba(10,104,255,0.07); border-color: var(--primary); color: var(--primary); }
.lang-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(10,104,255,0.28); }

/* ══════════════════════════════════════
   HERO SECTION — 2 column split
══════════════════════════════════════ */
.header-banner {
  position: relative;
  min-height: 92vh;
  background: #f0f6ff;
  display: flex;
  align-items: center;
  overflow: hidden;
  padding: 80px 0 60px;
}
/* Soft grid overlay */
.header-banner::before {
  content: '';
  position: absolute; inset: 0;
  background-image:
    linear-gradient(var(--border) 1px, transparent 1px),
    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 48px 48px;
  opacity: 0.55;
  pointer-events: none;
}
/* Blue glow blobs */
.header-banner::after {
  content: '';
  position: absolute;
  top: -80px; right: -80px;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(10,104,255,0.12) 0%, transparent 70%);
  pointer-events: none;
}
.hero-blob-2 {
  position: absolute;
  bottom: -100px; left: -60px;
  width: 400px; height: 400px;
  background: radial-gradient(circle, rgba(10,104,255,0.08) 0%, transparent 70%);
  pointer-events: none;
}
.hero-left { position: relative; z-index: 2; }
.hero-right { position: relative; z-index: 2; }

/* Hero badge */
.hero-badge {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  background: rgba(10,104,255,0.08);
  border: 1px solid rgba(10,104,255,0.2);
  border-radius: 999px;
  padding: 5px 16px;
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: 0.5px;
  margin-bottom: 1.5rem;
}
.hero-badge::before { content: ''; width: 7px; height: 7px; background: var(--primary); border-radius: 50%; display: block; animation: hbpulse 2s ease-in-out infinite; }
@keyframes hbpulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }

/* Hero heading */
.hero-h1 {
  font-family: var(--font-display) !important;
  font-size: clamp(2rem, 4vw, 3.2rem) !important;
  font-weight: 800 !important;
  color: var(--text-main) !important;
  line-height: 1.15 !important;
  letter-spacing: -0.6px !important;
  margin-bottom: 1.2rem !important;
}
.hero-h1 .accent { color: var(--primary); }
.hero-desc {
  font-size: 1.05rem;
  color: var(--text-sub);
  max-width: 480px;
  margin-bottom: 2rem;
  line-height: 1.75;
}
.hero-cta-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 2.5rem; }
.btn-hero-primary {
  display: inline-flex; align-items: center; gap: 8px;
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 13px 28px;
  border-radius: 999px;
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 0.9rem;
  text-decoration: none;
  box-shadow: 0 4px 16px rgba(10,104,255,0.35);
  transition: all 0.25s;
}
.btn-hero-primary:hover { background: var(--primary-dark); color: #fff; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(10,104,255,0.4); }
.btn-hero-secondary {
  display: inline-flex; align-items: center; gap: 8px;
  background: transparent;
  color: var(--primary);
  border: 1.5px solid var(--primary);
  padding: 12px 26px;
  border-radius: 999px;
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 0.9rem;
  text-decoration: none;
  transition: all 0.25s;
}
.btn-hero-secondary:hover { background: rgba(10,104,255,0.07); color: var(--primary); transform: translateY(-2px); }

/* Hero stats */
.hero-stats { display: flex; gap: 28px; flex-wrap: wrap; }
.hero-stat-item { display: flex; flex-direction: column; }
.hero-stat-num {
  font-family: var(--font-mono);
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--text-main);
  line-height: 1.2;
}
.hero-stat-lbl { font-size: 0.78rem; color: var(--text-sub); font-weight: 500; }

/* Hero illustration card */
.hero-illus-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  padding: 28px;
  position: relative;
}
.hero-monitor-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  padding-bottom: 14px;
  border-bottom: 1px solid var(--border);
}
.hm-dot { width: 10px; height: 10px; border-radius: 50%; }
.hm-dot.red { background: #ff5f57; }
.hm-dot.yellow { background: #febc2e; }
.hm-dot.green { background: #28c840; }
.hm-title { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); margin-left: 6px; font-family: var(--font-mono); }

.hero-vitals-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.hv-item {
  background: var(--bg-main);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 12px;
  text-align: center;
}
.hv-val { font-family: var(--font-mono); font-size: 1.5rem; font-weight: 800; color: var(--text-main); line-height: 1.2; }
.hv-val.blue { color: var(--primary); }
.hv-val.green { color: #0ea56b; }
.hv-lbl { font-size: 0.68rem; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; }

.hero-chart-mock {
  height: 90px;
  position: relative;
  margin-bottom: 16px;
  overflow: hidden;
}
.hero-chart-mock svg { width: 100%; height: 100%; }

.hero-status-row { display: flex; align-items: center; gap: 8px; }
.h-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #0ea56b; animation: hsdpulse 2s infinite; flex-shrink: 0; }
@keyframes hsdpulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
.h-status-txt { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); }

/* Floating cards on illustration */
.hero-float-card {
  position: absolute;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-md);
  padding: 10px 14px;
  animation: floatCard 3s ease-in-out infinite;
}
.hero-float-card:nth-child(2) { animation-delay: 1s; }
.hero-float-card:nth-child(3) { animation-delay: 2s; }
@keyframes floatCard { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
.hfc-icon { font-size: 1.1rem; }
.hfc-txt { font-size: 0.72rem; font-weight: 700; color: var(--text-main); }
.hfc-sub { font-size: 0.62rem; color: var(--text-sub); }

/* ══════════════════════════════════════
   SECTION COMMON STYLES
══════════════════════════════════════ */
section, .main-section {
  padding: 72px 0;
}
.section-tag {
  display: inline-block;
  font-size: 0.72rem;
  font-weight: 800;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--primary);
  background: rgba(10,104,255,0.08);
  border-radius: 999px;
  padding: 4px 14px;
  margin-bottom: 1rem;
}
.section-title {
  font-family: var(--font-display);
  font-size: clamp(1.6rem, 3vw, 2.2rem);
  font-weight: 800;
  color: var(--text-main);
  letter-spacing: -0.4px;
  margin-bottom: 0.75rem;
}
.section-desc {
  color: var(--text-sub);
  font-size: 1rem;
  max-width: 520px;
}

/* ── Clean card ── */
.clean-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  padding: 28px 24px;
  transition: box-shadow 0.3s, transform 0.3s;
}
.clean-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-3px);
}

/* ══════════════════════════════════════
   FEATURE SECTION
══════════════════════════════════════ */
.features-section { background: var(--bg-main); }
.feature-icon-wrap {
  width: 52px; height: 52px;
  background: rgba(10,104,255,0.08);
  border: 1px solid rgba(10,104,255,0.15);
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 18px;
  transition: background 0.3s;
}
.clean-card:hover .feature-icon-wrap { background: rgba(10,104,255,0.14); }
.feature-icon-wrap svg { width: 24px; height: 24px; stroke: var(--primary); fill: none; stroke-width: 1.8; }
.feature-title { font-family: var(--font-display); font-weight: 700; font-size: 1rem; color: var(--text-main); margin-bottom: 8px; }
.feature-desc { font-size: 0.88rem; color: var(--text-sub); line-height: 1.7; margin: 0; }

/* ══════════════════════════════════════
   DASHBOARD PREVIEW SECTION
══════════════════════════════════════ */
.dashboard-preview-section { background: white; }
.dash-preview-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
}
.dash-topbar {
  background: var(--bg-main);
  border-bottom: 1px solid var(--border);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.dash-dots { display:flex; gap:6px; }
.dash-dot { width:10px; height:10px; border-radius:50%; }
.dash-dot.r{background:#ff5f57} .dash-dot.y{background:#febc2e} .dash-dot.g{background:#28c840}
.dash-topbar-title { font-size: 0.8rem; color: var(--text-sub); font-weight: 600; margin-left: 8px; font-family: var(--font-mono); }
.dash-body { padding: 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
@media(max-width:768px) { .dash-body { grid-template-columns: 1fr; } }
.dash-metric-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 16px; }
.dash-metric {
  background: var(--bg-main);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px;
}
.dm-val { font-family: var(--font-mono); font-size: 1.6rem; font-weight: 800; color: var(--text-main); }
.dm-val.blue { color: var(--primary); }
.dm-val.green { color: #0ea56b; }
.dm-lbl { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600; color: var(--text-sub); margin-top: 2px; }
.dm-trend { font-size: 0.72rem; color: #0ea56b; font-weight: 600; margin-top: 4px; }
.dm-trend.warn { color: #f59e0b; }

.dash-chart-area {
  background: var(--bg-main);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  height: 140px;
  position: relative;
  overflow: hidden;
}
.dash-chart-area svg { width: 100%; height: 100%; }

.dash-right { display: flex; flex-direction: column; gap: 12px; }
.dash-health-bar-card {
  background: var(--bg-main);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px;
}
.dhb-title { font-size: 0.78rem; font-weight: 700; color: var(--text-main); margin-bottom: 12px; font-family: var(--font-display); }
.dhb-row { margin-bottom: 10px; }
.dhb-label { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--text-sub); margin-bottom: 4px; }
.dhb-bar-wrap { background: rgba(10,104,255,0.08); border-radius: 999px; height: 6px; overflow: hidden; }
.dhb-bar { height: 100%; border-radius: 999px; background: var(--primary); }
.dhb-bar.green { background: #0ea56b; }
.dhb-bar.yellow { background: #f59e0b; }

.dash-ai-status {
  background: rgba(10,104,255,0.04);
  border: 1px solid rgba(10,104,255,0.15);
  border-radius: var(--radius-sm);
  padding: 14px;
  flex: 1;
}
.das-head { font-size: 0.78rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.das-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--primary); animation: hsdpulse 2s infinite; }
.das-item { font-size: 0.72rem; color: var(--text-sub); padding: 5px 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
.das-item:last-child { border: none; }
.das-ok { color: #0ea56b; font-weight: 700; }

/* ══════════════════════════════════════
   AI SECTION
══════════════════════════════════════ */
.ai-highlight-section { background: var(--bg-main); }
.ai-box {
  background: var(--card-bg);
  border: 1.5px solid rgba(10,104,255,0.2);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  padding: 40px 40px;
  display: flex;
  align-items: center;
  gap: 40px;
  flex-wrap: wrap;
}
.ai-box-icon { font-size: 3.5rem; flex-shrink: 0; }
.ai-box-content { flex: 1; min-width: 240px; }
.ai-box-title { font-family: var(--font-display); font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 10px; }
.ai-box-desc { color: var(--text-sub); font-size: 0.95rem; line-height: 1.7; margin: 0; }
.ai-box-cta { flex-shrink: 0; }

/* ══════════════════════════════════════
   EXISTING SECTIONS — Blue Theme Override
══════════════════════════════════════ */

/* Sidebar & chatbox */
.sidebar-card {
  background: var(--card-bg);
  border: 1px solid var(--border) !important;
  border-radius: var(--radius-lg) !important;
  overflow: hidden;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-sm) !important;
}
.sidebar-title {
  background: var(--primary) !important;
  color: white !important;
  padding: 12px 18px !important;
  font-weight: 700;
  font-size: 0.82rem;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  font-family: var(--font-display);
}
.vitals-box {
  background: var(--bg-main) !important;
  border: none !important;
  border-radius: 0 !important;
  padding: 1.25rem !important;
}
.metric-big {
  font-family: var(--font-mono) !important;
  font-size: 2rem !important;
  font-weight: 800 !important;
  color: var(--primary) !important;
  line-height: 1 !important;
}
#chatbox {
  height: 340px;
  background: var(--bg-main);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  scroll-behavior: smooth;
  font-size: 0.88rem;
}
.bubble-user {
  background: var(--primary) !important;
  color: white;
  align-self: flex-end;
  max-width: 82%;
  padding: 9px 13px;
  border-radius: 16px 16px 4px 16px;
  margin: 4px 0;
  word-wrap: break-word;
  font-size: 0.88rem;
  line-height: 1.45;
}
.bubble-bot {
  background: white;
  border: 1px solid var(--border);
  align-self: flex-start;
  max-width: 88%;
  padding: 9px 13px;
  border-radius: 16px 16px 16px 4px;
  margin: 4px 0;
  word-wrap: break-word;
  box-shadow: var(--shadow-sm);
  font-size: 0.88rem;
  line-height: 1.5;
}
.bubble-bot p { margin: 0 0 4px; } .bubble-bot p:last-child { margin: 0; }
.bubble-bot strong { color: var(--primary-dark); }
.bubble-bot ul { margin: 4px 0 4px 16px; padding: 0; }
.bubble-bot li { margin: 2px 0; }
.bubble-typing { background: white; border: 1px solid var(--border); align-self: flex-start; padding: 10px 14px; border-radius: 16px 16px 16px 4px; margin: 4px 0; box-shadow: var(--shadow-sm); }
.typing-dots { display:flex; gap:4px; align-items:center; height:14px; }
.typing-dots span { width:6px; height:6px; background:#bbb; border-radius:50%; animation:tdot 1.2s infinite; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes tdot { 0%,60%,100%{transform:translateY(0);opacity:.5} 30%{transform:translateY(-5px);opacity:1} }
.bubble-bot .tag-warn { display:inline-block; background:#fff3cd; color:#856404; border:1px solid #ffc107; border-radius:4px; padding:1px 6px; font-size:0.78rem; font-weight:600; margin-right:4px; }
.bubble-bot .tag-ok { display:inline-block; background:#d1e7dd; color:#0a3622; border:1px solid #a3cfbb; border-radius:4px; padding:1px 6px; font-size:0.78rem; font-weight:600; margin-right:4px; }
.bubble-bot .tag-danger { display:inline-block; background:#f8d7da; color:#842029; border:1px solid #f1aeb5; border-radius:4px; padding:1px 6px; font-size:0.78rem; font-weight:600; margin-right:4px; }
.chat-suggestion-row { display:flex; flex-wrap:wrap; gap:5px; margin:6px 0 2px; align-self:flex-start; max-width:100%; }
.chat-sugg { background:#fff; border:1.5px solid var(--primary); color:var(--primary); border-radius:20px; padding:4px 11px; font-size:0.78rem; font-weight:600; cursor:pointer; transition:all .15s; white-space:nowrap; }
.chat-sugg:hover { background:var(--primary); color:#fff; }
#chat-clear-btn { background:none; border:none; color:#aaa; font-size:11px; cursor:pointer; padding:2px 6px; border-radius:4px; transition:color .15s; }
#chat-clear-btn:hover { color:var(--primary); }

/* Chat input bar */
.chat-input-bar {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--card-bg);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 6px 8px;
  margin-top: 8px;
  transition: border-color 0.2s;
}
.chat-input-bar:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(10,104,255,0.1); }
.chat-tool-btn {
  background: none; border: none; cursor: pointer; padding: 4px 6px;
  border-radius: 8px; color: var(--text-sub); font-size: 1rem;
  display: flex; align-items: center; transition: background 0.15s, color 0.15s;
}
.chat-tool-btn:hover { background: var(--bg-main); color: var(--primary); }
.chat-main-input {
  flex: 1; border: none; background: none; outline: none;
  font-family: var(--font-body); font-size: 0.88rem; color: var(--text-main);
}
.chat-main-input::placeholder { color: #b0bdcc; }
.chat-send-btn {
  background: var(--primary); border: none; border-radius: 8px; padding: 7px 10px;
  color: white; cursor: pointer; display: flex; align-items: center;
  transition: background 0.2s, transform 0.2s;
}
.chat-send-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
.chat-mic-btn.active { color: var(--primary); }

/* HealthStore badge */
.hs-sync-badge {
  display: inline-block; font-size: 10px; font-weight: 700;
  color: #0ea56b; background: rgba(14,165,107,0.1); border: 1px solid rgba(14,165,107,0.3);
  border-radius: 4px; padding: 2px 7px; opacity: 0;
  transition: opacity 0.4s; margin-left: 8px; vertical-align: middle;
}
.hs-store-info {
  font-size: 11px; color: #888; margin-bottom: 8px;
  display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
}
.hs-store-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--primary); display: inline-block; animation: hspulse 2s infinite; }
@keyframes hspulse { 0%,100%{opacity:1} 50%{opacity:.3} }
.dot1,.dot2,.dot3 { animation: dot 1.5s infinite }
.dot1{animation-delay:0s} .dot2{animation-delay:0.2s} .dot3{animation-delay:0.4s}
@keyframes dot { 0%,80%,100%{opacity:0} 40%{opacity:1} }

/* ── YouTube card ── */
.yt-card {
  display: inline-block; min-width: 160px; max-width: 180px;
  background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-sm);
  text-decoration: none; color: var(--text-main); overflow: hidden; flex-shrink: 0;
  transition: box-shadow 0.2s, transform 0.2s;
}
.yt-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.yt-thumb-wrap { position: relative; overflow: hidden; }
.yt-thumb-wrap img { width: 100%; display: block; }
.yt-play-overlay { position: absolute; inset: 0; background: rgba(10,104,255,0.25); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
.yt-card:hover .yt-play-overlay { opacity: 1; }
.yt-play-icon { width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; }
.yt-card-body { padding: 9px 10px; }
.yt-card-title { font-size: 0.78rem; font-weight: 700; color: var(--text-main); margin-bottom: 4px; line-height: 1.4; }
.yt-card-link { font-size: 0.7rem; color: var(--primary); font-weight: 600; }

/* ── Section backgrounds ── */
#section-nhat-ky-ai { background: white; }
#section-tu-van-ai { background: var(--bg-main); }
#section-healing { background: white; }

/* ── PIN BOARD ── */
.pinboard-section {
  position: relative;
  background:
    linear-gradient(#edf3ff 1px, transparent 1px),
    linear-gradient(90deg, #edf3ff 1px, transparent 1px),
    #f4f9ff;
  background-size: 32px 32px, 32px 32px, 100% 100%;
  border-radius: 20px;
  padding: 36px 24px 44px;
  margin: 28px 0 36px;
  box-shadow: inset 0 2px 10px rgba(0,0,0,0.03), 0 4px 20px rgba(10,104,255,0.07);
}
.pinboard-label {
  font-family: var(--font-display);
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-sub);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.pinboard-label::before, .pinboard-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border), transparent);
}
.note-card {
  background: #fffdf5;
  border-radius: 14px;
  padding: 22px 20px 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
  position: relative;
  border: 1px solid rgba(0,0,0,0.06);
}
.note-card.note-yellow { background: #fffbe6; }
.note-card.note-pink   { background: #fff2f2; }
.note-card.note-mint   { background: #f0fdf6; }
.note-pin {
  position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
  width: 24px; height: 40px; z-index: 2;
}
.note-title {
  font-family: var(--font-display); font-weight: 700; font-size: 0.88rem;
  color: var(--text-main); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
}
.note-title-icon { font-size: 1rem; }
.note-body { font-size: 0.82rem; color: var(--text-sub); line-height: 1.7; }
.note-list { list-style: none; padding: 0; margin: 0; }
.note-list li { padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
.note-list li:last-child { border: none; }
.note-list li strong { color: var(--text-main); display: block; font-size: 0.82rem; }
.note-tip { background: rgba(10,104,255,0.06); border-left: 3px solid var(--primary); border-radius: 6px; padding: 10px 12px; font-size: 0.78rem; color: var(--text-sub); margin-top: 10px; }

/* Note animations */
.note-hidden { opacity: 0; transform: translateY(20px); }
.note-visible { opacity: 1; transform: translateY(0); transition: opacity 0.6s ease, transform 0.6s ease; }
.floating { animation: noteFloat 4s ease-in-out infinite; }
@keyframes noteFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

/* ── Nurse mascot ── */
#nurse-mascot {
  position: fixed; bottom: 20px; right: 20px; width: 72px;
  cursor: pointer; z-index: 500; filter: drop-shadow(0 4px 12px rgba(10,104,255,0.25));
  transition: filter 0.3s;
}
#nurse-mascot:hover { filter: drop-shadow(0 6px 18px rgba(10,104,255,0.38)); }
.nurse-speech {
  position: absolute; bottom: 100%; right: 0; background: var(--primary);
  color: white; border-radius: 12px 12px 4px 12px; padding: 6px 12px;
  font-size: 11px; font-weight: 700; white-space: nowrap; opacity: 0;
  transform: translateY(6px); transition: all 0.3s; pointer-events: none;
  margin-bottom: 8px;
}
#nurse-mascot:hover .nurse-speech { opacity: 1; transform: translateY(0); }
.nurse-eye { animation: blink 4s ease-in-out infinite; }
@keyframes blink { 0%,90%,100%{transform:scaleY(1)} 95%{transform:scaleY(0.1)} }
#nurse-mascot.bounce { animation: nurseBounce 0.6s ease-in-out; }
@keyframes nurseBounce { 0%,100%{transform:translateY(0)} 30%{transform:translateY(-14px)} 60%{transform:translateY(-6px)} }

/* ══════════════════════════════════════
   NKAI SECTION (AI Diary)
══════════════════════════════════════ */
.nkai-section-head {
  text-align: center;
  padding: 56px 20px 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}
.nkai-section-head h2 {
  font-family: var(--font-display) !important;
  font-size: 1.8rem !important;
  font-weight: 800 !important;
  color: var(--text-main) !important;
}
.nkai-ai-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(10,104,255,0.08); border: 1px solid rgba(10,104,255,0.2);
  border-radius: 999px; padding: 4px 14px;
  font-size: 0.72rem; font-weight: 700; color: var(--primary);
}
.nkai-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
  max-width: 1100px; margin: 0 auto; padding: 0 20px 56px;
}
@media(max-width:768px) { .nkai-grid { grid-template-columns: 1fr; } }
.nkai-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
.nkai-video-head, .nkai-diary-head {
  background: var(--bg-main);
  border-bottom: 1px solid var(--border);
  padding: 14px 18px;
  font-family: var(--font-display);
  font-weight: 700; font-size: 0.9rem;
  color: var(--text-main);
  display: flex; align-items: center; gap: 8px;
}
.nkai-video-body { padding: 18px; }
.nkai-video-search { display: flex; gap: 8px; margin-bottom: 12px; }
.nkai-video-search input {
  flex: 1; padding: 8px 12px; border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); font-size: 0.85rem; font-family: var(--font-body);
  outline: none; transition: border-color 0.2s;
}
.nkai-video-search input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(10,104,255,0.1); }
.nkai-video-search button {
  background: var(--primary); color: white; border: none;
  border-radius: var(--radius-sm); padding: 8px 16px; cursor: pointer;
  font-weight: 700; font-size: 0.85rem; transition: background 0.2s;
}
.nkai-video-search button:hover { background: var(--primary-dark); }
.nkai-video-player {
  background: var(--bg-main); border: 1px solid var(--border); min-height: 140px;
  display: flex; align-items: center; justify-content: center;
  border-radius: var(--radius-sm); overflow: hidden;
}
.nkai-video-placeholder { display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-sub); font-size:0.8rem; padding:20px; text-align:center; }
.nkai-quick-btns { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
.nkai-yt-btn {
  background: rgba(10,104,255,0.07); border: 1px solid rgba(10,104,255,0.18);
  border-radius: 999px; padding: 4px 12px; font-size: 0.75rem; font-weight: 700;
  color: var(--primary); text-decoration: none; transition: all 0.15s;
}
.nkai-yt-btn:hover { background: var(--primary); color: white; }

/* NKAI form */
.nkai-form { padding: 18px; }
.nkai-row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
.nkai-field { margin-bottom: 12px; }
.nkai-field label { display: block; font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-sub); margin-bottom: 5px; }
.nkai-field label .unit { text-transform: none; letter-spacing: 0; color: var(--primary); font-weight: 500; font-size: 0.72rem; }
.nkai-inp {
  width: 100%; padding: 8px 12px; border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); font-size: 0.85rem; font-family: var(--font-body);
  background: var(--bg-main); color: var(--text-main); outline: none; transition: border-color 0.2s;
}
.nkai-inp:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(10,104,255,0.1); background: white; }
.nkai-slider-wrap { display: flex; align-items: center; gap: 10px; }
.nkai-slider-wrap input[type='range'] { flex: 1; height: 6px; accent-color: var(--primary); }
.nkai-slider-val { font-family: var(--font-mono); font-size: 1.1rem; font-weight: 700; color: var(--primary); min-width: 28px; text-align: center; }
#nkai-stress-lbl { font-family: var(--font-mono); font-weight: 700; color: var(--primary); }
.nkai-btn {
  width: 100%; padding: 13px; background: var(--primary); color: white;
  border: none; border-radius: var(--radius-sm); font-family: var(--font-display);
  font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center;
  justify-content: center; gap: 8px; transition: all 0.2s;
}
.nkai-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
.nkai-spin { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: nspin 0.8s linear infinite; display: none; }
@keyframes nspin { to { transform: rotate(360deg); } }
.nkai-loading { display: none; text-align: center; padding: 28px; color: var(--text-sub); font-size: 0.88rem; }
.nkai-pulse { font-size: 2rem; animation: npulse 1s ease-in-out infinite; display: block; margin-bottom: 8px; }
@keyframes npulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.2)} }
.nkai-output { padding: 0 18px 18px; display: none; }
.nkai-history-wrap, #nkai-history-wrap { display: none; padding: 0 18px 18px; }
.nkai-history-head { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 0.85rem; color: var(--text-main); padding: 10px 0; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
.nkai-history-head button { background: none; border: none; color: var(--text-sub); font-size: 0.78rem; cursor: pointer; }
.nkai-history-head button:hover { color: var(--primary); }
.nkai-history-list { display: flex; flex-direction: column; gap: 8px; }

/* ══════════════════════════════════════
   HA (AI Consultation) SECTION
══════════════════════════════════════ */
#section-tu-van-ai {
  padding: 56px 0;
}
.ha-top-label {
  text-align: center; font-size: 0.72rem; font-weight: 800;
  letter-spacing: 1.5px; text-transform: uppercase; color: var(--primary);
  margin-bottom: 12px; font-family: var(--font-display);
  padding: 0 20px;
}
.ha-disclaimer {
  max-width: 800px; margin: 0 auto 32px; text-align: center;
  background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.25);
  border-radius: var(--radius-sm); padding: 12px 20px; font-size: 0.83rem;
  color: #856404; line-height: 1.6;
}
.ha-container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
.ha-wrap { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
@media(max-width:900px) { .ha-wrap { grid-template-columns: 1fr; } }
.ha-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: visible !important;
  box-shadow: var(--shadow-sm);
  margin-bottom: 20px;
  position: relative;
}
.ha-card:hover { box-shadow: var(--shadow-md); }
.ha-card-hd {
  background: var(--bg-main) !important;
  border-bottom: 1px solid var(--border) !important;
  padding: 12px 18px !important;
  font-family: var(--font-display) !important;
  font-weight: 700 !important;
  font-size: 0.85rem !important;
  color: var(--text-main) !important;
  letter-spacing: 0 !important;
  text-transform: none !important;
}
.ha-card-bd { padding: 18px !important; }
.ha-f2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px !important; }
.ha-fld { margin-bottom: 14px !important; }
.ha-fld label { display: block; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-sub); margin-bottom: 5px; font-family: var(--font-display) !important; }
.ha-fld label .u { text-transform: none !important; letter-spacing: 0; color: var(--primary); font-weight: 500; font-size: 0.7rem; }
.ha-inp {
  width: 100%; padding: 8px 12px; border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); font-size: 0.85rem; font-family: var(--font-body);
  background: var(--bg-main); color: var(--text-main); outline: none;
  transition: border-color 0.2s; resize: vertical; min-height: 36px;
}
.ha-inp:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(10,104,255,0.1) !important; background: white; transform: none !important; }
.ha-egrid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
.ha-epill {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--bg-main); border: 1.5px solid var(--border);
  border-radius: 999px; padding: 5px 12px; font-size: 0.78rem;
  font-weight: 600; color: var(--text-sub); cursor: pointer; transition: all 0.15s;
}
.ha-epill:hover { border-color: var(--primary); color: var(--primary); background: rgba(10,104,255,0.05); }
.ha-epill.active { background: var(--primary); border-color: var(--primary); color: white; }
.ha-epill .ei { font-size: 0.9rem; }
.ha-btn {
  width: 100%; padding: 13px; background: var(--primary); color: white;
  border: none; border-radius: var(--radius-sm); font-family: var(--font-display);
  font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center;
  justify-content: center; gap: 8px; transition: all 0.2s; letter-spacing: 0.5px;
}
.ha-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
.ha-spin { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: nspin 0.8s linear infinite; display: none; }
.ha-load { display: none; text-align: center; padding: 32px; }
.ha-pulse { font-size: 2.5rem; animation: npulse 0.9s ease-in-out infinite; display: block; margin-bottom: 12px; }
.ha-lt { font-family: var(--font-display); font-weight: 700; color: var(--text-main); font-size: 1rem; margin-bottom: 6px; }
.ha-ls { font-size: 0.82rem; color: var(--text-sub); margin-bottom: 16px; }
.ha-lsteps { text-align: left; display: flex; flex-direction: column; gap: 6px; }
.ha-lstep { font-size: 0.8rem; color: var(--text-sub); padding: 6px 12px; background: var(--bg-main); border-radius: 8px; border-left: 3px solid var(--border); }
.ha-lstep.active { border-left-color: var(--primary); color: var(--primary); font-weight: 600; }
.ha-err { display: none; background: #fff2f2; border: 1px solid #ffcdd2; color: #c62828; border-radius: var(--radius-sm); padding: 12px 16px; font-size: 0.85rem; margin-bottom: 16px; }
#ha-out { }
.ha-vs { display: flex; flex-direction: column; gap: 10px; }
.ha-v {
  display: flex; align-items: center; gap: 10px;
  background: var(--bg-main); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 14px;
}
.ha-vl { font-size: 0.78rem; color: var(--text-sub); min-width: 100px; font-weight: 600; }
.ha-vv { font-family: var(--font-mono) !important; font-size: 1.1rem !important; font-weight: 700 !important; color: var(--text-main); }
.ha-vbar { flex: 1; height: 6px; background: rgba(10,104,255,0.1); border-radius: 999px; overflow: hidden; }
.ha-vfill { height: 100%; border-radius: 999px; transition: width 0.6s; }
.ha-vn { font-size: 0.72rem; color: var(--text-sub); }
.ha-fade { animation: haFadeIn 0.5s ease; }
@keyframes haFadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.ha-rs { }
.ha-rh { font-family: var(--font-display); font-weight: 700; font-size: 1rem; color: var(--text-main); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.ha-rsn { font-family: var(--font-mono) !important; font-size: 2.2rem !important; font-weight: 900 !important; }
.ha-rbl { font-family: var(--font-display) !important; font-size: 1rem !important; font-weight: 700 !important; }
.ha-rbt, .ha-rss, .ha-rbex { font-size: 0.82rem; color: var(--text-sub); line-height: 1.65; }
.ha-ft { font-size: 0.82rem; color: var(--text-sub); line-height: 1.7; }
.ha-hg { display: flex; flex-direction: column; gap: 10px; }
.ha-hi { background: var(--bg-main); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 14px; font-size: 0.84rem; color: var(--text-main); line-height: 1.65; }
.ha-m3 { display: flex; flex-direction: column; gap: 8px; }
.ha-mi { display: flex; align-items: flex-start; gap: 10px; background: var(--bg-main); border-radius: var(--radius-sm); padding: 10px 12px; border: 1px solid var(--border); }
.ha-mii { font-size: 1.1rem; flex-shrink: 0; }
.ha-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media(max-width:640px) { .ha-2col { grid-template-columns: 1fr; } .ha-f2 { grid-template-columns: 1fr; } }

/* Right sidebar HA */
.ha-sc {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: 16px;
  box-shadow: var(--shadow-sm);
}
.ha-shd {
  background: var(--bg-main);
  border-bottom: 1px solid var(--border);
  padding: 11px 16px;
  font-family: var(--font-display);
  font-weight: 700; font-size: 0.82rem;
  color: var(--text-main);
}
.ha-rr { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
.ha-rr:last-child { border: none; }
.ha-rl { color: var(--text-sub); }
.ha-rv { font-family: var(--font-mono); font-weight: 700; color: var(--text-main); font-size: 0.85rem; }
.ha-sb { padding: 16px; }
.ha-ib {
  background: rgba(10,104,255,0.05);
  border: 1px solid rgba(10,104,255,0.15);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  font-size: 0.8rem; color: var(--text-sub); line-height: 1.65;
  margin-bottom: 16px;
}

/* ══════════════════════════════════════════════════════════════
   HEALING SECTION — Bubble Infographic Pastel Design v3
   Tone: Vàng / Hồng / Mint / Xanh dương / Tím nhạt
══════════════════════════════════════════════════════════════ */

/* ── Pastel token palette ── */
:root {
  --ps-yellow:  #fff4c2;
  --ps-yellow2: #ffe985;
  --ps-pink:    #fce4ec;
  --ps-pink2:   #f9a8c9;
  --ps-mint:    #d6f5ea;
  --ps-mint2:   #6edcb0;
  --ps-blue:    #dbeafe;
  --ps-blue2:   #7ab8f5;
  --ps-purple:  #ede9fe;
  --ps-purple2: #b69af7;
  --ps-peach:   #fde8d8;
  --ps-peach2:  #f9b17a;
  --hs-bg-from: #fef9ff;
  --hs-bg-to:   #f0f7ff;
}

/* ── Section wrapper ── */
#section-healing {
  padding: 80px 0 100px;
  background: linear-gradient(160deg, var(--hs-bg-from) 0%, #fff8f8 40%, var(--hs-bg-to) 100%);
  position: relative;
  overflow: hidden;
}

/* Background decorative blobs */
#section-healing::before {
  content: '';
  position: absolute;
  width: 600px; height: 600px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(252,228,236,0.45) 0%, transparent 70%);
  top: -180px; left: -150px;
  pointer-events: none;
}
#section-healing::after {
  content: '';
  position: absolute;
  width: 500px; height: 500px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(214,245,234,0.4) 0%, transparent 70%);
  bottom: -100px; right: -100px;
  pointer-events: none;
}

.healing-wrap {
  max-width: 1160px;
  margin: 0 auto;
  padding: 0 24px;
  position: relative;
  z-index: 2;
}

/* ── Header ── */
.healing-section-head {
  text-align: center;
  display: flex; flex-direction: column;
  align-items: center; gap: 10px;
  margin-bottom: 56px;
}
.hs-head-icon {
  font-size: 2.6rem;
  filter: drop-shadow(0 4px 12px rgba(255,180,100,0.35));
  animation: hsIconBob 3.5s ease-in-out infinite;
}
@keyframes hsIconBob {
  0%,100% { transform: translateY(0) rotate(-4deg); }
  50%      { transform: translateY(-6px) rotate(4deg); }
}
.hs-head-eyebrow {
  font-size: 0.68rem; font-weight: 800; letter-spacing: 2px;
  text-transform: uppercase;
  background: linear-gradient(135deg, #f9a8c9, #b69af7);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  border-radius: 999px;
}
.hs-head-title {
  font-family: var(--font-display);
  font-size: clamp(1.6rem, 4vw, 2.4rem);
  font-weight: 800;
  background: linear-gradient(135deg, #d97ba8 0%, #7c6ef7 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px; line-height: 1.2;
}
.hs-head-sub {
  font-size: 0.9rem;
  color: #9580aa;
  max-width: 520px;
  line-height: 1.7;
}
#hsStateLine {
  font-family: var(--font-mono);
  font-size: 0.72rem;
  color: #b69af7;
  letter-spacing: 1px;
  background: rgba(182,154,247,0.1);
  border: 1px solid rgba(182,154,247,0.3);
  border-radius: 999px;
  padding: 4px 14px;
}

/* ══════════════════════════════════════
   BUBBLE INFOGRAPHIC GRID
══════════════════════════════════════ */
.healing-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(2, auto);
  gap: 24px;
  margin-bottom: 48px;
  position: relative;
}

/* ── Base hcard (bubble) ── */
.hcard {
  border-radius: 28px;
  padding: 28px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: transform 0.4s cubic-bezier(.34,1.56,.64,1),
              box-shadow 0.4s ease;
  animation: hcardFadeUp 0.6s ease both;
}
.hcard:nth-child(1){animation-delay:.05s}
.hcard:nth-child(2){animation-delay:.15s}
.hcard:nth-child(3){animation-delay:.25s}
.hcard:nth-child(4){animation-delay:.35s}

@keyframes hcardFadeUp {
  from { opacity: 0; transform: translateY(28px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0)    scale(1); }
}

.hcard:hover {
  transform: translateY(-8px) scale(1.02);
}

/* Bubble glow ring on hover */
.hcard::before {
  content: '';
  position: absolute; inset: 0;
  border-radius: inherit;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}
.hcard:hover::before { opacity: 1; }

/* ── Story bubble (pink) ── */
.hcard-story {
  background: linear-gradient(145deg, #fff0f5 0%, #fce4ec 60%, #f9e8ff 100%);
  border: 1.5px solid rgba(249,168,201,0.5);
  box-shadow: 0 8px 32px rgba(249,168,201,0.25),
              0 2px 8px rgba(0,0,0,0.04),
              inset 0 1px 0 rgba(255,255,255,0.8);
}
.hcard-story::before {
  background: linear-gradient(145deg, rgba(249,168,201,0.2), rgba(182,154,247,0.15));
  box-shadow: 0 0 0 3px rgba(249,168,201,0.35);
}
.hcard-story:hover { box-shadow: 0 20px 56px rgba(249,168,201,0.4), 0 4px 16px rgba(0,0,0,0.06); }

/* ── Breath bubble (mint) ── */
.hcard-breath {
  background: linear-gradient(145deg, #f0fdf8 0%, #d6f5ea 60%, #e0f7f0 100%);
  border: 1.5px solid rgba(110,220,176,0.5);
  box-shadow: 0 8px 32px rgba(110,220,176,0.25),
              0 2px 8px rgba(0,0,0,0.04),
              inset 0 1px 0 rgba(255,255,255,0.8);
}
.hcard-breath::before {
  background: linear-gradient(145deg, rgba(110,220,176,0.2), rgba(122,184,245,0.15));
  box-shadow: 0 0 0 3px rgba(110,220,176,0.35);
}
.hcard-breath:hover { box-shadow: 0 20px 56px rgba(110,220,176,0.4), 0 4px 16px rgba(0,0,0,0.06); }

/* ── Music bubble (blue/yellow) ── */
.hcard-music {
  background: linear-gradient(145deg, #fffdf0 0%, #fff4c2 60%, #dbeafe 100%);
  border: 1.5px solid rgba(255,233,133,0.6);
  box-shadow: 0 8px 32px rgba(255,220,80,0.2),
              0 2px 8px rgba(0,0,0,0.04),
              inset 0 1px 0 rgba(255,255,255,0.8);
}
.hcard-music::before {
  background: linear-gradient(145deg, rgba(255,233,133,0.3), rgba(122,184,245,0.15));
  box-shadow: 0 0 0 3px rgba(255,220,80,0.3);
}
.hcard-music:hover { box-shadow: 0 20px 56px rgba(255,215,80,0.35), 0 4px 16px rgba(0,0,0,0.06); }

/* ── Tips bubble (purple) ── */
.hcard-tips {
  background: linear-gradient(145deg, #faf8ff 0%, #ede9fe 60%, #fce4ec 100%);
  border: 1.5px solid rgba(182,154,247,0.45);
  box-shadow: 0 8px 32px rgba(182,154,247,0.25),
              0 2px 8px rgba(0,0,0,0.04),
              inset 0 1px 0 rgba(255,255,255,0.8);
}
.hcard-tips::before {
  background: linear-gradient(145deg, rgba(182,154,247,0.2), rgba(249,168,201,0.15));
  box-shadow: 0 0 0 3px rgba(182,154,247,0.35);
}
.hcard-tips:hover { box-shadow: 0 20px 56px rgba(182,154,247,0.4), 0 4px 16px rgba(0,0,0,0.06); }

/* ── AI highlight pulse ── */
.hcard.ai-highlight {
  animation: aihighlightPulse 2.2s ease-in-out infinite !important;
}
@keyframes aihighlightPulse {
  0%,100% { box-shadow: 0 8px 32px rgba(182,154,247,0.3), 0 0 0 0 rgba(182,154,247,0.4); }
  50%     { box-shadow: 0 16px 48px rgba(182,154,247,0.5), 0 0 0 10px rgba(182,154,247,0); }
}

/* ── Card Head ── */
.hcard-head {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 16px;
}
.hcard-head-icon {
  font-size: 1.8rem;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,0.1));
  flex-shrink: 0;
}
.hcard-head-title {
  font-family: var(--font-display);
  font-size: 1rem; font-weight: 800;
  color: #2d2542;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.hcard-head-sub {
  font-size: 0.7rem;
  color: #9580aa;
  font-weight: 500;
  margin-top: 1px;
}

/* ── Card Body ── */
.hcard-body {
  /* flexible content */
}

/* ── Story preview ── */
.hs-story-preview {
  font-size: 0.84rem;
  line-height: 1.75;
  color: #5c4d6e;
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* ── Breath mini ── */
.hcard-breath-mini-ring {
  font-size: 2.8rem;
  text-align: center;
  margin-bottom: 8px;
  animation: breathPulse 4s ease-in-out infinite;
  display: block;
}
@keyframes breathPulse {
  0%,100% { transform: scale(1);   opacity: 1; }
  50%     { transform: scale(1.18);opacity: 0.85; }
}
.hcard-breath-preview {
  font-size: 0.72rem;
  color: #4a9e7d;
  font-family: var(--font-mono);
  text-align: center;
  letter-spacing: 0.3px;
  margin-bottom: 14px;
}
.hcard-breath-start {
  width: 100%;
  background: linear-gradient(135deg, #6edcb0, #4db896);
  color: white;
  border: none;
  border-radius: 999px;
  padding: 9px 0;
  font-size: 0.78rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 14px rgba(110,220,176,0.45);
}
.hcard-breath-start:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(110,220,176,0.6);
}

/* ── Music mini track ── */
.hcard-music-tracks {
  display: flex; flex-direction: column; gap: 2px;
}
.hcard-music-track-mini {
  display: flex; align-items: center; gap: 8px;
  padding: 7px 10px;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s ease;
  position: relative;
}
.hcard-music-track-mini:hover {
  background: rgba(255,220,80,0.2);
}
.hcard-music-track-mini.playing {
  background: rgba(255,220,80,0.3);
}
.hcard-music-track-mini .tni { font-size: 1.1rem; flex-shrink: 0; }
.hcard-music-track-mini .tmn {
  font-size: 0.76rem; font-weight: 700;
  color: #4a3a00;
  flex: 1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.hcard-music-track-mini .tbp {
  font-size: 0.6rem; color: #9580aa;
  font-family: var(--font-mono);
  flex-shrink: 0;
}
.hcard-music-track-mini .tpl {
  font-size: 0.6rem; color: #f9a020;
  flex-shrink: 0;
}

/* ── Tips mini ── */
.hcard-tips-mini {
  display: flex; flex-direction: column; gap: 6px;
}
.hcard-tip-mini {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 8px;
  border-radius: 10px;
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(4px);
}
.hcard-tip-mini .tpi { font-size: 1rem; flex-shrink: 0; }
.hcard-tip-mini .tpt {
  font-size: 0.76rem; font-weight: 600;
  color: #4a3668;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ══════════════════════════════════════
   HORMONE BUBBLES ROW
══════════════════════════════════════ */
.hormone-section-label {
  text-align: center;
  font-size: 0.65rem;
  font-weight: 800;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: #b69af7;
  margin-bottom: 24px;
}

.hormone-row {
  display: flex; justify-content: center; gap: 28px;
  flex-wrap: wrap; max-width: 720px; margin: 0 auto;
  padding: 0 20px 8px;
}

.hormone-bubble {
  display: flex; flex-direction: column; align-items: center; gap: 7px;
  cursor: default;
  transition: transform 0.35s cubic-bezier(.34,1.56,.64,1);
  animation: hormoneFloat 5.5s ease-in-out infinite;
}
.hormone-bubble:nth-child(1){animation-delay:0s}
.hormone-bubble:nth-child(2){animation-delay:1.3s}
.hormone-bubble:nth-child(3){animation-delay:2.6s}
.hormone-bubble:nth-child(4){animation-delay:.65s}

@keyframes hormoneFloat{
  0%,100%{ transform:translateY(0) rotate(0deg); }
  33%    { transform:translateY(-9px) rotate(2deg); }
  66%    { transform:translateY(-4px) rotate(-1.5deg); }
}

.hormone-bubble:hover {
  transform: translateY(-14px) scale(1.15) !important;
  animation-play-state: paused !important;
}

.hormone-bubble.active .hormone-icon-wrap {
  box-shadow: 0 0 0 4px rgba(255,255,255,0.7),
              0 0 0 8px rgba(182,154,247,0.35),
              0 8px 24px rgba(0,0,0,0.12) !important;
  transform: scale(1.1);
}

.hormone-icon-wrap {
  width: 68px; height: 68px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
  box-shadow: 0 6px 20px rgba(0,0,0,.1), inset 0 2px 4px rgba(255,255,255,.7);
  transition: all .35s cubic-bezier(.34,1.56,.64,1);
  position: relative;
}

/* Gloss shine */
.hormone-icon-wrap::after {
  content: '';
  position: absolute;
  top: 8px; left: 12px;
  width: 28px; height: 12px;
  border-radius: 50%;
  background: rgba(255,255,255,0.55);
  transform: rotate(-20deg);
  pointer-events: none;
}

.h-dopamine  {
  background: radial-gradient(circle at 35% 35%, #ffe985, #f9a020);
}
.h-serotonin {
  background: radial-gradient(circle at 35% 35%, #93d0ff, #5ba8f5);
}
.h-oxytocin  {
  background: radial-gradient(circle at 35% 35%, #88edc0, #35c18e);
}
.h-endorphin {
  background: radial-gradient(circle at 35% 35%, #d0b4fe, #9b7af5);
}

.hormone-name {
  font-family: var(--font-display);
  font-size: .7rem; font-weight: 800;
  letter-spacing: .06em; text-transform: uppercase;
  color: #2d2542;
}
.hormone-action {
  font-size: .62rem; color: #9580aa;
  text-align: center; max-width: 76px; line-height: 1.45;
}

/* ══════════════════════════════════════
   NOW PLAYING PILL
══════════════════════════════════════ */
.hs-now-playing {
  position: fixed; bottom: 100px; right: 24px; z-index: 600;
  background: rgba(255,255,255,0.95);
  border: 1.5px solid rgba(249,168,201,0.5);
  border-radius: 999px; padding: 10px 18px;
  display: none; align-items: center; gap: 10px;
  box-shadow: 0 8px 32px rgba(249,168,201,0.3), 0 2px 8px rgba(0,0,0,0.06);
  min-width: 230px;
  backdrop-filter: blur(12px);
}
.hs-now-playing.show { display: flex; }
.hs-np-bars { display: flex; align-items: flex-end; gap: 2.5px; height: 18px; }
.hs-np-bar {
  width: 3px; border-radius: 2px;
  background: linear-gradient(to top, #f9a8c9, #b69af7);
  animation: npbar 0.8s ease-in-out infinite alternate;
}
.hs-np-bar:nth-child(2){animation-delay:0.15s}
.hs-np-bar:nth-child(3){animation-delay:0.3s}
.hs-np-bar:nth-child(4){animation-delay:0.45s}
.hs-np-bar:nth-child(5){animation-delay:0.6s}
@keyframes npbar { from{height:4px} to{height:16px} }
.hs-np-name { font-size: 0.8rem; font-weight: 700; color: #2d2542; flex: 1; }
.hs-np-sub { font-size: 0.68rem; color: #9580aa; }
.btn-np-stop {
  background: none; border: 1.5px solid rgba(249,168,201,0.6);
  border-radius: 999px; padding: 3px 11px;
  font-size: 0.7rem; color: #c37aa0; cursor: pointer;
  transition: all 0.15s;
}
.btn-np-stop:hover {
  background: linear-gradient(135deg, #f9a8c9, #b69af7);
  color: white; border-color: transparent;
}

/* ══════════════════════════════════════
   DETAIL PANEL (Modal)
══════════════════════════════════════ */
.hs-detail-panel {
  position: fixed; inset: 0; z-index: 9999;
  display: flex; align-items: center; justify-content: center;
  padding: 20px; pointer-events: none; opacity: 0;
  transition: opacity .3s ease;
}
.hs-detail-panel.open { pointer-events: all; opacity: 1; }
.hs-detail-backdrop {
  position: absolute; inset: 0;
  background: rgba(30,10,50,.4);
  backdrop-filter: blur(14px);
  cursor: pointer;
}
.hs-detail-modal {
  position: relative;
  background: rgba(255,253,255,.98);
  border-radius: 28px;
  max-width: 520px; width: 100%;
  max-height: 90vh; overflow-y: auto;
  box-shadow: 0 32px 80px rgba(182,154,247,0.3),
              0 8px 24px rgba(0,0,0,0.08);
  transform: scale(.88) translateY(24px);
  transition: transform .45s cubic-bezier(.34,1.56,.64,1), opacity .3s ease;
  opacity: 0;
  border: 1.5px solid rgba(249,168,201,0.3);
}
.hs-detail-panel.open .hs-detail-modal {
  transform: scale(1) translateY(0); opacity: 1;
}
.hs-detail-modal-head {
  padding: 22px 22px 16px;
  border-bottom: 1px solid rgba(182,154,247,0.2);
  display: flex; align-items: flex-start; gap: 12px;
  background: linear-gradient(135deg, rgba(252,228,236,0.3), rgba(237,233,254,0.3));
  border-radius: 28px 28px 0 0;
}
.hs-detail-modal-icon { font-size: 2.4rem; flex-shrink: 0; }
.hs-detail-modal-title {
  font-family: var(--font-display);
  font-size: 1.1rem; font-weight: 800;
  color: #2d2542; margin: 0 0 4px;
}
.hs-detail-modal-sub {
  font-size: .78rem; color: #b69af7; margin: 0;
  font-weight: 600;
}
.hs-detail-modal-close {
  margin-left: auto; width: 32px; height: 32px; border-radius: 50%;
  background: rgba(182,154,247,0.12);
  border: 1.5px solid rgba(182,154,247,0.3);
  cursor: pointer; font-size: 0.88rem;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s; flex-shrink: 0; color: #9580aa;
}
.hs-detail-modal-close:hover {
  background: linear-gradient(135deg, #f9a8c9, #b69af7);
  color: white; border-color: transparent;
}
.hs-detail-modal-body { padding: 18px 22px 24px; }
.hs-story-text {
  font-size: .9rem; line-height: 1.85; color: #3d2f50;
  border-left: 3px solid #b69af7;
  padding-left: 14px; margin-bottom: 14px;
}
.hs-story-text em { color: #c87ac0; font-style: normal; font-weight: 700; }
.hs-author {
  font-size: .7rem; color: #b69af7;
  display: flex; align-items: center; gap: 8px;
}
.hs-author::before {
  content: ''; display: block; flex: 1;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(182,154,247,0.4), transparent);
}
.hs-track-list { display: flex; flex-direction: column; gap: 6px; }
.hs-track {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 12px;
  border: 1.5px solid rgba(255,233,133,0.5);
  border-radius: var(--radius-sm);
  cursor: pointer;
  background: rgba(255,248,210,0.4);
  transition: all .2s ease;
}
.hs-track:hover {
  background: rgba(255,233,133,0.5);
  border-color: rgba(255,200,50,0.5);
  transform: translateX(4px);
}
.hs-track.playing {
  background: rgba(255,233,133,0.7);
  border-color: rgba(249,160,32,0.5);
}
.hs-track-num {
  width: 22px; height: 22px; border-radius: 50%;
  background: rgba(255,200,80,0.2);
  color: #9a7a00; font-size: .62rem; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-family: var(--font-mono);
}
.hs-track.playing .hs-track-num { background: #f9a020; color: #fff; }
.hs-track-emoji { font-size: 1.2rem; flex-shrink: 0; }
.hs-track-info { flex: 1; min-width: 0; }
.hs-track-name { font-size: .82rem; font-weight: 700; color: #2d2542; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.hs-track.playing .hs-track-name { color: #c28010; }
.hs-track-meta { font-size: .66rem; color: #9580aa; }
.hs-track-bpm { font-size: .68rem; font-weight: 700; color: #9580aa; flex-shrink: 0; font-family: var(--font-mono); }
.hs-play-icon { color: rgba(182,154,247,0.4); font-size: .8rem; flex-shrink: 0; transition: color .15s; }
.hs-track:hover .hs-play-icon, .hs-track.playing .hs-play-icon { color: #f9a020; }
.hs-mood-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.hs-mood-tag {
  font-size: .62rem; font-weight: 700; text-transform: uppercase; letter-spacing: .04em;
  padding: 3px 11px; border-radius: 50px;
  background: rgba(182,154,247,0.15);
  color: #9272e0; border: 1px solid rgba(182,154,247,0.35);
}
.hs-breath-layout { display: flex; gap: 20px; align-items: flex-start; }
.hs-breath-visual { display: flex; flex-direction: column; align-items: center; gap: 6px; flex-shrink: 0; }
.hs-breath-ring { position: relative; width: 80px; height: 80px; }
.hs-breath-circle {
  width: 100%; height: 100%; border-radius: 50%;
  background: radial-gradient(circle, rgba(110,220,176,0.15), rgba(110,220,176,0.05));
  border: 2px solid rgba(110,220,176,0.45);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem; transition: transform .3s ease;
}
.hs-breath-circle.inhale { animation: hsIn 4s ease-in-out forwards; }
.hs-breath-circle.hold   { transform: scale(1.35); }
.hs-breath-circle.exhale { animation: hsOut 6s ease-in-out forwards; }
@keyframes hsIn  { from{transform:scale(1)}    to{transform:scale(1.35)} }
@keyframes hsOut { from{transform:scale(1.35)} to{transform:scale(1)} }
.hs-breath-label { font-size: .76rem; font-weight: 700; color: #35c18e; text-align: center; }
.hs-breath-secs  { font-size: .66rem; color: #9580aa; text-align: center; min-height: 16px; font-family: var(--font-mono); }
.hs-breath-info  { flex: 1; }
.hs-phase-row    { display: flex; align-items: center; gap: 8px; font-size: .78rem; color: #3d2f50; margin-bottom: 5px; }
.hs-phase-dot    { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.hs-phase-dot.inhale-dot { background: #6edcb0; }
.hs-phase-dot.hold-dot   { background: #7ab8f5; }
.hs-phase-dot.exhale-dot { background: #b69af7; }
.hs-phase-dot.rest-dot   { background: #f9a8c9; }
.hs-breath-name  { font-family: var(--font-display); font-size: .92rem; font-weight: 800; color: #2d2542; margin-bottom: 4px; }
.hs-breath-desc  { font-size: .78rem; color: #9580aa; line-height: 1.6; margin-bottom: 10px; }
.hs-breath-phases{ margin-bottom: 14px; }
.btn-breath-start {
  background: linear-gradient(135deg, #6edcb0, #35c18e);
  color: white; border: none; border-radius: 999px;
  padding: 9px 22px; font-size: .8rem; font-weight: 700;
  cursor: pointer; transition: all .2s ease;
  box-shadow: 0 4px 14px rgba(110,220,176,0.45);
}
.btn-breath-start:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(110,220,176,0.6); }
.hs-tip { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(237,233,254,0.3); margin-bottom: 8px; }
.hs-tip-icon { font-size: 1.4rem; flex-shrink: 0; margin-top: 1px; }
.hs-tip-title { font-size: .84rem; font-weight: 700; color: #2d2542; margin-bottom: 2px; }
.hs-tip-desc  { font-size: .74rem; color: #9580aa; line-height: 1.55; }
.hs-tips      { display: flex; flex-direction: column; gap: 2px; }

/* ── Responsive ── */
@media (max-width: 640px) {
  .healing-grid { grid-template-columns: 1fr; gap: 16px; }
  .hcard { padding: 22px; border-radius: 22px; }
  .hormone-row { gap: 18px; }
  .hormone-icon-wrap { width: 56px; height: 56px; font-size: 1.5rem; }
}
@keyframes hsspin { to { transform: rotate(360deg); } }

/* ══════════════════════════════════════
   FOOTER
══════════════════════════════════════ */
footer {
  background: var(--bg-main) !important;
  border-top: 1px solid var(--border) !important;
  padding: 48px 0 28px !important;
  color: var(--text-main) !important;
}
footer .navbar-brand { font-family: var(--font-display) !important; font-weight: 800 !important; color: var(--primary) !important; font-size: 1.2rem !important; }
footer p { color: var(--text-sub) !important; font-size: 0.875rem !important; }
footer h6 { font-family: var(--font-display) !important; font-weight: 700 !important; color: var(--text-main) !important; font-size: 0.85rem !important; }
footer a { color: var(--text-sub) !important; text-decoration: none !important; font-size: 0.85rem !important; transition: color 0.15s !important; }
footer a:hover { color: var(--primary) !important; }
.footer-link:hover { color: var(--primary) !important; }
.footer-emergency {
  background: rgba(239,68,68,0.08);
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  margin-bottom: 10px;
}
.footer-fast {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
}
footer hr { border-color: var(--border) !important; opacity: 1 !important; }
footer .text-white-50 { color: var(--text-sub) !important; }
footer .text-white { color: var(--text-main) !important; }
footer .text-danger { color: #ef4444 !important; }
footer .badge.bg-danger { background: rgba(239,68,68,0.15) !important; color: #dc2626 !important; }

/* ══════════════════════════════════════
   BUTTONS GLOBAL
══════════════════════════════════════ */
.btn-primary, .btn-danger {
  background: var(--primary) !important;
  border-color: var(--primary) !important;
  color: #fff !important;
  border-radius: 999px !important;
  font-family: var(--font-body) !important;
  font-weight: 600 !important;
}
.btn-primary:hover, .btn-danger:hover {
  background: var(--primary-dark) !important;
  border-color: var(--primary-dark) !important;
}
.btn-outline-primary, .btn-outline-danger {
  color: var(--primary) !important;
  border-color: var(--primary) !important;
  border-radius: 999px !important;
}
.btn-outline-primary:hover, .btn-outline-danger:hover {
  background: var(--primary) !important; color: #fff !important;
}
.btn-success { background: #0ea56b !important; border-color: #0ea56b !important; border-radius: 999px !important; }
.btn-success:hover { background: #0c8f5d !important; border-color: #0c8f5d !important; }
.btn-secondary { background: var(--bg-main) !important; border-color: var(--border) !important; color: var(--text-sub) !important; border-radius: 999px !important; }

/* Nav pills/tabs */
.nav-pills .nav-link.active, .nav-tabs .nav-link.active { background: var(--primary) !important; border-color: var(--primary) !important; color: #fff !important; }
.nav-pills .nav-link, .nav-tabs .nav-link { color: var(--text-sub) !important; }

/* Badges */
.badge.bg-danger, .badge.bg-primary { background: var(--primary) !important; }
.badge.bg-success { background: #0ea56b !important; }
.badge.bg-warning { background: #f59e0b !important; color: #1a1a1a !important; }

/* Progress bars */
.progress-bar { background-color: var(--primary) !important; }

/* Alerts */
.alert-info { background: rgba(10,104,255,0.06) !important; border-color: rgba(10,104,255,0.2) !important; color: var(--primary-dark) !important; }

/* Forms */
.form-control:focus, .form-select:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(10,104,255,0.12) !important; }
input.form-control, textarea.form-control { font-family: var(--font-body) !important; font-size: 0.875rem !important; }

/* Tables */
.table { border-color: var(--border) !important; }
.table thead th { background: var(--bg-main) !important; color: var(--text-main) !important; border-color: var(--border) !important; font-family: var(--font-display) !important; font-weight: 700 !important; }

/* Modals */
.modal-header { border-bottom-color: var(--border) !important; }
.modal-footer { border-top-color: var(--border) !important; }
.modal-content { border-radius: var(--radius-lg) !important; border-color: var(--border) !important; }
.modal-title { font-family: var(--font-display) !important; font-weight: 700 !important; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-main); }
::-webkit-scrollbar-thumb { background: rgba(10,104,255,0.25); border-radius: 6px; }
::-webkit-scrollbar-thumb:hover { background: var(--primary); }

/* Dropdown */
.dropdown-divider { border-color: var(--border) !important; }

/* Main content cards */
.card {
  background: var(--card-bg) !important;
  border: 1px solid var(--border) !important;
  border-radius: var(--radius-md) !important;
  box-shadow: var(--shadow-sm) !important;
}
.card:hover { box-shadow: var(--shadow-md) !important; }

/* Article section */
article { border-bottom-color: var(--border) !important; }
.text-muted { color: var(--text-sub) !important; }
a { color: var(--primary); }
a:hover { color: var(--primary-dark); }
hr { border-color: var(--border) !important; opacity: 1; }

/* ── SCROLL FADE IN ── */
.fade-in-up {
  opacity: 0; transform: translateY(24px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}
.fade-in-up.visible { opacity: 1; transform: translateY(0); }
.fade-in-up:nth-child(2) { transition-delay: 0.1s; }
.fade-in-up:nth-child(3) { transition-delay: 0.2s; }
.fade-in-up:nth-child(4) { transition-delay: 0.3s; }

/* ── RESPONSIVE ── */
@media (max-width: 991px) {
  .header-banner { padding: 60px 0 40px; min-height: auto; }
  .hero-h1 { font-size: 2rem !important; }
  .hero-right { margin-top: 36px; }
}
@media (max-width: 767px) {
  .hero-cta-group { flex-direction: column; }
  .btn-hero-primary, .btn-hero-secondary { width: 100%; justify-content: center; }
  .hero-stats { gap: 20px; }
  .nkai-row2 { grid-template-columns: 1fr; }
  .ha-f2 { grid-template-columns: 1fr; }
  .ha-2col { grid-template-columns: 1fr; }
  .dash-metric-row { grid-template-columns: 1fr 1fr; }
  .ai-box { padding: 28px 24px; gap: 20px; }
}

/* Remove old nature scene elements if present */
.hn-ground, .hn-tree, .hn-butterfly, .hn-animal, .hn-leaf,
.hero-sticker { display: none !important; }

/* ── Smooth color transitions for theme switching ── */
.navbar,
.clean-card,
.sidebar-card,
.dash-preview-card,
.dropdown-menu,
.nkai-card,
.hero-illus-card,
.hero-float-card,
.modal-content,
.header-banner {
  transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease !important;
}
a, button, input, .btn, .nav-link, .dropdown-item,
.section-tag, .hero-badge, .nkai-ai-badge,
.lang-btn, .lang-btn.active,
.btn-hero-primary, .btn-hero-secondary,
.hv-val.blue, .dm-val.blue, .das-dot, .das-head,
.dhb-bar, .feature-icon-wrap, .nkai-yt-btn,
.nkai-video-search input:focus, .nkai-inp:focus {
  transition: background-color 0.4s ease, border-color 0.4s ease, color 0.4s ease, box-shadow 0.4s ease !important;
}
</style>

<style id="lang-toggle-css">
/* Language Toggle */
.lang-toggle-wrap { display:flex; align-items:center; gap:4px; flex-shrink:0; }
.lang-btn {
  background: transparent;
  border: 1.5px solid var(--border);
  border-radius: 999px;
  padding: 4px 12px;
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--text-sub);
  cursor: pointer;
  transition: all 0.18s ease;
  white-space: nowrap;
}
.lang-btn:hover { background: rgba(10,104,255,0.07); border-color: var(--primary); color: var(--primary); }
.lang-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(10,104,255,0.28); }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top border-bottom">
    <div class="container">
        <a class="navbar-brand" href="#">HealthAI <span>Pro</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav mx-auto gap-1">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#section-benh-cap-cuu" role="button" data-bs-toggle="dropdown">Bệnh Cấp Cứu</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#section-benh-cap-cuu">Tổng quan các bệnh</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#section-benh-cap-cuu">🧠 Đột quỵ / Nhồi máu não</a></li>
                        <li><a class="dropdown-item" href="#section-benh-cap-cuu">❤️ Nhồi máu cơ tim</a></li>
                        <li><a class="dropdown-item" href="#section-benh-cap-cuu">🩸 Huyết áp cao / thấp</a></li>
                        <li><a class="dropdown-item" href="#section-benh-cap-cuu">🫁 Ngưng thở / Choking</a></li>
                        <li><a class="dropdown-item" href="#section-benh-cap-cuu">⚡ Sốc (Shock)</a></li>
                        <li><a class="dropdown-item" href="#section-benh-cap-cuu">🩹 Chảy máu nặng</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#section-so-cuu" role="button" data-bs-toggle="dropdown">Hướng Dẫn Sơ Cứu</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#section-so-cuu">Tổng quan sơ cứu</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#section-so-cuu">🫀 CPR / Hồi sức tim phổi</a></li>
                        <li><a class="dropdown-item" href="#section-so-cuu">🤲 Nghiệm pháp Heimlich</a></li>
                        <li><a class="dropdown-item" href="#section-so-cuu">🦴 Sơ cứu gãy xương</a></li>
                        <li><a class="dropdown-item" href="#section-so-cuu">🩺 Những việc nên làm hằng ngày</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#section-video" role="button" data-bs-toggle="dropdown">Video</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#section-video">Tìm kiếm video</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item video-quick" data-q="đột quỵ" href="#section-video">▶ Xử lý đột quỵ</a></li>
                        <li><a class="dropdown-item video-quick" data-q="ngưng tim" href="#section-video">▶ Xử lý ngưng tim</a></li>
                        <li><a class="dropdown-item video-quick" data-q="chảy máu" href="#section-video">▶ Xử lý chảy máu</a></li>
                        <li><a class="dropdown-item video-quick" data-q="gãy xương" href="#section-video">▶ Sơ cứu gãy xương</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#section-giam-sat" role="button" data-bs-toggle="dropdown">Giám Sát Sức Khỏe</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#section-giam-sat">Trực tiếp (Live)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#section-giam-sat">💓 Nhịp tim</a></li>
                        <li><a class="dropdown-item" href="#section-giam-sat">🩸 SpO₂ (Oxy máu)</a></li>
                        <li><a class="dropdown-item" href="#section-giam-sat">🌡️ Nhiệt độ cơ thể</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#section-giam-sat">📊 Kiểm tra tình trạng</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#section-tu-van-ai">Tư Vấn AI</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#section-healing" style="color:var(--primary);font-weight:700;">🌿 Chữa Lành</a>
                </li>
            </ul>
            <span class="text-muted small ms-auto d-none d-lg-inline" id="navDateTxt"></span>
        </div>
        <!-- Language Toggle -->
        <div class="lang-toggle-wrap ms-3" id="langToggleWrap">
          <button class="lang-btn active" id="langBtnVN" onclick="changeLanguage('vi')" title="Tiếng Việt">🇻🇳 VN</button>
          <button class="lang-btn" id="langBtnEN" onclick="changeLanguage('en')" title="English">🇺🇸 EN</button>
        </div>
</nav>

<!-- HERO SECTION -->
<div class="header-banner">
  <div class="hero-blob-2"></div>
  <div class="container" style="position:relative;z-index:2;">
    <div class="row align-items-center">
      <!-- Left -->
      <div class="col-lg-6 hero-left">
        <div class="hero-badge">⊕ AI-Powered Healthcare Platform</div>
        <h1 class="hero-h1">Hệ Thống Giám Sát &amp;<br><span class="accent">Phân Tích Sức Khỏe</span><br>Thông Minh</h1>
        <p class="hero-desc">Giám sát thời gian thực từ IoT · Tư vấn AI 24/7 · Phòng chống đột quỵ &amp; bệnh cấp cứu hiệu quả.</p>
        <div class="hero-cta-group">
          <a href="#section-tu-van-ai" class="btn-hero-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            Phân Tích Ngay
          </a>
          <a href="#section-giam-sat" class="btn-hero-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="2"/><path d="M12 2v2m0 16v2M2 12h2m16 0h2"/><path d="M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/></svg>
            Trải Nghiệm AI
          </a>
        </div>
        <div class="hero-stats">
          <div class="hero-stat-item">
            <span class="hero-stat-num">24/7</span>
            <span class="hero-stat-lbl">AI Hỗ Trợ</span>
          </div>
          <div class="hero-stat-item">
            <span class="hero-stat-num">7</span>
            <span class="hero-stat-lbl">Bước Phân Tích</span>
          </div>
          <div class="hero-stat-item">
            <span class="hero-stat-num">IoT</span>
            <span class="hero-stat-lbl">Live Monitor</span>
          </div>
        </div>
      </div>

      <!-- Right: Dashboard Illustration -->
      <div class="col-lg-6 hero-right mt-4 mt-lg-0">
        <div class="hero-illus-card">
          <div class="hero-monitor-bar">
            <div class="hm-dot red"></div>
            <div class="hm-dot yellow"></div>
            <div class="hm-dot green"></div>
            <span class="hm-title">HealthAI Pro — Live Dashboard</span>
          </div>
          <div class="hero-vitals-grid">
            <div class="hv-item">
              <div class="hv-val" id="heroHeartVal">72</div>
              <div class="hv-lbl">Nhịp Tim</div>
            </div>
            <div class="hv-item">
              <div class="hv-val blue" id="heroSpoVal">98</div>
              <div class="hv-lbl">SpO₂ %</div>
            </div>
            <div class="hv-item">
              <div class="hv-val green" id="heroTmpVal">36.6</div>
              <div class="hv-lbl">Nhiệt Độ</div>
            </div>
          </div>
          <!-- SVG ECG Chart -->
          <div class="hero-chart-mock">
            <svg viewBox="0 0 400 90" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="ecgGrad" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="rgba(10,104,255,0.15)"/>
                  <stop offset="100%" stop-color="rgba(10,104,255,0)"/>
                </linearGradient>
              </defs>
              <path d="M0,50 L40,50 L50,50 L55,20 L62,80 L68,10 L75,75 L82,50 L120,50 L130,50 L135,20 L142,80 L148,10 L155,75 L162,50 L200,50 L210,50 L215,20 L222,80 L228,10 L235,75 L242,50 L280,50 L290,50 L295,20 L302,80 L308,10 L315,75 L322,50 L400,50" fill="none" stroke="var(--primary)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M0,50 L40,50 L50,50 L55,20 L62,80 L68,10 L75,75 L82,50 L120,50 L130,50 L135,20 L142,80 L148,10 L155,75 L162,50 L200,50 L210,50 L215,20 L222,80 L228,10 L235,75 L242,50 L280,50 L290,50 L295,20 L302,80 L308,10 L315,75 L322,50 L400,50 L400,90 L0,90 Z" fill="url(#ecgGrad)"/>
            </svg>
          </div>
          <div class="hero-status-row">
            <div class="h-status-dot"></div>
            <span class="h-status-txt">Trạng thái: Bình thường · ESP32 kết nối</span>
          </div>
        </div>
        <!-- Floating badge cards -->
        <div class="hero-float-card" style="top:-18px;right:20px;">
          <div class="hfc-icon">🤖</div>
          <div class="hfc-txt">AI Phân Tích</div>
          <div class="hfc-sub">Claude AI Engine</div>
        </div>
        <div class="hero-float-card" style="bottom:20px;left:-20px;">
          <div class="hfc-icon">🩺</div>
          <div class="hfc-txt">Dr. AI 24/7</div>
          <div class="hfc-sub">Hỗ trợ tức thì</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FEATURE SECTION -->
<section class="features-section py-5">
  <div class="container">
    <div class="text-center mb-5">
      <div class="section-tag">Tính Năng</div>
      <h2 class="section-title">Toàn Bộ Sức Khỏe Trong Một Nền Tảng</h2>
      <p class="section-desc mx-auto">Từ giám sát IoT thời gian thực đến AI tư vấn thông minh, tất cả được thiết kế để bảo vệ sức khỏe bạn.</p>
    </div>
    <div class="row g-4">
      <div class="col-md-6 col-lg-3 fade-in-up">
        <div class="clean-card h-100">
          <div class="feature-icon-wrap">
            <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </div>
          <div class="feature-title">Giám Sát IoT Trực Tiếp</div>
          <p class="feature-desc">Theo dõi nhịp tim, SpO₂ và nhiệt độ cơ thể realtime từ thiết bị ESP32 qua Firebase.</p>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 fade-in-up">
        <div class="clean-card h-100">
          <div class="feature-icon-wrap">
            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div class="feature-title">Bác Sĩ AI 24/7</div>
          <p class="feature-desc">Chat thông minh với AI hỗ trợ ảnh, giọng nói. Phân tích triệu chứng và tư vấn tức thì.</p>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 fade-in-up">
        <div class="clean-card h-100">
          <div class="feature-icon-wrap">
            <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          </div>
          <div class="feature-title">Phân Tích AI 7 Bước</div>
          <p class="feature-desc">Nhập chỉ số sinh lý, AI đánh giá toàn diện qua 7 bước lâm sàng chính xác và khoa học.</p>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 fade-in-up">
        <div class="clean-card h-100">
          <div class="feature-icon-wrap">
            <svg viewBox="0 0 24 24"><path d="M4.5 6.375a4.125 4.125 0 1 0 8.25 0 4.125 4.125 0 0 0-8.25 0ZM14.25 8.625a3.375 3.375 0 1 0 6.75 0 3.375 3.375 0 0 0-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.233.96 10.088 10.088 0 0 0 5.06-1.01.75.75 0 0 0 .42-.643 4.875 4.875 0 0 0-6.957-4.611 8.586 8.586 0 0 1 1.71 5.157v.003Z" fill="currentColor" stroke="none"/></svg>
          </div>
          <div class="feature-title">Chữa Lành &amp; Thư Giãn</div>
          <p class="feature-desc">Nội dung cá nhân hoá — nhạc chữa lành, hít thở, hormone hạnh phúc theo chỉ số sức khỏe.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- DASHBOARD PREVIEW SECTION -->
<section class="dashboard-preview-section py-5">
  <div class="container">
    <div class="row align-items-center g-5">
      <div class="col-lg-5">
        <div class="section-tag">Dashboard</div>
        <h2 class="section-title">Giao Diện Rõ Ràng,<br>Dữ Liệu Tức Thì</h2>
        <p class="section-desc" style="margin-bottom:1.5rem;">Mọi chỉ số sức khỏe của bạn được hiển thị trực quan, dễ đọc như phần mềm SaaS chuyên nghiệp.</p>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:36px;height:36px;background:rgba(10,104,255,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div>
              <div style="font-size:0.85rem;font-weight:700;color:var(--text-main);font-family:var(--font-display);">Cập Nhật Thời Gian Thực</div>
              <div style="font-size:0.78rem;color:var(--text-sub);">Dữ liệu từ ESP32 qua Firebase Realtime DB</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:36px;height:36px;background:rgba(14,165,107,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0ea56b" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <div>
              <div style="font-size:0.85rem;font-weight:700;color:var(--text-main);font-family:var(--font-display);">Cảnh Báo Thông Minh</div>
              <div style="font-size:0.78rem;color:var(--text-sub);">Phát hiện tự động khi chỉ số vượt ngưỡng</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:36px;height:36px;background:rgba(245,158,11,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
            </div>
            <div>
              <div style="font-size:0.85rem;font-weight:700;color:var(--text-main);font-family:var(--font-display);">Phân Tích Xu Hướng</div>
              <div style="font-size:0.78rem;color:var(--text-sub);">Biểu đồ lịch sử và dự đoán sức khỏe</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-7">
        <div class="dash-preview-card">
          <div class="dash-topbar">
            <div class="dash-dots">
              <div class="dash-dot r"></div>
              <div class="dash-dot y"></div>
              <div class="dash-dot g"></div>
            </div>
            <span class="dash-topbar-title">HealthAI Pro — Monitoring Panel</span>
          </div>
          <div class="dash-body">
            <div>
              <div class="dash-metric-row">
                <div class="dash-metric">
                  <div class="dm-val">72</div>
                  <div class="dm-lbl">BPM</div>
                  <div class="dm-trend">↑ Bình thường</div>
                </div>
                <div class="dash-metric">
                  <div class="dm-val blue">98%</div>
                  <div class="dm-lbl">SpO₂</div>
                  <div class="dm-trend">✓ Tốt</div>
                </div>
                <div class="dash-metric">
                  <div class="dm-val green">36.6°</div>
                  <div class="dm-lbl">Nhiệt Độ</div>
                  <div class="dm-trend">✓ Bình thường</div>
                </div>
              </div>
              <div class="dash-chart-area">
                <svg viewBox="0 0 600 120" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="dashGrad" x1="0" x2="0" y1="0" y2="1">
                      <stop offset="0%" stop-color="rgba(10,104,255,0.18)"/>
                      <stop offset="100%" stop-color="rgba(10,104,255,0)"/>
                    </linearGradient>
                  </defs>
                  <path d="M0,70 L60,70 L75,30 L90,90 L100,15 L112,100 L124,70 L180,70 L195,30 L210,90 L220,15 L232,100 L244,70 L300,70 L315,30 L330,90 L340,15 L352,100 L364,70 L420,70 L435,30 L450,90 L460,15 L472,100 L484,70 L540,70 L555,30 L570,90 L580,15 L592,100 L600,70" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"/>
                  <path d="M0,70 L60,70 L75,30 L90,90 L100,15 L112,100 L124,70 L180,70 L195,30 L210,90 L220,15 L232,100 L244,70 L300,70 L315,30 L330,90 L340,15 L352,100 L364,70 L420,70 L435,30 L450,90 L460,15 L472,100 L484,70 L540,70 L555,30 L570,90 L580,15 L592,100 L600,70 L600,120 L0,120 Z" fill="url(#dashGrad)"/>
                </svg>
              </div>
            </div>
            <div class="dash-right">
              <div class="dash-health-bar-card">
                <div class="dhb-title">Chỉ số sức khỏe</div>
                <div class="dhb-row">
                  <div class="dhb-label"><span>Nhịp tim</span><span style="color:var(--text-main);font-weight:700;">72 BPM</span></div>
                  <div class="dhb-bar-wrap"><div class="dhb-bar" style="width:65%"></div></div>
                </div>
                <div class="dhb-row">
                  <div class="dhb-label"><span>SpO₂</span><span style="color:var(--text-main);font-weight:700;">98%</span></div>
                  <div class="dhb-bar-wrap"><div class="dhb-bar green" style="width:92%"></div></div>
                </div>
                <div class="dhb-row">
                  <div class="dhb-label"><span>Nhiệt độ</span><span style="color:var(--text-main);font-weight:700;">36.6°C</span></div>
                  <div class="dhb-bar-wrap"><div class="dhb-bar yellow" style="width:58%"></div></div>
                </div>
              </div>
              <div class="dash-ai-status">
                <div class="das-head"><div class="das-dot"></div>AI Engine</div>
                <div class="das-item"><span class="das-ok">✓</span>Tất cả bình thường</div>
                <div class="das-item"><span class="das-ok">✓</span>Kết nối ESP32 live</div>
                <div class="das-item"><span>🤖</span>Claude AI sẵn sàng</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- AI HIGHLIGHT SECTION -->
<section class="ai-highlight-section py-5">
  <div class="container">
    <div class="ai-box">
      <div class="ai-box-icon">🤖</div>
      <div class="ai-box-content">
        <h3 class="ai-box-title">Tư Vấn AI 7 Bước Lâm Sàng</h3>
        <p class="ai-box-desc">Nhập chỉ số nhịp tim, SpO₂, nhiệt độ và triệu chứng — AI phân tích toàn diện qua 7 bước khoa học. Được hỗ trợ bởi Claude AI (Anthropic). Không thay thế chẩn đoán y tế chuyên nghiệp.</p>
      </div>
      <div class="ai-box-cta">
        <a href="#section-tu-van-ai" class="btn-hero-primary">Phân Tích Ngay →</a>
      </div>
    </div>
  </div>
</section>

<!-- MAIN CONTENT -->
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            <article class="border-bottom pb-4 mb-4" id="section-so-cuu">
                <div class="text-muted small mb-2">Cập nhật 04/12/2025</div>
                <h3 style="font-family:var(--font-display);font-weight:800;">Hệ thống giám sát sức khỏe và xử trí khẩn cấp</h3>
                <p class="lead">Trang này cung cấp thông tin về các bệnh cấp cứu phổ biến như <strong>đột quỵ, nhồi máu não, huyết áp cao, sốc, ngưng thở</strong> và các tình huống khẩn cấp khác. Gọi ngay <strong>115</strong> khi có dấu hiệu cảnh báo!</p>
            </article>

            <div class="border-bottom pb-4 mb-4" id="section-video">
                <h3>Bài viết &amp; Hướng dẫn sơ cứu</h3>
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="row g-0 align-items-center">
                                <div class="col-md-4">
                                    <img src="https://tse3.mm.bing.net/th/id/OIP.p0_gk4FHrJC0Utcwhj-RhAHaCY?cb=ucfimg2&ucfimg=1&rs=1&pid=ImgDetMain&o=7&rm=3" class="img-fluid rounded-start" alt="WHO">
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <h5 class="card-title">Trang chính thức của tổ chức Y tế Thế Giới</h5>
                                        <p class="card-text">WHO (World Health Organization) cung cấp thông tin y tế tin cậy, hướng dẫn xử trí và cập nhật chuyên môn.</p>
                                        <a href="https://www.who.int/" target="_blank" class="btn btn-sm btn-primary">Chuyển đến (WHO)</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Video hướng dẫn (Tìm theo từ khóa)</h5>
                                <p class="card-text">Nhập từ khóa (ví dụ: đột quỵ, CPR, ngưng tim) hoặc chọn một video gợi ý bên dưới.</p>
                                <div class="input-group">
                                    <input id="videoQuery" class="form-control form-control-sm" placeholder="Nhập từ khóa hoặc dán link YouTube...">
                                    <button id="findVideoBtn" class="btn btn-sm btn-danger">Tìm</button>
                                </div>
                                <div id="videoArea" class="mt-3 d-none">
                                    <div id="videoLinkResult" style="background:var(--bg-main);border:1.5px solid var(--border);border-radius:12px;padding:16px;text-align:center;">
                                      <div style="font-size:32px;margin-bottom:8px;">▶️</div>
                                      <div id="videoLinkTitle" style="font-size:13px;font-weight:700;color:var(--text-main);margin-bottom:8px;"></div>
                                      <a id="videoLinkAnchor" href="#" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:6px;background:var(--primary);color:#fff;padding:8px 20px;border-radius:8px;text-decoration:none;font-size:13px;font-weight:700;">
                                        ▶ Xem trên YouTube
                                      </a>
                                    </div>
                                </div>
                                <div id="videoSlider" class="mt-3">
                                    <div style="display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;">
                                        <a class="yt-card" href="https://www.youtube.com/watch?v=SKs8EKh_3SQ" target="_blank" rel="noopener noreferrer"><div class="yt-thumb-wrap"><img src="https://i.ytimg.com/vi/SKs8EKh_3SQ/mqdefault.jpg" alt="Đột quỵ"><div class="yt-play-overlay"><div class="yt-play-icon">&#9654;</div></div></div><div class="yt-card-body"><div class="yt-card-title">Xử lý đột quỵ</div><div class="yt-card-link">▶ Xem trên YouTube</div></div></a>
                                        <a class="yt-card" href="https://www.youtube.com/watch?v=inkRQZPO51Y" target="_blank" rel="noopener noreferrer"><div class="yt-thumb-wrap"><img src="https://i.ytimg.com/vi/inkRQZPO51Y/mqdefault.jpg" alt="Ngưng tim"><div class="yt-play-overlay"><div class="yt-play-icon">&#9654;</div></div></div><div class="yt-card-body"><div class="yt-card-title">Xử lý ngưng tim</div><div class="yt-card-link">▶ Xem trên YouTube</div></div></a>
                                        <a class="yt-card" href="https://www.youtube.com/watch?v=ueGVsVE5ZLk" target="_blank" rel="noopener noreferrer"><div class="yt-thumb-wrap"><img src="https://i.ytimg.com/vi/ueGVsVE5ZLk/mqdefault.jpg" alt="Chảy máu"><div class="yt-play-overlay"><div class="yt-play-icon">&#9654;</div></div></div><div class="yt-card-body"><div class="yt-card-title">Xử lý chảy máu nhiều</div><div class="yt-card-link">▶ Xem trên YouTube</div></div></a>
                                        <a class="yt-card" href="https://www.youtube.com/watch?v=Ei1UsHqtUvo" target="_blank" rel="noopener noreferrer"><div class="yt-thumb-wrap"><img src="https://i.ytimg.com/vi/Ei1UsHqtUvo/mqdefault.jpg" alt="Ngưng thở"><div class="yt-play-overlay"><div class="yt-play-icon">&#9654;</div></div></div><div class="yt-card-body"><div class="yt-card-title">Ngưng thở / Hô hấp khẩn cấp</div><div class="yt-card-link">▶ Xem trên YouTube</div></div></a>
                                        <a class="yt-card" href="https://www.youtube.com/watch?v=zWHyVGUHX7U" target="_blank" rel="noopener noreferrer"><div class="yt-thumb-wrap"><img src="https://i.ytimg.com/vi/zWHyVGUHX7U/mqdefault.jpg" alt="Choking"><div class="yt-play-overlay"><div class="yt-play-icon">&#9654;</div></div></div><div class="yt-card-body"><div class="yt-card-title">Nghẹn / Choking</div><div class="yt-card-link">▶ Xem trên YouTube</div></div></a>
                                        <a class="yt-card" href="https://www.youtube.com/watch?v=nsZkiTZPVM4" target="_blank" rel="noopener noreferrer"><div class="yt-thumb-wrap"><img src="https://i.ytimg.com/vi/nsZkiTZPVM4/mqdefault.jpg" alt="Gãy xương"><div class="yt-play-overlay"><div class="yt-play-icon">&#9654;</div></div></div><div class="yt-card-body"><div class="yt-card-title">Sơ cứu gãy xương</div><div class="yt-card-link">▶ Xem trên YouTube</div></div></a>
                                        <a class="yt-card" href="https://www.youtube.com/watch?v=NQrnzq8jcHQ" target="_blank" rel="noopener noreferrer"><div class="yt-thumb-wrap"><img src="https://i.ytimg.com/vi/NQrnzq8jcHQ/mqdefault.jpg" alt="Huyết áp"><div class="yt-play-overlay"><div class="yt-play-icon">&#9654;</div></div></div><div class="yt-card-body"><div class="yt-card-title">Xử lý tụt huyết áp</div><div class="yt-card-link">▶ Xem trên YouTube</div></div></a>
                                    </div>
                                    <div class="text-muted small mt-2">Bấm vào card để xem video trực tiếp trên YouTube. Bạn cũng có thể dán link YouTube vào ô tìm kiếm.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- PIN BOARD SECTION -->
            <style>
              /* ── PIN BOARD WRAPPER ── */
              .pinboard-section {
                position: relative;
                background:
                  linear-gradient(#e8e0d4 1px, transparent 1px),
                  linear-gradient(90deg, #e8e0d4 1px, transparent 1px),
                  linear-gradient(135deg, #fdf8f0 0%, #fef5f8 50%, #f4fdf8 100%);
                background-size: 32px 32px, 32px 32px, 100% 100%;
                border-radius: 24px;
                padding: 40px 28px 48px;
                margin: 32px 0 40px;
                box-shadow:
                  inset 0 2px 12px rgba(0,0,0,0.04),
                  0 4px 24px rgba(0,0,0,0.06);
              }
              .pinboard-label {
                font-family: 'Plus Jakarta Sans', sans-serif;
                font-size: 0.65rem;
                font-weight: 700;
                letter-spacing: 2px;
                text-transform: uppercase;
                color: #9b8c7a;
                margin-bottom: 24px;
                display: flex;
                align-items: center;
                gap: 10px;
              }
              .pinboard-label::before,
              .pinboard-label::after {
                content: '';
                flex: 1;
                height: 1px;
                background: linear-gradient(90deg, transparent, #d4c4b0, transparent);
              }

              /* ── NOTE CARD ── */
              .note-card {
                position: relative;
                border-radius: 4px 16px 16px 4px;
                padding: 28px 24px 24px;
                margin-bottom: 28px;
                box-shadow:
                  0 2px 8px rgba(0,0,0,0.08),
                  0 8px 32px rgba(0,0,0,0.10),
                  0 1px 0 rgba(255,255,255,0.8) inset;
                transform-origin: center top;
                will-change: transform;
                cursor: default;
                overflow: visible;
                transition: transform 0.35s cubic-bezier(.34,1.56,.64,1),
                            box-shadow 0.35s ease;
              }
              /* Torn paper left edge */
              .note-card::before {
                content: '';
                position: absolute;
                left: 0; top: 0; bottom: 0;
                width: 10px;
                background: inherit;
                filter: brightness(0.93);
                border-radius: 4px 0 0 4px;
              }
              /* Paper texture overlay */
              .note-card::after {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: inherit;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
                pointer-events: none;
                opacity: 0.5;
              }
              .note-card:hover {
                transform: translateY(-8px) rotate(0deg) !important;
                box-shadow:
                  0 6px 24px rgba(0,0,0,0.12),
                  0 20px 56px rgba(0,0,0,0.14),
                  0 1px 0 rgba(255,255,255,0.8) inset;
              }
              .note-card:hover .note-pin {
                filter: drop-shadow(0 4px 8px rgba(200,30,30,0.5));
              }

              /* Note color variants */
              .note-cream  { background: linear-gradient(145deg, #fefcf5, #fdf7e4); }
              .note-pink   { background: linear-gradient(145deg, #fff5f8, #fce8f0); }
              .note-mint   { background: linear-gradient(145deg, #f2fdf8, #e6f9f0); }
              .note-yellow { background: linear-gradient(145deg, #fffdf0, #fef9d5); }

              /* Subtle rotation per note */
              .note-card:nth-child(1) { transform: rotate(-1.2deg); }
              .note-card:nth-child(2) { transform: rotate(0.8deg); }
              .note-card:nth-child(3) { transform: rotate(-0.5deg); }

              /* ── 3D PIN ── */
              .note-pin {
                position: absolute;
                top: -14px;
                left: 50%;
                transform: translateX(-50%);
                width: 22px;
                height: 22px;
                z-index: 10;
                transition: filter 0.3s;
                filter: drop-shadow(0 2px 4px rgba(180,20,20,0.35));
              }
              .note-pin svg {
                width: 100%;
                height: 100%;
              }

              /* Note title */
              .note-title {
                font-family: 'Plus Jakarta Sans', sans-serif;
                font-size: 0.95rem;
                font-weight: 800;
                letter-spacing: -0.2px;
                margin: 0 0 14px;
                padding-bottom: 10px;
                border-bottom: 1.5px dashed rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 8px;
              }
              .note-cream  .note-title { color: #5c4a1e; }
              .note-pink   .note-title { color: #7a2845; }
              .note-mint   .note-title { color: #1a5c42; }
              .note-yellow .note-title { color: #4a3c0a; }

              .note-title-icon {
                font-size: 1.2rem;
              }

              /* Note content */
              .note-body {
                font-size: 0.855rem;
                line-height: 1.72;
                color: #3a3228;
              }
              .note-cream  .note-body { color: #4a3c28; }
              .note-pink   .note-body { color: #4a2838; }
              .note-mint   .note-body { color: #1e3d30; }
              .note-yellow .note-body { color: #3c3010; }

              /* Note list items */
              .note-list {
                list-style: none;
                padding: 0;
                margin: 0;
              }
              .note-list li {
                padding: 7px 0 7px 20px;
                position: relative;
                border-bottom: 1px dashed rgba(0,0,0,0.08);
                font-size: 0.84rem;
                line-height: 1.55;
              }
              .note-list li:last-child { border-bottom: none; }
              .note-list li::before {
                content: '✏️';
                position: absolute;
                left: 0;
                font-size: 0.7rem;
                top: 8px;
              }
              .note-list li strong {
                display: block;
                font-weight: 700;
                margin-bottom: 1px;
              }
              .note-cream  .note-list li strong { color: #7a5c1e; }
              .note-pink   .note-list li strong { color: #a0365a; }
              .note-mint   .note-list li strong { color: #1a6b4a; }

              .note-daily-list li::before { content: '✔'; font-size: 0.8rem; color: #2ea06a; top: 7px; }
              .note-daily-list li strong { color: #1a5c42; }

              /* Info tip box */
              .note-tip {
                background: rgba(255,255,255,0.55);
                border: 1px solid rgba(0,0,0,0.08);
                border-radius: 10px;
                padding: 10px 14px;
                font-size: 0.8rem;
                margin-top: 14px;
                line-height: 1.5;
              }
              .note-cream .note-tip { border-color: rgba(180,140,60,0.2); color: #6b5010; }
              .note-pink  .note-tip { color: #7a2845; border-color: rgba(200,80,120,0.2); }

              /* Scroll-in animation */
              .note-card.note-hidden {
                opacity: 0;
                transform: translateY(40px) rotate(0deg) !important;
              }
              .note-card.note-visible {
                animation: noteIn 0.6s cubic-bezier(.34,1.36,.64,1) forwards;
              }
              @keyframes noteIn {
                from { opacity:0; transform: translateY(40px) scale(0.96) rotate(0deg); }
                to   { opacity:1; }
              }
              .note-card:nth-child(1).note-visible { animation-delay: 0.05s; }
              .note-card:nth-child(2).note-visible { animation-delay: 0.18s; }
              .note-card:nth-child(3).note-visible { animation-delay: 0.30s; }

              /* Floating keyframe on idle */
              @keyframes noteFloat {
                0%,100% { transform: translateY(0) rotate(-1.2deg); }
                50%      { transform: translateY(-5px) rotate(-1.2deg); }
              }
              @keyframes noteFloat2 {
                0%,100% { transform: translateY(0) rotate(0.8deg); }
                50%      { transform: translateY(-4px) rotate(0.8deg); }
              }
              @keyframes noteFloat3 {
                0%,100% { transform: translateY(0) rotate(-0.5deg); }
                50%      { transform: translateY(-6px) rotate(-0.5deg); }
              }
              .note-card.floating:nth-child(1) { animation: noteFloat 5s ease-in-out infinite; }
              .note-card.floating:nth-child(2) { animation: noteFloat2 6s ease-in-out infinite 0.5s; }
              .note-card.floating:nth-child(3) { animation: noteFloat3 4.5s ease-in-out infinite 1s; }

              /* Tape accent top */
              .note-tape {
                position: absolute;
                top: -9px;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 18px;
                background: rgba(255,255,220,0.65);
                border: 1px solid rgba(180,160,80,0.25);
                border-radius: 3px;
                opacity: 0.7;
              }

              /* ── NURSE MASCOT ── */
              #nurse-mascot {
                position: fixed;
                bottom: 0;
                right: 20px;
                width: 110px;
                z-index: 100;
                pointer-events: none;
                animation: nurseFloat 4s ease-in-out infinite;
              }
              @keyframes nurseFloat {
                0%,100% { transform: translateY(0); }
                50%      { transform: translateY(-10px); }
              }
              #nurse-mascot.bounce {
                animation: nurseBounce 0.5s cubic-bezier(.36,.07,.19,.97) 2;
              }
              @keyframes nurseBounce {
                0%,100% { transform: translateY(0); }
                30%      { transform: translateY(-20px); }
                60%      { transform: translateY(-8px); }
              }
              .nurse-speech {
                position: absolute;
                bottom: 95px;
                right: 2px;
                background: white;
                border: 1.5px solid rgba(46,125,50,0.22);
                border-radius: 14px 14px 4px 14px;
                padding: 7px 11px;
                font-size: 0.72rem;
                font-weight: 600;
                color: var(--primary-dark);
                white-space: nowrap;
                box-shadow: 0 4px 16px rgba(46,125,50,0.15);
                animation: nurseFloat 4s ease-in-out infinite;
                pointer-events: none;
              }
              .nurse-speech::after {
                content: '';
                position: absolute;
                bottom: -8px;
                right: 14px;
                border: 5px solid transparent;
                border-top-color: white;
              }
              @media (max-width: 768px) {
                #nurse-mascot { width: 72px; right: 8px; }
                .nurse-speech { font-size: 0.62rem; padding: 5px 8px; }
              }
              @media (max-width: 480px) {
                #nurse-mascot { display: none; }
              }

              /* Nurse blink */
              .nurse-eye { animation: nurseEyeBlink 4s ease-in-out infinite; }
              @keyframes nurseEyeBlink {
                0%,45%,55%,100% { transform: scaleY(1); }
                50% { transform: scaleY(0.05); transform-origin: center; }
              }
            </style>

            <!-- NOTE 1: Video tìm hiểu sâu hơn -->
            <div class="pinboard-section" id="section-benh-cap-cuu">
              <div class="pinboard-label">📌 bảng ghi chú y tế</div>
              <div class="row g-4">

                <div class="col-12 col-md-4">
                  <div class="note-card note-cream note-hidden">
                    <div class="note-pin">
                      <svg viewBox="0 0 24 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="10" r="9" fill="#ef4444"/>
                        <circle cx="12" cy="10" r="6" fill="#e74c3c"/>
                        <circle cx="9" cy="7" r="2" fill="rgba(255,255,255,0.4)"/>
                        <line x1="12" y1="19" x2="12" y2="40" stroke="#8B4513" stroke-width="2.5" stroke-linecap="round"/>
                      </svg>
                    </div>
                    <div class="note-title">
                      <span class="note-title-icon">🎬</span>
                      Video tìm hiểu sâu hơn
                    </div>
                    <div class="note-body">
                      <p style="margin-bottom:10px;">Sử dụng tính năng tìm kiếm video ở trên để xem các hướng dẫn cụ thể.</p>
                      <div class="note-tip">
                        💡 <strong>Mẹo:</strong> Nhập từ khóa như <em>"đột quỵ"</em>, <em>"ngưng tim"</em>, <em>"chảy máu"</em>, <em>"gãy xương"</em> để xem video hướng dẫn xử trí cụ thể.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- NOTE 2: Các bệnh cấp cứu thường gặp -->
                <div class="col-12 col-md-4">
                  <div class="note-card note-pink note-hidden">
                    <div class="note-pin">
                      <svg viewBox="0 0 24 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="10" r="9" fill="#dc2626"/>
                        <circle cx="12" cy="10" r="6" fill="#ef4444"/>
                        <circle cx="9" cy="7" r="2" fill="rgba(255,255,255,0.4)"/>
                        <line x1="12" y1="19" x2="12" y2="40" stroke="#7B3F00" stroke-width="2.5" stroke-linecap="round"/>
                      </svg>
                    </div>
                    <div class="note-title">
                      <span class="note-title-icon">🚨</span>
                      Các bệnh cấp cứu thường gặp
                    </div>
                    <div class="note-body">
                      <ul class="note-list">
                        <li><strong>Đột quỵ</strong> Méo mặt, nói khó, yếu nửa người — cần xử trí trong 3 giờ đầu</li>
                        <li><strong>Nhồi máu cơ tim</strong> Đau ngực, khó thở, nổi mồ hôi — liên hệ cấp cứu ngay</li>
                        <li><strong>Huyết áp cao/thấp</strong> Chóng mặt, nhức đầu, buồn nôn — cần theo dõi liên tục</li>
                        <li><strong>Ngưng thở/choking</strong> Không thể nói, mặt tím — thực hiện Heimlich ngay</li>
                        <li><strong>Sốc (shock)</strong> Mất ý thức, mạch yếu, da lạnh — nằm yên và gọi cấp cứu</li>
                        <li><strong>Chảy máu nặng</strong> Chảy máu không dừng, chóng mặt — rằn chặt và nhấc cao</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- NOTE 3: Những việc nên làm hằng ngày -->
                <div class="col-12 col-md-4">
                  <div class="note-card note-mint note-hidden">
                    <div class="note-pin">
                      <svg viewBox="0 0 24 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="10" r="9" fill="var(--primary-dark)"/>
                        <circle cx="12" cy="10" r="6" fill="var(--primary)"/>
                        <circle cx="9" cy="7" r="2" fill="rgba(255,255,255,0.4)"/>
                        <line x1="12" y1="19" x2="12" y2="40" stroke="#5D4037" stroke-width="2.5" stroke-linecap="round"/>
                      </svg>
                    </div>
                    <div class="note-title">
                      <span class="note-title-icon">🌿</span>
                      Những việc nên làm hằng ngày
                    </div>
                    <div class="note-body">
                      <ul class="note-list note-daily-list">
                        <li>Kiểm soát huyết áp, đường huyết, cân nặng</li>
                        <li>Ngưng hút thuốc, hạn chế rượu bia, căng thẳng</li>
                        <li>Tập thể dục 30 phút/ngày, ăn nhạt, nhiều rau quả</li>
                        <li>Kiểm tra sức khỏe định kỳ, theo dõi các triệu chứng lạ</li>
                      </ul>
                    </div>
                  </div>
                </div>

              </div><!-- /.row -->
            </div><!-- /.pinboard-section -->
            <!-- ── NURSE MASCOT ── -->
            <div id="nurse-mascot">
              <div class="nurse-speech">Cần hỗ trợ không? 🩺</div>
              <svg viewBox="0 0 120 200" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto">
                <!-- Body -->
                <ellipse cx="60" cy="155" rx="32" ry="40" fill="white" stroke="#e0e0e0" stroke-width="1.5"/>
                <!-- Uniform cross -->
                <rect x="53" y="130" width="14" height="28" rx="3" fill="var(--primary)" opacity="0.7"/>
                <rect x="46" y="138" width="28" height="12" rx="3" fill="var(--primary)" opacity="0.7"/>
                <!-- Arms -->
                <ellipse cx="28" cy="148" rx="8" ry="22" rx="22" ry="8" fill="white" stroke="#e0e0e0" stroke-width="1.5" transform="rotate(-15,28,148)"/>
                <ellipse cx="92" cy="148" rx="8" ry="22" fill="white" stroke="#e0e0e0" stroke-width="1.5" transform="rotate(15,92,148)"/>
                <!-- Syringe in right hand -->
                <g transform="rotate(30,92,162)">
                  <rect x="86" y="160" width="16" height="5" rx="2" fill="#cce0ff"/>
                  <rect x="100" y="161" width="8" height="3" rx="1" fill="#aac0e0"/>
                  <line x1="108" y1="162.5" x2="115" y2="162.5" stroke="#aaa" stroke-width="1.5" stroke-linecap="round"/>
                </g>
                <!-- Neck -->
                <rect x="52" y="110" width="16" height="20" rx="4" fill="#f4c4a0"/>
                <!-- Head -->
                <ellipse cx="60" cy="88" rx="30" ry="32" fill="#f4c4a0"/>
                <!-- Hair -->
                <ellipse cx="60" cy="63" rx="30" ry="16" fill="#7B4F2E"/>
                <ellipse cx="35" cy="82" rx="9" ry="20" fill="#7B4F2E"/>
                <ellipse cx="85" cy="82" rx="9" ry="20" fill="#7B4F2E"/>
                <!-- Ponytail -->
                <ellipse cx="85" cy="75" rx="6" ry="18" fill="#7B4F2E" transform="rotate(10,85,75)"/>
                <!-- Nurse hat -->
                <rect x="38" y="52" width="44" height="10" rx="5" fill="white" stroke="#e0e0e0" stroke-width="1"/>
                <rect x="46" y="44" width="28" height="12" rx="3" fill="white" stroke="#e0e0e0" stroke-width="1"/>
                <rect x="55" y="46" width="10" height="8" rx="1" fill="var(--primary)" opacity="0.8"/>
                <rect x="52" y="49" width="16" height="2" rx="1" fill="var(--primary)" opacity="0.8"/>
                <!-- Eyes -->
                <g class="nurse-eye">
                  <ellipse cx="50" cy="88" rx="4" ry="4.5" fill="#3d2b1a"/>
                  <ellipse cx="70" cy="88" rx="4" ry="4.5" fill="#3d2b1a"/>
                  <circle cx="51.5" cy="86.5" r="1.2" fill="white"/>
                  <circle cx="71.5" cy="86.5" r="1.2" fill="white"/>
                </g>
                <!-- Cheeks -->
                <ellipse cx="43" cy="95" rx="7" ry="5" fill="#f4a0a0" opacity="0.5"/>
                <ellipse cx="77" cy="95" rx="7" ry="5" fill="#f4a0a0" opacity="0.5"/>
                <!-- Mouth smile -->
                <path d="M52 100 Q60 107 68 100" stroke="#c0706a" stroke-width="2" fill="none" stroke-linecap="round"/>
                <!-- Legs -->
                <rect x="44" y="188" width="14" height="12" rx="5" fill="#e0d8cc"/>
                <rect x="62" y="188" width="14" height="12" rx="5" fill="#e0d8cc"/>
              </svg>
            </div>

            <script>
            (function() {
              // Scroll-in observer for note cards
              const notes = document.querySelectorAll('.note-card.note-hidden');
              if ('IntersectionObserver' in window) {
                const obs = new IntersectionObserver((entries) => {
                  entries.forEach(entry => {
                    if (entry.isIntersecting) {
                      entry.target.classList.remove('note-hidden');
                      entry.target.classList.add('note-visible');
                      // Start floating after animation
                      setTimeout(() => {
                        entry.target.classList.add('floating');
                      }, 800);
                      obs.unobserve(entry.target);
                    }
                  });
                }, { threshold: 0.15 });
                notes.forEach(n => obs.observe(n));
              } else {
                notes.forEach(n => {
                  n.classList.remove('note-hidden');
                  n.classList.add('note-visible', 'floating');
                });
              }

              // Nurse bounce when AI responds
              const nurse = document.getElementById('nurse-mascot');
              const origSendBtn = document.getElementById('sendBtn');
              if (origSendBtn && nurse) {
                origSendBtn.addEventListener('click', () => {
                  nurse.classList.remove('bounce');
                  setTimeout(() => {
                    nurse.classList.add('bounce');
                    nurse.addEventListener('animationend', () => nurse.classList.remove('bounce'), { once: true });
                  }, 1500);
                });
              }
            })();
            </script>
        </div>

        <!-- SIDEBAR -->
        <div class="col-lg-4">
            <div class="sidebar-card" id="section-giam-sat">
                <div class="sidebar-title">GIÁM SÁT SỨC KHỎE TRỰC TIẾP</div>
                <div class="p-3 vitals-box">
                    <div class="d-flex justify-content-between mb-3">
                        <strong>ESP32</strong>
                        <small>Kết nối: <span class="text-success">Live - Trực tiếp</span></small>
                    </div>
                    <div class="row text-center mb-3">
                        <div class="col-4"><div class="metric-big" id="heartVal">--</div><small>Nhịp tim</small></div>
                        <div class="col-4"><div class="metric-big text-primary" id="spoVal">--</div><small>SpO₂</small></div>
                        <div class="col-4"><div class="metric-big text-success" id="tmpVal">--</div><small>độ</small></div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <div><strong>Tình trạng:</strong><br><span id="healthStatus" class="text-success fw-bold">Bình thường</span></div>
                        <button class="btn btn-danger btn-sm" id="healthCheckBtn">KIỂM TRA</button>
                    </div>
                    <!-- Temperature simulation input -->
                    <div class="temp-sim-wrap mt-3">
                      <span class="temp-sim-label">🌡️ Giả lập nhiệt độ</span>
                      <div class="temp-sim-row">
                        <input
                          type="number"
                          id="tempSimInput"
                          class="temp-sim-input"
                          placeholder="Nhập nhiệt độ (°C)"
                          step="0.1"
                          min="30"
                          max="45"
                        >
                        <button class="temp-sim-btn" id="tempSimBtn">Kiểm tra</button>
                      </div>
                    </div>

                    <div id="healthReportModal" class="modal fade" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Báo cáo sức khỏe chi tiết</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body"><div id="reportContent"></div></div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                    <button type="button" class="btn btn-primary" id="repeatAudioBtn">🔊 Phát lại âm thanh</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="sidebar-title">BÁC SĨ AI 24/7 – HỎI GÌ CŨNG TRẢ LỜI</div>
                <div class="p-3">
                    <div id="chatbox" class="mb-2"></div>
                    <div id="chat-img-preview" style="display:none;margin-bottom:6px;padding:6px 0;"></div>
                    <div class="chat-input-bar">
                      <button id="chatImgBtn" class="chat-tool-btn" title="Gửi ảnh" onclick="document.getElementById('chatImgInput').click()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                      </button>
                      <input type="file" id="chatImgInput" accept="image/*" multiple style="display:none">
                      <button id="chatEmojiBtn" class="chat-tool-btn" title="Emoji">😊</button>
                      <input id="chatInput" class="chat-main-input" placeholder="Mô tả triệu chứng..." autocomplete="off">
                      <button id="chatMicBtn" class="chat-tool-btn chat-mic-btn" title="Giọng nói">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
                      </button>
                      <button id="sendBtn" class="chat-send-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                      </button>
                    </div>
                    <div id="chat-emoji-picker" style="display:none;padding:6px;background:#fff;border:1px solid var(--border);border-radius:10px;margin-top:4px;flex-wrap:wrap;gap:4px;max-height:100px;overflow-y:auto;">
                      <span class="ep" data-e="😊">😊</span><span class="ep" data-e="😷">😷</span><span class="ep" data-e="🤒">🤒</span><span class="ep" data-e="🤕">🤕</span><span class="ep" data-e="💊">💊</span><span class="ep" data-e="🩺">🩺</span><span class="ep" data-e="❤️">❤️</span><span class="ep" data-e="💉">💉</span><span class="ep" data-e="🧬">🧬</span><span class="ep" data-e="🌡️">🌡️</span><span class="ep" data-e="😰">😰</span><span class="ep" data-e="😴">😴</span>
                    </div>
                    <div id="chat-voice-status" style="display:none;text-align:center;font-size:11px;color:var(--primary);margin-top:4px;">🎤 Đang nghe...</div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <small class="text-muted">● AI sức khỏe • Hỗ trợ ảnh &amp; giọng nói</small>
                        <button id="chat-clear-btn" title="Xóa lịch sử">🗑 Xóa</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============ NHẬT KÝ SỨC KHỎE AI ============ -->
<!-- ============ NHẬT KÝ SỨC KHỎE AI ============ -->
<section id="section-nhat-ky-ai">
  <div class="nkai-section-head">
    <h2>&#x1F4D3; Nh&#x1EAD;t K&#xFD; S&#x1EE9;c Kh&#x1ECF;e AI</h2>
    <span class="nkai-ai-badge">
      <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M12 2a10 10 0 110 20A10 10 0 0112 2zm0 2a8 8 0 100 16A8 8 0 0012 4zm1 4v4h3l-4 6v-4H9l4-6z"/></svg>
      AI Powered
    </span>
  </div>
  <div class="nkai-grid">
    <!-- LEFT: Video -->
    <div class="nkai-card">
      <div class="nkai-video-head">&#x1F3AC; Video t&#xEC;m hi&#x1EC3;u s&#xE2;u h&#x1EE3;n</div>
      <div class="nkai-video-body">
        <div class="nkai-video-search">
          <input id="nkai-vq" type="text" placeholder="Nh&#x1EAD;p t&#x1EEB; kh&#xF3;a ho&#x1EB7;c link YouTube...">
          <button onclick="nkaiSearchVideo()">&#x25B6; T&#xEC;m</button>
        </div>
        <div class="nkai-video-player" id="nkai-video-player" style="background:#f8f8f8;border:1px solid #eee;min-height:120px;display:flex;align-items:center;justify-content:center;border-radius:8px;">
          <div class="nkai-video-placeholder" id="nkai-video-placeholder">&#x1F3A5;<span id="nkai-video-msg">Nh&#x1EAD;p t&#x1EEB; kh&#xF3;a ho&#x1EB7;c ch&#x1ECD;n video g&#x1EE3;i &#xFD; — b&#x1EA5;m &#x1EB5; m&#x1EDF; YouTube</span></div>
          <a id="nkai-video-link" href="#" target="_blank" rel="noopener noreferrer" style="display:none;width:100%;height:100%;align-items:center;justify-content:center;flex-direction:column;gap:8px;text-decoration:none;color:inherit;padding:20px;text-align:center;">
            <div style="font-size:40px;">&#x25B6;&#xFE0F;</div>
            <div id="nkai-video-link-title" style="font-size:13px;font-weight:700;color:#1a1a2e;"></div>
            <div style="font-size:11px;color:var(--primary);font-weight:600;">Bấm để xem trên YouTube ↗</div>
          </a>
        </div>
        <div class="nkai-quick-btns">
          <a class="nkai-yt-btn" href="https://www.youtube.com/watch?v=SKs8EKh_3SQ" target="_blank" rel="noopener noreferrer">&#x110E;&#x1ED9;t qu&#x1EF5;</a>
          <a class="nkai-yt-btn" href="https://www.youtube.com/watch?v=inkRQZPO51Y" target="_blank" rel="noopener noreferrer">Ng&#x01B0;ng tim</a>
          <a class="nkai-yt-btn" href="https://www.youtube.com/watch?v=ueGVsVE5ZLk" target="_blank" rel="noopener noreferrer">Ch&#x1EA3;y m&#xE1;u</a>
          <a class="nkai-yt-btn" href="https://www.youtube.com/watch?v=Ei1UsHqtUvo" target="_blank" rel="noopener noreferrer">Ng&#x01B0;ng th&#x1EDF;</a>
          <a class="nkai-yt-btn" href="https://www.youtube.com/watch?v=zWHyVGUHX7U" target="_blank" rel="noopener noreferrer">Ngh&#x1EB9;n</a>
          <a class="nkai-yt-btn" href="https://www.youtube.com/watch?v=nsZkiTZPVM4" target="_blank" rel="noopener noreferrer">G&#xE3;y x&#x01B0;&#x1A3;ng</a>
          <a class="nkai-yt-btn" href="https://www.youtube.com/watch?v=NQrnzq8jcHQ" target="_blank" rel="noopener noreferrer">Huy&#x1EBF;t &#xE1;p</a>
        </div>
      </div>
    </div>
    <!-- RIGHT: AI Diary -->
    <div class="nkai-card">
      <div class="nkai-diary-head">
        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 2a10 10 0 110 20A10 10 0 0112 2zm0 2a8 8 0 100 16A8 8 0 0012 4zm1 4v4h3l-4 6v-4H9l4-6z"/></svg>
        T&#x1EA1;o Nh&#x1EAD;t K&#xFD; S&#x1EE9;c Kh&#x1ECF;e AI
      <span class="hs-sync-badge" style="margin-left:auto">✓ Đồng bộ</span></div>
      <div class="nkai-form" id="nkai-form-wrap">
        <div class="nkai-row2">
          <div class="nkai-field"><label>Nh&#x1ECB;p tim <span class="unit">(bpm)</span></label><input id="nkai-hr" data-key="heartRate" type="number" class="nkai-inp" placeholder="vd: 75 bpm" min="30" max="250"></div>
          <div class="nkai-field"><label>Nhi&#x1EC7;t &#x111;&#x1ED9; <span class="unit">(&#xB0;C)</span></label><input id="nkai-temp" data-key="temperature" type="number" class="nkai-inp" placeholder="vd: 36.6°C" step="0.1" min="30" max="43"></div>
        </div>
        <div class="nkai-row2">
          <div class="nkai-field"><label>SpO&#x2082; <span class="unit">(%)</span></label><input id="nkai-spo2" data-key="spo2" type="number" class="nkai-inp" placeholder="vd: 98%" min="50" max="100"></div>
          <div class="nkai-field"><label>Gi&#x1EA5;c ng&#x1EE7; <span class="unit">(gi&#x1EDD;)</span></label><input id="nkai-sleep" data-key="sleep" type="number" class="nkai-inp" placeholder="vd: 7 giờ" step="0.5" min="0" max="24"></div>
        </div>
        <div class="nkai-field">
          <label>M&#x1EE9;c &#x111;&#x1ED9; stress <span class="unit" id="nkai-stress-lbl">5/10</span></label>
          <div class="nkai-slider-wrap">
            &#x1F60C;
            <input type="range" id="nkai-stress" data-key="stress" min="1" max="10" value="5" oninput="document.getElementById('nkai-stress-lbl').textContent=this.value+'/10';document.getElementById('nkai-stress-val').textContent=this.value;if(window.HealthStore)HealthStore.set({stress:parseInt(this.value)},'nkai_slider')">
            &#x1F62B;
            <span class="nkai-slider-val" id="nkai-stress-val">5</span>
          </div>
        </div>
        <div class="nkai-field">
          <label>Ghi ch&#xFA; th&#xEA;m <span class="unit">(t&#xF9;y ch&#x1ECD;n)</span></label>
          <textarea id="nkai-note" class="nkai-inp" placeholder="V&#xED; d&#x1EE5;: &#x111;au &#x111;&#x1EA7;u nh&#x1EB9;, u&#x1ED1;ng nhi&#x1EC1;u n&#x01B0;&#x1EDB;c, v&#x1EEB;a t&#x1EAD;p th&#x1EC3; d&#x1EE5;c..."></textarea>
        </div>
        <button class="nkai-btn" id="nkai-btn" onclick="nkaiGenerate()">
          <div class="nkai-spin" id="nkai-spin"></div>
          <span id="nkai-btxt">&#x1F4DD; T&#x1EA1;o Nh&#x1EAD;t K&#xFD; AI</span>
        </button>
      </div>
      <div class="nkai-loading" id="nkai-loading"><span class="nkai-pulse">&#x1F916;</span>AI &#x111;ang ph&#xE2;n t&#xED;ch &amp; vi&#x1EBF;t nh&#x1EAD;t k&#xFD; s&#x1EE9;c kh&#x1ECF;e c&#x1EE7;a b&#x1EA1;n...</div>
      <div class="nkai-output" id="nkai-output"><div id="nkai-entry-container"></div></div>
      <div id="nkai-history-wrap" style="display:none">
        <div class="nkai-history-head">&#x1F4CB; L&#x1ECB;ch s&#x1EED; nh&#x1EAD;t k&#xFD;<button onclick="nkaiClearHistory()">X&#xF3;a t&#x1EA5;t c&#x1EA3;</button></div>
        <div class="nkai-history-list" id="nkai-history-list"></div>
      </div>
    </div>
  </div>
</section>

<section id="section-tu-van-ai">
    <div class="ha-top-label">🤖 TƯ VẤN AI — HỆ THỐNG PHÂN TÍCH SỨC KHỎE THÔNG MINH 7 BƯỚC</div>
    <div class="ha-disclaimer">⚠️ <strong>Lưu ý:</strong> Công cụ hỗ trợ đánh giá ban đầu — không thay thế chẩn đoán y tế chuyên nghiệp. Gọi <strong>115</strong> khi có dấu hiệu khẩn cấp!</div>

    <div class="ha-container">
        <div class="ha-wrap">
            <!-- LEFT -->
            <div>
                <div class="ha-card">
                    <div class="ha-card-hd">📋 Nhập Dữ Liệu Sinh Lý</div>
                    <div class="ha-card-bd">
                        <div class="ha-f2">
                            <div class="ha-fld"><label>Nhịp Tim &nbsp;<span class="u">(bpm)</span></label><input type="number" id="ha-hr" data-key="heartRate" class="ha-inp" placeholder="vd: 75 bpm" min="30" max="250"></div>
                            <div class="ha-fld"><label>SpO₂ &nbsp;<span class="u">(%)</span></label><input type="number" id="ha-spo2" data-key="spo2" class="ha-inp" placeholder="vd: 98%" min="50" max="100"></div>
                        </div>
                        <div class="ha-fld"><label>Nhiệt Độ Cơ Thể &nbsp;<span class="u">(°C)</span></label><input type="number" id="ha-temp" data-key="temperature" class="ha-inp" placeholder="vd: 36.6°C" step="0.1" min="30" max="43"></div>
                        <div class="ha-fld">
                            <label>Trạng Thái Cảm Xúc</label>
                            <div class="ha-egrid">
                                <div class="ha-epill" data-val="normal"><span class="ei">😊</span>Bình thường</div>
                                <div class="ha-epill" data-val="stress"><span class="ei">😤</span>Căng thẳng</div>
                                <div class="ha-epill" data-val="anxious"><span class="ei">😰</span>Lo âu</div>
                                <div class="ha-epill" data-val="sad"><span class="ei">😔</span>Buồn bã</div>
                                <div class="ha-epill" data-val="tired"><span class="ei">😴</span>Mệt mỏi</div>
                                <div class="ha-epill" data-val="pain"><span class="ei">😣</span>Đau nhức</div>
                            </div>
                        </div>
                        <div class="ha-fld"><label>Triệu Chứng &nbsp;<span class="u">(tùy chọn)</span></label><textarea id="ha-sym" class="ha-inp" placeholder="mô tả triệu chứng nếu có..."></textarea></div>
                        <div class="ha-fld"><label>Tiền Sử / Lịch Sử Gần Đây &nbsp;<span class="u">(tùy chọn)</span></label><textarea id="ha-hist" class="ha-inp" placeholder="tiền sử, hoạt động gần đây..."></textarea></div>
                        <div class="hs-store-info" style="margin-bottom:16px;padding:10px 14px;background:linear-gradient(135deg,rgba(255,240,245,0.5),rgba(245,235,255,0.5));border-radius:10px;border:1px dashed rgba(46,125,50,0.2);">
                            <span class="hs-store-dot"></span>
                            <span style="color:#6aab6e;font-style:italic;">Nhập chỉ số của bạn để AI phân tích</span>
                            <span class="hs-sync-badge">✓ Đồng bộ</span>
                        </div>
                        <button class="ha-btn" id="ha-abtn" onclick="haRun()">
                            <div class="ha-spin" id="ha-spin"></div>
                            <span id="ha-btxt">⊕ PHÂN TÍCH BẰNG AI</span>
                        </button>
                    </div>
                </div>

                <div class="ha-load" id="ha-load">
                    <div class="ha-pulse">🫀</div>
                    <div class="ha-lt">Đang Phân Tích Dữ Liệu...</div>
                    <div class="ha-ls">Hệ thống AI đang xử lý chỉ số sức khỏe của bạn</div>
                    <div class="ha-lsteps">
                        <div class="ha-lstep" id="hs1">→ Đánh giá các chỉ số sinh lý...</div>
                        <div class="ha-lstep" id="hs2">→ Phân tích trạng thái tâm lý...</div>
                        <div class="ha-lstep" id="hs3">→ Nhận diện pattern triệu chứng...</div>
                        <div class="ha-lstep" id="hs4">→ Phân tầng nguy cơ lâm sàng...</div>
                        <div class="ha-lstep" id="hs5">→ Tổng hợp biện pháp khuyến nghị...</div>
                    </div>
                </div>

                <div class="ha-err" id="ha-err">⚠️ <span id="ha-errtxt"></span></div>

                <div id="ha-out">
                    <div class="ha-card ha-fade">
                        <div class="ha-card-hd">📊 Đánh Giá Chỉ Số Sinh Lý</div>
                        <div class="ha-card-bd" style="padding-bottom:6px"><div class="ha-vs" id="ha-vs"></div></div>
                    </div>
                    <div id="ha-rw"></div>
                    <div class="ha-2col">
                        <div class="ha-card"><div class="ha-card-hd">🧠 Phân Tích Tâm Lý</div><div class="ha-card-bd" id="ha-psych"></div></div>
                        <div class="ha-card"><div class="ha-card-hd">🔄 Sơ Đồ Suy Luận</div><div class="ha-card-bd" id="ha-flow"></div></div>
                    </div>
                    <div class="ha-card"><div class="ha-card-hd">🔬 Giả Thuyết Nguy Cơ — Differential Reasoning</div><div class="ha-card-bd" id="ha-hypo"></div></div>
                    <div class="ha-card"><div class="ha-card-hd">📋 Biện Pháp Đề Nghị</div><div class="ha-card-bd"><div class="ha-m3" id="ha-meas"></div></div></div>
                    <div class="ha-card"><div class="ha-card-hd">✨ Can Thiệp Tinh Thần — AI Healing</div><div class="ha-card-bd"><div class="ha-hg" id="ha-heal"></div></div></div>
                </div>
            </div>

            <!-- RIGHT SIDEBAR -->
            <div>
                <div class="ha-sc">
                    <div class="ha-shd">📏 Phạm Vi Chỉ Số Bình Thường</div>
                    <div style="padding:0 14px">
                        <div class="ha-rr"><span class="ha-rl">❤️ Nhịp Tim</span><span class="ha-rv">60 – 100 bpm</span></div>
                        <div class="ha-rr"><span class="ha-rl">🌡️ Nhiệt Độ</span><span class="ha-rv">36.1 – 37.2°C</span></div>
                        <div class="ha-rr"><span class="ha-rl">🫧 SpO₂</span><span class="ha-rv">≥ 95%</span></div>
                        <div class="ha-rr"><span class="ha-rl">⚡ Khẩn cấp HR</span><span class="ha-rv" style="color:#888">&lt;40 / &gt;150</span></div>
                        <div class="ha-rr"><span class="ha-rl">🚨 Sốt cao</span><span class="ha-rv" style="color:#888">&gt; 38.5°C</span></div>
                        <div class="ha-rr"><span class="ha-rl">⛔ SpO₂ nguy hiểm</span><span class="ha-rv" style="color:#888">&lt; 90%</span></div>
                    </div>
                </div>
                <div class="ha-sc">
                    <div class="ha-shd">⚙️ Quy Trình Phân Tích 7 Bước</div>
                    <div>
                        <div style="padding:10px 14px;border-bottom:1px solid #f0f0f0"><div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:3px">BƯỚC 1–3</div><div style="font-size:12px;color:#444;line-height:1.5">Đánh giá sinh lý, phân tích tâm lý, nhận diện pattern triệu chứng</div></div>
                        <div style="padding:10px 14px;border-bottom:1px solid #f0f0f0"><div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:3px">BƯỚC 4–5</div><div style="font-size:12px;color:#444;line-height:1.5">Phân tầng nguy cơ, sơ đồ suy luận lâm sàng</div></div>
                        <div style="padding:10px 14px"><div style="font-size:11px;font-weight:700;color:var(--primary);margin-bottom:3px">BƯỚC 6–7</div><div style="font-size:12px;color:#444;line-height:1.5">Biện pháp khuyến nghị &amp; can thiệp tinh thần</div></div>
                    </div>
                </div>
                <div class="ha-ib"><strong>🤖 Được hỗ trợ bởi Claude AI (Anthropic)</strong><br>Mô hình AI suy luận lâm sàng theo quy trình khoa học. Kết quả chỉ mang tính tham khảo ban đầu.</div>
                <div class="ha-sc">
                    <div class="ha-shd">🚑 Gọi Cấp Cứu Ngay</div>
                    <div class="ha-sb" style="text-align:center">
                        <div style="font-size:32px;font-weight:900;color:var(--primary);margin-bottom:6px">📞 115</div>
                        <div style="font-size:12px;color:#666;line-height:1.6">Khi: đau ngực dữ dội, khó thở cấp, bất tỉnh, SpO₂ &lt; 90%, nhịp tim bất thường nghiêm trọng</div>
                    </div>
                </div>
                <!-- HA History Box -->
                <div class="ha-sc" id="ha-history-wrap">
                    <div class="ha-hist-head">
                        📋 Lịch Sử Phân Tích
                        <button onclick="haClearHistory()">Xóa tất cả</button>
                    </div>
                    <div class="ha-hist-list" id="ha-history-list"></div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- ══ HEALING BUBBLE INFOGRAPHIC ══ -->
<div id="section-healing">
  <div class="healing-wrap">

    <!-- ── Header ── -->
    <div class="healing-section-head">
      <span class="hs-head-icon">🌿</span>
      <span class="hs-head-eyebrow">AI GENERATED</span>
      <span class="hs-head-title">Chữa Lành &amp; Thư Giãn AI</span>
      <span class="hs-head-sub">Nội dung cá nhân hoá theo chỉ số sức khỏe của bạn — cập nhật tự động</span>
      <span id="hsStateLine">▸ Đang phân tích chỉ số...</span>
    </div>

    <!-- ── Bubble Infographic Grid — rendered by JS ── -->
    <div class="healing-grid" id="healingGrid">
      <!-- Loading state -->
      <div style="grid-column:1/-1;padding:64px 20px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:16px;">
        <div style="width:44px;height:44px;border:3px solid rgba(182,154,247,.2);border-top-color:#b69af7;border-radius:50%;animation:hsspin .9s linear infinite;"></div>
        <span style="font-family:'DM Sans',sans-serif;font-style:italic;font-size:.9rem;color:#b69af7;">Đang phân tích dữ liệu sức khỏe...</span>
      </div>
    </div>

    <!-- ── Hormone happiness row ── -->
    <div style="text-align:center;margin-bottom:12px;">
      <div class="hormone-section-label">Hormone Hạnh Phúc · Được kích hoạt theo trạng thái</div>
    </div>
    <div class="hormone-row" id="hormoneRow">
      <div class="hormone-bubble" id="hb-dopamine" title="Dopamine — Phần thưởng &amp; Động lực">
        <div class="hormone-icon-wrap h-dopamine">⚡</div>
        <div class="hormone-name">Dopamine</div>
        <div class="hormone-action">Vận động · Thành tích</div>
      </div>
      <div class="hormone-bubble" id="hb-serotonin" title="Serotonin — Hạnh phúc &amp; Bình yên">
        <div class="hormone-icon-wrap h-serotonin">☀️</div>
        <div class="hormone-name">Serotonin</div>
        <div class="hormone-action">Ánh sáng · Thiên nhiên</div>
      </div>
      <div class="hormone-bubble" id="hb-oxytocin" title="Oxytocin — Kết nối &amp; Yêu thương">
        <div class="hormone-icon-wrap h-oxytocin">🫂</div>
        <div class="hormone-name">Oxytocin</div>
        <div class="hormone-action">Ôm · Kết nối</div>
      </div>
      <div class="hormone-bubble" id="hb-endorphin" title="Endorphin — Giảm đau &amp; Vui vẻ">
        <div class="hormone-icon-wrap h-endorphin">💫</div>
        <div class="hormone-name">Endorphin</div>
        <div class="hormone-action">Cười · Tập thể dục</div>
      </div>
    </div>

  </div><!-- /.healing-wrap -->

  <!-- Now playing pill -->
  <div class="hs-now-playing" id="hsNowPlaying">
    <div class="hs-np-bars">
      <div class="hs-np-bar"></div><div class="hs-np-bar"></div>
      <div class="hs-np-bar"></div><div class="hs-np-bar"></div>
      <div class="hs-np-bar"></div>
    </div>
    <span class="hs-np-name" id="hsNpName">—</span>
    <span class="hs-np-sub" id="hsNpSub"></span>
    <button class="btn-np-stop" onclick="hsStopMusic()">■ Dừng</button>
  </div>

  <!-- Detail panel (bubble click → expand) -->
  <div class="hs-detail-panel" id="hsDetailPanel">
    <div class="hs-detail-backdrop" onclick="hsCloseDetail()"></div>
    <div class="hs-detail-modal" id="hsDetailModal">
      <div class="hs-detail-modal-head">
        <span class="hs-detail-modal-icon" id="hsDetailIcon">🌸</span>
        <div>
          <div class="hs-detail-modal-title" id="hsDetailTitle">Chi tiết</div>
          <div class="hs-detail-modal-sub" id="hsDetailSub">Healing AI</div>
        </div>
        <button class="hs-detail-modal-close" onclick="hsCloseDetail()">✕</button>
      </div>
      <div class="hs-detail-modal-body" id="hsDetailBody"></div>
    </div>
  </div>

</div><!-- /#section-healing -->

<!-- FOOTER -->
<footer class="mt-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="navbar-brand d-block mb-2">HealthAI Pro</div>
                <p>Hệ thống giám sát và phân tích sức khỏe thông minh. Cung cấp thông tin y tế tin cậy, tư vấn AI 24/7 và giám sát sức khỏe thời gian thực.</p>
                <div class="mt-3 d-flex align-items-center gap-2">
                    <span class="badge bg-danger" style="border-radius:999px;font-size:0.72rem;padding:4px 10px;">● Đang hoạt động</span>
                    <span class="text-muted small">Gọi cấp cứu: <strong style="color:var(--text-main)">115</strong></span>
                </div>
            </div>
            <div class="col-lg-2 col-6">
                <h6 class="mb-3">Điều hướng</h6>
                <ul class="list-unstyled small">
                    <li class="mb-2"><a href="#section-benh-cap-cuu" class="footer-link">Bệnh Cấp Cứu</a></li>
                    <li class="mb-2"><a href="#section-so-cuu" class="footer-link">Hướng Dẫn Sơ Cứu</a></li>
                    <li class="mb-2"><a href="#section-video" class="footer-link">Video</a></li>
                    <li class="mb-2"><a href="#section-giam-sat" class="footer-link">Giám Sát Sức Khỏe</a></li>
                    <li class="mb-2"><a href="#section-tu-van-ai" class="footer-link">Tư Vấn AI</a></li>
                </ul>
            </div>
            <div class="col-lg-3 col-6">
                <h6 class="mb-3">Liên kết hữu ích</h6>
                <ul class="list-unstyled small">
                    <li class="mb-2"><a href="https://www.who.int/" target="_blank" class="footer-link">WHO – Tổ chức Y tế Thế giới</a></li>
                    <li class="mb-2"><a href="https://moh.gov.vn/" target="_blank" class="footer-link">Bộ Y tế Việt Nam</a></li>
                    <li class="mb-2"><a href="https://benhvien108.vn/" target="_blank" class="footer-link">Bệnh viện 108</a></li>
                    <li class="mb-2"><a href="https://bachmai.gov.vn/" target="_blank" class="footer-link">Bệnh viện Bạch Mai</a></li>
                </ul>
            </div>
            <div class="col-lg-3">
                <h6 class="mb-3">Khẩn cấp</h6>
                <div class="footer-emergency mb-2">
                    <div style="color:#ef4444;font-weight:700;font-size:0.88rem;">🚨 Cấp cứu 115</div>
                    <div class="text-muted small">Gọi ngay khi có dấu hiệu nguy hiểm</div>
                </div>
                <div class="footer-fast">
                    <div style="font-weight:700;font-size:0.88rem;color:var(--text-main);">🔴 Đột quỵ: F.A.S.T</div>
                    <div class="text-muted small">Face · Arms · Speech · Time</div>
                </div>
            </div>
        </div>
        <hr class="mt-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 pb-2">
            <span class="text-muted small">© 2025 Sức Khỏe 24H. Thông tin chỉ mang tính chất tham khảo.</span>
            <span class="text-muted small">Dữ liệu từ ESP32 · Firebase Realtime DB · AI Engine Nội Bộ (Offline-ready)</span>
        </div>
    </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Scroll fade-in observer -->
<script>
(function() {
  if ('IntersectionObserver' in window) {
    var obs = new IntersectionObserver(function(entries) {
      entries.forEach(function(e) {
        if (e.isIntersecting) {
          e.target.classList.add('visible');
          obs.unobserve(e.target);
        }
      });
    }, { threshold: 0.1 });
    document.querySelectorAll('.fade-in-up').forEach(function(el) { obs.observe(el); });
  } else {
    document.querySelectorAll('.fade-in-up').forEach(function(el) { el.classList.add('visible'); });
  }
})();
</script>

<script>
/* ═══════════════════════════════════════════════════════════════════
   🏥 HEALTH STORE — Single Source of Truth v1.0
   Đặt TRƯỚC tất cả script khác (inject vào <head> cuối)
   ═══════════════════════════════════════════════════════════════════
   Schema: { hr, temp, spo2, stress, symptoms, updatedAt, source }
   API:
     HealthStore.set(patch, source)   → merge + persist + dispatch event
     HealthStore.get()                → clone hiện tại
     HealthStore.subscribe(fn)        → lắng nghe thay đổi
     HealthStore.setAICache(key, val) → cache kết quả AI
     HealthStore.getAICache(key)      → đọc cache AI
   Event: window dispatchEvent(new CustomEvent('healthstore:update', {detail}))
═══════════════════════════════════════════════════════════════════ */
(function(global) {
  'use strict';

  const LS_KEY     = 'health_store_v1';
  const LS_CACHE   = 'health_ai_cache_v1';
  const DEBOUNCE_MS = 300;

  /* ── Defaults ── */
  const DEFAULT_STATE = {
    hr: null, temp: null, spo2: null,
    stress: 5, symptoms: [],
    updatedAt: null, source: null,
  };

  /* ── Load from localStorage ── */
  function _load() {
    try {
      const raw = JSON.parse(localStorage.getItem(LS_KEY));
      if (raw && raw.updatedAt) return Object.assign({}, DEFAULT_STATE, raw);
    } catch(e) {}
    return Object.assign({}, DEFAULT_STATE);
  }

  /* ── Persist ── */
  function _save(state) {
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch(e) {}
  }

  /* ── Internal state ── */
  let _state      = _load();
  let _listeners  = [];
  let _debTimer   = null;
  let _aiCache    = {};

  /* Load AI cache */
  try { _aiCache = JSON.parse(localStorage.getItem(LS_CACHE)) || {}; } catch(e) {}

  /* ── Debounced dispatch ── */
  function _dispatch(state) {
    clearTimeout(_debTimer);
    _debTimer = setTimeout(() => {
      const detail = Object.assign({}, state);
      // Notify all subscribers
      _listeners.forEach(fn => { try { fn(detail); } catch(e) {} });
      // Dispatch DOM event for loose coupling
      try {
        global.dispatchEvent(new CustomEvent('healthstore:update', { detail, bubbles: false }));
      } catch(e) {}
    }, DEBOUNCE_MS);
  }

  /* ── AI Cache key builder ── */
  function _cacheKey(state) {
    return `${state.hr||0}_${state.temp||0}_${state.spo2||0}_${state.stress||5}`;
  }

  /* ── Public API ── */
  const HealthStore = {

    /** Merge partial update into store */
    set(patch, source = 'manual') {
      const prev = JSON.stringify(_state);
      const next = Object.assign({}, _state, patch, {
        updatedAt: Date.now(),
        source,
      });
      // Clean: remove NaN / zero vitals
      ['hr','temp','spo2'].forEach(k => {
        if (next[k] !== null && (isNaN(next[k]) || next[k] <= 0)) next[k] = null;
      });
      if (!Array.isArray(next.symptoms)) next.symptoms = [];

      _state = next;
      _save(_state);

      // Only dispatch if actually changed
      if (JSON.stringify(next) !== prev) _dispatch(next);
    },

    /** Get immutable snapshot */
    get() { return Object.assign({}, _state); },

    /** Subscribe to changes — returns unsubscribe fn */
    subscribe(fn) {
      _listeners.push(fn);
      return () => { _listeners = _listeners.filter(l => l !== fn); };
    },

    /** Check if current vitals differ from cache → AI rerun needed */
    needsAIRerun() {
      return !_aiCache[_cacheKey(_state)];
    },

    /** Store AI result by current vitals key */
    setAICache(result) {
      const key = _cacheKey(_state);
      _aiCache[key] = { result, ts: Date.now() };
      // Keep cache small: max 20 entries
      const keys = Object.keys(_aiCache);
      if (keys.length > 20) delete _aiCache[keys[0]];
      try { localStorage.setItem(LS_CACHE, JSON.stringify(_aiCache)); } catch(e) {}
    },

    /** Get cached AI result for current vitals, or null */
    getAICache() {
      const entry = _aiCache[_cacheKey(_state)];
      // Cache valid for 10 minutes
      if (entry && Date.now() - entry.ts < 600000) return entry.result;
      return null;
    },

    /** Fill a form field from store if empty */
    fillInput(id, field) {
      const el = document.getElementById(id);
      const val = _state[field];
      if (el && val !== null && val !== undefined && el.value === '') {
        el.value = val;
      }
    },

    /** Read a number input and merge into store */
    bindInput(id, field, source = 'form') {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', () => {
        const v = parseFloat(el.value);
        if (!isNaN(v) && v > 0) HealthStore.set({ [field]: v }, source);
      });
    },

    /** Debug dump */
    debug() { console.table(_state); },
  };

  /* ── Expose globally ── */
  global.HealthStore = HealthStore;

})(window);

</script>

<script>
// Navbar date
(function(){
    const d=new Date();
    const days=['Chủ Nhật','Thứ Hai','Thứ Ba','Thứ Tư','Thứ Năm','Thứ Sáu','Thứ Bảy'];
    const el=document.getElementById('navDateTxt');
    if(el) el.textContent=`${days[d.getDay()]}, ngày ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
})();

// Health report modal
(function(){
    window.lastAudioUrl='';
    const healthCheckBtn=document.getElementById('healthCheckBtn');
    const hModal=new bootstrap.Modal(document.getElementById('healthReportModal'));
    const repContent=document.getElementById('reportContent');
    const repeatBtn=document.getElementById('repeatAudioBtn');
    function getLevel(hr,sp,tp){
        const a=[];
        if(hr<60||hr>110)a.push('Nhịp tim');
        if(sp<95)a.push('SpO₂');
        if(tp<36||tp>38)a.push('Nhiệt độ');
        if(a.length===0)return{level:'good',message:'Tốt',color:'success',icon:'✓'};
        if(a.length===1)return{level:'normal',message:'Bình thường',color:'warning',icon:'⚠'};
        return{level:'bad',message:'Xấu - Cảnh báo',color:'danger',icon:'✕'};
    }
    function playAudio(l){
        const m={'good':'./audio/health_good.mp3','normal':'./audio/health_normal.mp3','bad':'./audio/health_bad.mp3'};
        if(m[l]){window.lastAudioUrl=m[l];new Audio(m[l]).play().catch(()=>{});}
    }
    function showReport(){
        /* ✔ Ưu tiên dùng healthState (nguồn duy nhất) nếu user đã phân tích.
           Fallback: đọc từ sidebar display (ESP32/Firebase live). */
        const hr = (window.healthState && window.healthState.heartRate)
          ? window.healthState.heartRate
          : (parseInt(document.getElementById('heartVal').textContent)||0);
        const sp = (window.healthState && window.healthState.spo2)
          ? window.healthState.spo2
          : (parseInt(document.getElementById('spoVal').textContent)||0);
        const tempSimEl = document.getElementById('tempSimInput');
        let tp = (window.healthState && window.healthState.temperature)
          ? window.healthState.temperature
          : 0;
        if (!tp && tempSimEl && tempSimEl.value.trim() !== '') {
          tp = parseFloat(tempSimEl.value) || 0;
          window.healthState.temperature = tp;
          if (tp && window.updateThemeByTemperature) updateThemeByTemperature(tp);
        }
        if (!tp) tp = parseFloat(document.getElementById('tmpVal').textContent) || 0;
        const h=getLevel(hr,sp,tp);
        repContent.innerHTML=`<div class="alert alert-${h.color}"><strong>${h.icon} Tình trạng: ${h.message}</strong></div>
            <table class="table table-sm">
                <tr><td><strong>Nhịp tim</strong></td><td>${hr} bpm</td><td>${hr<60||hr>110?'⚠ Không bình thường':'✓ Bình thường'}</td></tr>
                <tr><td><strong>SpO₂</strong></td><td>${sp} %</td><td>${sp<95?'⚠ Thấp':'✓ Bình thường'}</td></tr>
                <tr><td><strong>Nhiệt độ</strong></td><td>${isNaN(tp)?'--':tp.toFixed(2)} °C</td><td>${tp<36||tp>38?'⚠ Bất thường':'✓ Bình thường'}</td></tr>
            </table>
            <div class="alert alert-info small mt-3"><strong>Ghi chú:</strong> Dữ liệu từ ESP32/Firebase. Nếu "Xấu" vui lòng gọi <strong>115</strong>.</div>`;
        playAudio(h.level);
        hModal.show();
    }
    if(healthCheckBtn)healthCheckBtn.addEventListener('click',showReport);
    if(repeatBtn)repeatBtn.addEventListener('click',()=>{if(window.lastAudioUrl)new Audio(window.lastAudioUrl).play().catch(()=>{});});
})();

// Video search & chat
(function(){
    const map={'đột quỵ':'SKs8EKh_3SQ','dot quy':'SKs8EKh_3SQ','xử lý đột quỵ':'SKs8EKh_3SQ','ngưng tim':'inkRQZPO51Y','cpr':'inkRQZPO51Y','hồi sức':'inkRQZPO51Y','chảy máu':'ueGVsVE5ZLk','xử lý chảy máu':'ueGVsVE5ZLk','ngưng thở':'Ei1UsHqtUvo','hô hấp khẩn cấp':'Ei1UsHqtUvo','nghẹn':'zWHyVGUHX7U','choking':'zWHyVGUHX7U','gãy xương':'nsZkiTZPVM4','gãy chân':'nsZkiTZPVM4','tụt huyết áp':'NQrnzq8jcHQ','huyết áp thấp':'NQrnzq8jcHQ'};
    const qEl=document.getElementById('videoQuery'),btn=document.getElementById('findVideoBtn'),area=document.getElementById('videoArea'),slider=document.getElementById('videoSlider'),videoLinkAnchor=document.getElementById('videoLinkAnchor'),videoLinkTitle=document.getElementById('videoLinkTitle');
    function ytid(url){if(!url)return null;const m=url.match(/(?:v=|\/embed\/|\.be\/)([A-Za-z0-9_-]{6,})/);return m?m[1]:null;}
    function showVideoLink(id, title) {
        if(videoLinkAnchor) videoLinkAnchor.href='https://www.youtube.com/watch?v='+id;
        if(videoLinkTitle) videoLinkTitle.textContent=title||'Video YouTube';
        area.classList.remove('d-none');
        window.open('https://www.youtube.com/watch?v='+id,'_blank','noopener,noreferrer');
    }
    function embed(raw){
        if(!raw)return;const t=raw.trim();const id=ytid(t);
        if(id){ showVideoLink(id, t); return; }
        const k=t.toLowerCase();
        if(map[k]){ showVideoLink(map[k], t); return; }
        area.classList.add('d-none');if(slider)slider.scrollIntoView({behavior:'smooth',block:'center'});
    }
    if(btn&&qEl){btn.addEventListener('click',()=>embed(qEl.value));qEl.addEventListener('keydown',e=>{if(e.key==='Enter')embed(qEl.value);});}
    document.querySelectorAll('.selectVideoBtn').forEach(b=>b.addEventListener('click',ev=>{const id=ev.currentTarget.getAttribute('data-vid');if(id){window.open('https://www.youtube.com/watch?v='+id,'_blank','noopener,noreferrer');}}));
    document.querySelectorAll('.video-quick').forEach(el=>el.addEventListener('click',function(){const q=this.getAttribute('data-q');if(!q)return;qEl.value=q;btn?.click();}));
})();

// ═══════════════════════════════════════════════════════════════
// 🤖 BÁC SĨ AI 24/7 — Conversational Health Assistant v3.0
// Engine: Context-aware, multi-turn, offline-first với fallback nội bộ
// ═══════════════════════════════════════════════════════════════

const chatbox    = document.getElementById('chatbox');
const chatInput  = document.getElementById('chatInput');
const sendBtn    = document.getElementById('sendBtn');

/* ── CSS bổ sung cho avatar + timestamp ── */
const chatStyle = document.createElement('style');
chatStyle.textContent = `
  #chatbox { scroll-behavior: smooth; }
  .bubble-row { display:flex; align-items:flex-end; gap:8px; margin:6px 0; }
  .bubble-row.user { flex-direction:row-reverse; }
  .bubble-avatar { width:28px; height:28px; border-radius:50%; flex-shrink:0;
    display:flex; align-items:center; justify-content:center; font-size:14px;
    background:#f0f0f0; border:1.5px solid #ddd; }
  .bubble-row.user .bubble-avatar { background:#d71921; color:#fff; border-color:#b71c1c; }
  .bubble-wrap { display:flex; flex-direction:column; max-width:82%; }
  .bubble-row.user .bubble-wrap { align-items:flex-end; }
  .bubble-user { background:#0a68ff; color:white; padding:9px 13px;
    border-radius:16px 16px 4px 16px; font-size:0.88rem; line-height:1.45; word-break:break-word; }
  .bubble-bot  { background:#fff; border:1px solid #eee; box-shadow:0 1px 3px rgba(0,0,0,.06);
    padding:9px 13px; border-radius:16px 16px 16px 4px; font-size:0.88rem; line-height:1.55; word-break:break-word; }
  .bubble-bot p { margin:0 0 6px 0; } .bubble-bot p:last-child { margin:0; }
  .bubble-bot ul { margin:4px 0 4px 16px; padding:0; } .bubble-bot li { margin:2px 0; }
  .bubble-bot strong { color:#c62828; }
  .bubble-ts { font-size:10px; color:#bbb; margin-top:2px; padding:0 4px; }
  .bubble-suggest { display:flex; flex-wrap:wrap; gap:5px; margin-top:8px; }
  .bubble-suggest button { background:#fff0f0; border:1px solid #ffcdd2; color:#c62828;
    border-radius:12px; padding:4px 10px; font-size:11px; cursor:pointer;
    transition:background .15s; font-family:inherit; }
  .bubble-suggest button:hover { background:#ffcdd2; }
  .typing-bubble { display:flex; gap:4px; padding:10px 14px; align-items:center; }
  .typing-dot { width:7px; height:7px; border-radius:50%; background:#ccc;
    animation:tdot 1.2s infinite ease-in-out; }
  .typing-dot:nth-child(2) { animation-delay:.2s; }
  .typing-dot:nth-child(3) { animation-delay:.4s; }
  @keyframes tdot { 0%,60%,100%{transform:translateY(0);background:#d1c4d8} 30%{transform:translateY(-6px);background:var(--primary,#2e7d32)} }
  .chat-warning { background:rgba(245,158,11,0.1); border-left:3px solid #f59e0b; padding:7px 10px;
    border-radius:8px; font-size:12px; color:#d97706; margin-top:6px; }
  .chat-safe    { background:rgba(34,197,94,0.1); border-left:3px solid #22c55e; padding:7px 10px;
    border-radius:8px; font-size:12px; color:#16a34a; margin-top:6px; }
`;
document.head.appendChild(chatStyle);

/* ── CONVERSATIONAL STATE ── */
const CHAT_LS_KEY = 'bacsi_ai_history_v3';
let chatCtx = {
  turns: [],          // [{role:'user'|'bot', text, ts}]
  vitals: {},         // hr, temp, spo2, stress — cập nhật từ Firebase hoặc user nhập
  askedFor: {},       // theo dõi AI đã hỏi gì rồi (hr, temp, spo2)
  lastTopic: null,    // chủ đề cuộc trò chuyện gần nhất
  sessionStart: Date.now(),
};

/* Load lịch sử gần nhất (tối đa 30 turns) */
function chatLoadHistory() {
  try {
    const saved = JSON.parse(localStorage.getItem(CHAT_LS_KEY) || '[]');
    // Chỉ dùng lại session trong 2 giờ
    if (saved.length && saved[saved.length-1]?.ts > Date.now() - 7200000) {
      chatCtx.turns = saved.slice(-30);
    }
  } catch(e) {}
}
function chatSaveHistory() {
  try { localStorage.setItem(CHAT_LS_KEY, JSON.stringify(chatCtx.turns.slice(-50))); } catch(e) {}
}

/* ── UI HELPERS ── */
function chatTs() {
  const d = new Date();
  return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}

function addMsg(text, type='bot', suggests=[]) {
  const row = document.createElement('div');
  row.className = 'bubble-row ' + (type === 'user' ? 'user' : 'bot');

  const avatar = document.createElement('div');
  avatar.className = 'bubble-avatar';
  avatar.textContent = type === 'user' ? '👤' : '🩺';

  const wrap = document.createElement('div');
  wrap.className = 'bubble-wrap';

  const bubble = document.createElement('div');
  bubble.className = type === 'user' ? 'bubble-user' : 'bubble-bot';

  if (type === 'bot') {
    // Render markdown an toàn
    try { bubble.innerHTML = marked.parse(text); } catch(e) { bubble.textContent = text; }
  } else {
    bubble.textContent = text;
  }

  const ts = document.createElement('div');
  ts.className = 'bubble-ts';
  ts.textContent = chatTs();

  wrap.appendChild(bubble);
  wrap.appendChild(ts);

  // Gợi ý nhanh
  if (suggests.length) {
    const sgDiv = document.createElement('div');
    sgDiv.className = 'bubble-suggest';
    suggests.forEach(s => {
      const btn = document.createElement('button');
      btn.textContent = s;
      btn.onclick = () => { chatInput.value = s; sendMessage(); };
      sgDiv.appendChild(btn);
    });
    wrap.appendChild(sgDiv);
  }

  row.appendChild(avatar);
  row.appendChild(wrap);
  chatbox.appendChild(row);
  requestAnimationFrame(() => { chatbox.scrollTop = chatbox.scrollHeight; });
  return row;
}

function showTyping() {
  const row = document.createElement('div');
  row.className = 'bubble-row bot';
  row.id = 'chat-typing';
  row.innerHTML = `<div class="bubble-avatar">🩺</div>
    <div class="bubble-bot typing-bubble">
      <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
    </div>`;
  chatbox.appendChild(row);
  chatbox.scrollTop = chatbox.scrollHeight;
  return row;
}

/* ── LẤY VITALS THỜI GIAN THỰC TỪ DASHBOARD ── */
function getLiveVitals() {
  /* Primary: HealthStore (Single Source of Truth) */
  if (window.HealthStore) {
    const s = HealthStore.get();
    if (s.hr)   chatCtx.vitals.hr   = s.hr;
    if (s.spo2) chatCtx.vitals.spo2 = s.spo2;
    if (s.temp) chatCtx.vitals.temp = s.temp;
    if (s.stress !== null) chatCtx.vitals.stress = s.stress;
    return;
  }
  /* Fallback: read DOM if store not available */
  const hr   = parseFloat(document.getElementById('heartVal')?.textContent) || 0;
  const spo2 = parseFloat(document.getElementById('spoVal')?.textContent)   || 0;
  const temp = parseFloat(document.getElementById('tmpVal')?.textContent)   || 0;
  if (hr > 20)   chatCtx.vitals.hr   = hr;
  if (spo2 > 50) chatCtx.vitals.spo2 = spo2;
  if (temp > 30) chatCtx.vitals.temp = temp;
}

/* ── TRÍCH XUẤT SỐ LIỆU TỪ TIN NHẮN USER ── */
function extractVitalsFromText(text) {
  const t = text.toLowerCase();
  const patch = {};
  // Nhịp tim: "nhịp tim 85", "85 bpm", "mạch 90"
  const hrM = t.match(/(?:nhịp tim|nhịp|mạch|heart rate|hr|bpm)[^\d]*(\d{2,3})|(\d{2,3})\s*bpm/);
  if (hrM) { const v=parseInt(hrM[1]||hrM[2]); chatCtx.vitals.hr=v; patch.hr=v; }

  // SpO2: "spo2 97", "oxy 95%", "98%"
  const spM = t.match(/(?:spo2?|oxy(?:gen)?)[^\d]*(\d{2,3})|(\d{2,3})\s*%/);
  if (spM) { const v=parseInt(spM[1]||spM[2]); chatCtx.vitals.spo2=v; patch.spo2=v; }

  // Nhiệt độ: "37.5 độ", "sốt 38", "nhiệt độ 36.8"
  const tpM = t.match(/(?:nhiệt(?:\s*độ)?|sốt|temp)[^\d]*(\d{2}(?:[.,]\d)?)|(\d{2}[.,]\d)\s*°?c?/);
  if (tpM) { const v=parseFloat((tpM[1]||tpM[2]).replace(',','.')); chatCtx.vitals.temp=v; patch.temp=v; }

  /* Propagate extracted vitals to HealthStore */
  if (window.HealthStore && Object.keys(patch).length) HealthStore.set(patch, 'chat');
}

/* ── PHÂN LOẠI INTENT USER ── */
function detectIntent(text) {
  const t = text.toLowerCase();
  const intents = [
    { name:'emergency',   keys:['cấp cứu','gọi 115','nguy kịch','hôn mê','co giật','ngưng thở','đột quỵ','nhồi máu','đau ngực dữ'] },
    { name:'fever',       keys:['sốt','nóng người','ớn lạnh','nhiệt độ cao'] },
    { name:'heart',       keys:['nhịp tim','tim đập','hồi hộp','loạn nhịp','mạch nhanh','mạch chậm','đau ngực'] },
    { name:'breathing',   keys:['khó thở','thở khó','tức ngực','thiếu oxy','spo2','hụt hơi'] },
    { name:'headache',    keys:['đau đầu','chóng mặt','hoa mắt','nhức đầu','đau nửa đầu'] },
    { name:'digestion',   keys:['đau bụng','buồn nôn','nôn','tiêu chảy','táo bón','đầy bụng'] },
    { name:'stress',      keys:['stress','căng thẳng','lo âu','mất ngủ','trầm cảm','mệt mỏi','kiệt sức'] },
    { name:'firstaid',    keys:['sơ cứu','cầm máu','gãy xương','bỏng','nghẹn','hóc'] },
    { name:'bp',          keys:['huyết áp','blood pressure','tăng huyết áp','cao huyết áp'] },
    { name:'greet',       keys:['xin chào','hello','hi','chào','bắt đầu'] },
    { name:'thanks',      keys:['cảm ơn','thank','oke','ok','hiểu rồi','được rồi'] },
    { name:'vitals_ok',   keys:['ổn','bình thường','không sao','tốt','khỏe'] },
    { name:'ask_more',    keys:['tại sao','vì sao','như thế nào','giải thích','thêm','chi tiết'] },
  ];
  for (const {name, keys} of intents) {
    if (keys.some(k => t.includes(k))) return name;
  }
  return 'general';
}

/* ── AI ENGINE NỘI BỘ — Conversational Response Generator ── */
function buildVitalSummary() {
  const v = chatCtx.vitals;
  const parts = [];
  if (v.hr)   parts.push(`nhịp tim **${v.hr} bpm**`);
  if (v.temp) parts.push(`nhiệt độ **${v.temp}°C**`);
  if (v.spo2) parts.push(`SpO₂ **${v.spo2}%**`);
  return parts.length ? 'Tôi thấy chỉ số của bạn: ' + parts.join(', ') + '. ' : '';
}

function getMissingVitals() {
  const v = chatCtx.vitals;
  const missing = [];
  if (!v.hr)   missing.push('nhịp tim (bpm)');
  if (!v.spo2) missing.push('SpO₂ (%)');
  if (!v.temp) missing.push('nhiệt độ (°C)');
  return missing;
}

function assessVitalRisk() {
  const v = chatCtx.vitals;
  const warns = [];
  if (v.hr) {
    if (v.hr < 40 || v.hr > 130) warns.push({ level:'high', msg:`Nhịp tim ${v.hr} bpm — bất thường nghiêm trọng!` });
    else if (v.hr < 50 || v.hr > 110) warns.push({ level:'medium', msg:`Nhịp tim ${v.hr} bpm — hơi bất thường, cần chú ý.` });
  }
  if (v.temp) {
    if (v.temp > 40) warns.push({ level:'high', msg:`Sốt ${v.temp}°C — rất cao, cần đến viện!` });
    else if (v.temp > 38.5) warns.push({ level:'medium', msg:`Sốt ${v.temp}°C — sốt vừa-cao, theo dõi sát.` });
  }
  if (v.spo2) {
    if (v.spo2 < 90) warns.push({ level:'high', msg:`SpO₂ ${v.spo2}% — nguy hiểm, cần thở oxy!` });
    else if (v.spo2 < 94) warns.push({ level:'medium', msg:`SpO₂ ${v.spo2}% — thấp hơn bình thường.` });
  }
  return warns;
}

/* Kho phản hồi hội thoại theo intent */
const CHAT_RESPONSES = {
  emergency: {
    reply: `🚨 **ĐÂY LÀ TÌNH HUỐNG KHẨN CẤP!**\n\n**Gọi 115 NGAY BÂY GIỜ** — đừng chờ đợi.\n\nTrong khi chờ:\n- Để bệnh nhân nằm ngửa, đầu hơi ngửa ra\n- Nới lỏng quần áo\n- Nếu ngưng thở: bắt đầu CPR (30 lần ép ngực)\n- Không cho ăn uống gì`,
    suggests: ['Hướng dẫn CPR', 'Dấu hiệu đột quỵ'],
    risk: 'high'
  },
  fever: (v) => {
    const t = v.temp;
    if (!t) return {
      reply: `Tôi hiểu bạn đang bị sốt. Bạn có đo nhiệt độ chưa? Nếu có, cho tôi biết con số để tư vấn chính xác hơn nhé. 🌡️`,
      suggests: ['Sốt 38 độ', 'Sốt 39 độ', 'Chưa đo nhiệt độ'],
    };
    if (t > 40) return {
      reply: `${buildVitalSummary()}\n⚠️ **Sốt ${t}°C — rất cao, cần đến bệnh viện ngay!**\n\nTrước khi đến viện:\n- Dùng paracetamol đúng liều\n- Lau người bằng khăn ấm (không lạnh)\n- Uống nhiều nước\n- **Gọi 115 nếu có co giật hoặc lơ mơ**`,
      suggests: ['Liều paracetamol bao nhiêu?', 'Có cần nhập viện không?'],
      risk: 'high'
    };
    if (t > 38.5) return {
      reply: `${buildVitalSummary()}\nSốt **${t}°C** — sốt vừa, cần theo dõi sát. 🌡️\n\n**Làm ngay:**\n- Uống paracetamol 500mg (nếu >50kg) mỗi 4–6 giờ\n- Uống ít nhất 2–3 lít nước/ngày\n- Mặc quần áo thoáng, không đắp chăn dày\n- Đo lại sau 1 giờ\n\nNếu sốt kèm **cứng cổ, phát ban, khó thở** → đến viện ngay.`,
      suggests: ['Sốt bao lâu rồi?', 'Có triệu chứng nào khác không?'],
    };
    return {
      reply: `Sốt nhẹ **${t}°C** — cơ thể đang chống lại vi khuẩn/virus. Đây là phản ứng bình thường nếu dưới 38.5°C.\n\n✅ **Việc cần làm:**\n- Nghỉ ngơi, uống nhiều nước\n- Có thể dùng paracetamol nếu khó chịu\n- Theo dõi nhiệt độ mỗi 4 giờ\n\nBạn có triệu chứng nào khác kèm theo không (ho, đau họng, mệt mỏi)?`,
      suggests: ['Có ho thêm', 'Đau đầu thêm', 'Chỉ sốt thôi'],
    };
  },
  heart: (v) => {
    const hr = v.hr;
    if (!hr) return {
      reply: `Bạn đang cảm thấy tim đập bất thường? Mô tả thêm cho tôi nghe nhé:\n- Tim đập **nhanh** hay **chậm** hay **loạn**?\n- Cảm giác này kéo dài bao lâu?\n- Kèm theo chóng mặt hay đau ngực không?`,
      suggests: ['Tim đập nhanh', 'Tim đập loạn', 'Đau tức ngực'],
    };
    const warns = assessVitalRisk().filter(w => w.msg.includes('nhịp'));
    if (warns.length && warns[0].level === 'high') return {
      reply: `⚠️ **${warns[0].msg}**\n\nNhịp tim bình thường khi nghỉ ngơi là **60–100 bpm**. Con số của bạn cần được đánh giá y tế ngay.\n\n**Làm ngay:**\n- Ngồi hoặc nằm xuống, thở chậm\n- Đừng gắng sức\n- Nếu kèm đau ngực/khó thở → **gọi 115**`,
      suggests: ['Gọi 115', 'Tôi không đau ngực'],
      risk: 'high'
    };
    return {
      reply: `${buildVitalSummary()}\nNhịp tim của bạn trong ngưỡng cần chú ý. 💓\n\nMột số nguyên nhân thường gặp: **stress, thiếu ngủ, mất nước, caffeine nhiều**.\n\n**Thử ngay:** Ngồi yên, thở sâu 4 giây – giữ 4 giây – thở ra 6 giây. Lặp lại 5 lần.\n\nBạn có đang căng thẳng hoặc vừa vận động mạnh không?`,
      suggests: ['Vừa tập thể dục', 'Đang căng thẳng', 'Không vận động gì'],
    };
  },
  breathing: (v) => {
    const sp = v.spo2;
    if (sp && sp < 90) return {
      reply: `🚨 **SpO₂ ${sp}% — rất nguy hiểm!**\n\nMức này cho thấy thiếu oxy nghiêm trọng.\n\n**LÀM NGAY:**\n1. Ngồi thẳng hoặc hơi ngả về phía trước\n2. Hít thở sâu, chậm qua mũi\n3. Gọi 115 hoặc đến cấp cứu ngay\n4. Nếu có bình oxy — dùng ngay`,
      suggests: ['Gọi 115 ngay'],
      risk: 'high'
    };
    return {
      reply: `${buildVitalSummary() || ''}\nKhó thở có thể do nhiều nguyên nhân. Bạn mô tả rõ hơn được không:\n- Khó thở **khi nằm** hay **khi đi lại**?\n- Có tiếng rít hoặc khò khè không?\n- Bắt đầu từ khi nào?`,
      suggests: ['Khó thở khi nằm', 'Có tiếng khò khè', 'Khó thở cả ngày'],
    };
  },
  headache: () => ({
    reply: `Đau đầu bạn đang gặp — tôi muốn hiểu rõ hơn:\n\n- **Đau ở đâu?** (thái dương, sau gáy, toàn đầu)\n- **Kiểu đau?** (nhói, âm ỉ, đập theo nhịp tim)\n- **Bao lâu rồi?** Kèm theo buồn nôn/nhìn mờ không?\n\n⚠️ Đau đầu **đột ngột dữ dội** kèm cứng cổ hoặc nhìn đôi → đến viện ngay (có thể là dấu hiệu đột quỵ/xuất huyết não).`,
    suggests: ['Đau thái dương', 'Đau sau gáy', 'Đau đầu + buồn nôn'],
  }),
  digestion: () => ({
    reply: `Vấn đề tiêu hóa rất hay gặp. Để tư vấn đúng, bạn cho biết thêm:\n\n- Đau bụng **ở vùng nào**? (trên rốn, dưới rốn, hai bên)\n- Kèm theo **buồn nôn, nôn, tiêu chảy** không?\n- Gần đây ăn gì lạ không?\n- Đau **liên tục** hay **từng cơn**?`,
    suggests: ['Đau thượng vị', 'Tiêu chảy nhiều lần', 'Buồn nôn không nôn được'],
  }),
  stress: () => ({
    reply: `Stress và căng thẳng ảnh hưởng rất nhiều đến sức khỏe thể chất đấy. 🧘\n\n${buildVitalSummary()}\n\n**Ngay bây giờ**, thử kỹ thuật thở này:\n> Hít vào **4 giây** → Giữ **4 giây** → Thở ra **6 giây**\n\nLặp 5 lần, bạn sẽ thấy nhịp tim chậm lại rõ rệt.\n\nBạn đang gặp vấn đề gì cụ thể — áp lực công việc, mất ngủ, hay lo âu kéo dài?`,
    suggests: ['Mất ngủ nhiều ngày', 'Lo lắng không rõ nguyên nhân', 'Mệt mỏi toàn thân'],
  }),
  bp: () => ({
    reply: `**Huyết áp** — chỉ số quan trọng cần theo dõi. 💉\n\nThang phân loại:\n- ✅ Bình thường: **dưới 120/80 mmHg**\n- ⚠️ Cao nhẹ: 130–139/80–89\n- 🔴 Tăng huyết áp: **≥140/90**\n- 🚨 Khủng hoảng: **≥180/120** → Gọi 115 ngay\n\nBạn đang đo được bao nhiêu? Hoặc có triệu chứng gì liên quan (đau đầu gáy, hoa mắt)?`,
    suggests: ['Huyết áp 150/90', 'Đau đầu gáy', 'Chóng mặt'],
  }),
  firstaid: () => ({
    reply: `Sơ cứu đúng cách có thể cứu sống! 🩹\n\nBạn cần xử lý tình huống nào cụ thể?`,
    suggests: ['Cầm máu vết thương', 'Sơ cứu bỏng', 'Nghẹn hóc dị vật', 'CPR ngưng tim'],
  }),
  greet: () => ({
    reply: `Xin chào! Tôi là **Bác sĩ AI 24/7** 🩺\n\nTôi có thể giúp bạn:\n- Tư vấn triệu chứng và bệnh lý thường gặp\n- Đọc và giải thích chỉ số sinh lý (nhịp tim, SpO₂, nhiệt độ)\n- Hướng dẫn sơ cứu khẩn cấp\n- Gợi ý khi nào cần đến viện\n\nBạn đang có vấn đề sức khỏe gì muốn hỏi?`,
    suggests: ['Tôi đang bị sốt', 'Tim đập bất thường', 'Khó thở', 'Đau đầu'],
  }),
  thanks: () => ({
    reply: `Không có gì! Nếu triệu chứng thay đổi hoặc bạn cần tư vấn thêm, cứ hỏi tôi nhé. 💙\n\nNhớ: nếu tình trạng trở nặng, **đừng ngại gọi 115** — sức khỏe là trên hết!`,
    suggests: ['Hỏi thêm về sức khỏe', 'Kiểm tra chỉ số hiện tại'],
  }),
  vitals_ok: () => {
    const v = buildVitalSummary();
    return {
      reply: v
        ? `${v}\nCác chỉ số trông khá ổn! ✅ Tiếp tục duy trì nhé.\n\nBạn có muốn tôi phân tích chi tiết hơn về bất kỳ chỉ số nào không?`
        : `Nghe vậy là tốt! 😊 Nếu bạn muốn kiểm tra chính xác hơn, hãy đo nhịp tim, SpO₂ và nhiệt độ rồi cho tôi biết nhé.`,
      suggests: ['Phân tích nhịp tim', 'Kiểm tra SpO₂'],
    };
  },
  ask_more: () => ({
    reply: `Bạn muốn tìm hiểu thêm về chủ đề nào?\n\nTôi có thể giải thích chi tiết về:\n- Cơ chế bệnh và nguyên nhân\n- Cách đọc chỉ số sinh lý\n- Thuốc thường dùng và liều lượng\n- Khi nào cần đi khám khẩn\n\nCứ hỏi cụ thể nhé!`,
    suggests: ['Giải thích về nhịp tim', 'Khi nào cần gọi 115?'],
  }),
};

/* Fallback thông minh khi không khớp intent */
function generalFallback(userText) {
  const v = buildVitalSummary();
  const missing = getMissingVitals();
  const warns = assessVitalRisk();

  // Nếu có cảnh báo vitals → ưu tiên hiển thị
  if (warns.length > 0) {
    const highWarns = warns.filter(w => w.level === 'high');
    if (highWarns.length) {
      return {
        reply: `⚠️ **Chú ý!** ${highWarns.map(w => w.msg).join(' ')}\n\n${v}\nTrong khi chờ đánh giá, hãy nghỉ ngơi và tránh gắng sức. Bạn đang cảm thấy thế nào?`,
        suggests: ['Đang cảm thấy ổn', 'Có thêm triệu chứng', 'Cần gọi 115?'],
        risk: 'high'
      };
    }
  }

  // Nếu thiếu vitals và chưa hỏi
  if (missing.length === 3 && !chatCtx.askedFor.vitals) {
    chatCtx.askedFor.vitals = true;
    return {
      reply: `Tôi nghe bạn rồi. Để tư vấn chính xác nhất, bạn có thể cho tôi biết thêm:\n\n- **Triệu chứng chính** bạn đang gặp là gì?\n- Bắt đầu từ khi nào?\n- Bạn có thiết bị đo nhịp tim / SpO₂ không?\n\nCứ mô tả tự nhiên, tôi sẽ lắng nghe.`,
      suggests: ['Tôi bị sốt', 'Tim đập nhanh', 'Khó thở', 'Đau đầu'],
    };
  }

  return {
    reply: `${v ? v + '\n' : ''}Tôi hiểu bạn đang quan tâm đến: **"${userText.slice(0,50)}"**.\n\nBạn có thể mô tả chi tiết hơn:\n- Triệu chứng bắt đầu từ khi nào?\n- Có yếu tố nào làm nặng hơn hoặc nhẹ hơn không?\n- Bạn đã làm gì để cải thiện chưa?\n\n💡 Nếu có bất kỳ triệu chứng nguy hiểm nào, **gọi 115** là lựa chọn tốt nhất.`,
    suggests: ['Triệu chứng mới xuất hiện', 'Đã uống thuốc rồi', 'Cần đi khám không?'],
  };
}

/* ── ENGINE CHÍNH ── */
function conversationalAI(userText) {
  getLiveVitals();
  extractVitalsFromText(userText);

  const intent = detectIntent(userText);
  chatCtx.lastTopic = intent;

  const respFn = CHAT_RESPONSES[intent];
  if (!respFn) return generalFallback(userText);

  // respFn có thể là object hoặc function(vitals)
  const resp = typeof respFn === 'function' ? respFn(chatCtx.vitals) : respFn;
  return resp || generalFallback(userText);
}

/* ── SEND MESSAGE ── */
let _chatSending = false;
async function sendMessage() {
  if (_chatSending) return;
  const q = chatInput.value.trim();
  if (!q) return;
  _chatSending = true;

  chatInput.value = '';
  chatInput.disabled = true;
  sendBtn.disabled = true;

  // Lưu turn user
  chatCtx.turns.push({ role:'user', text:q, ts: Date.now() });
  addMsg(q, 'user');

  const typingEl = showTyping();

  // Typing delay tự nhiên (nhanh hơn — chỉ thị giác)
  const delay = 400 + Math.min(q.length * 15, 1000);
  await new Promise(r => setTimeout(r, delay));

  typingEl.remove();

  // Sinh phản hồi
  const resp = conversationalAI(q);
  chatCtx.turns.push({ role:'bot', text:resp.reply, ts: Date.now() });
  chatSaveHistory();

  addMsg(resp.reply, 'bot', resp.suggests || []);

  // Hiển thị cảnh báo nếu có
  if (resp.risk === 'high') {
    const lastBubble = chatbox.querySelector('.bubble-row.bot:last-child .bubble-bot');
    if (lastBubble) {
      const warn = document.createElement('div');
      warn.className = 'chat-warning';
      warn.innerHTML = '📞 <strong>Tình trạng nghiêm trọng:</strong> Gọi 115 hoặc đến cơ sở y tế gần nhất ngay.';
      lastBubble.appendChild(warn);
    }
  }

  chatInput.disabled = false;
  sendBtn.disabled = false;
  chatInput.focus();
  _chatSending = false;
}

/* ── KHỞI ĐỘNG ── */
chatLoadHistory();

if (chatCtx.turns.length > 0) {
  // Khôi phục lịch sử session
  chatbox.innerHTML = '';
  chatCtx.turns.slice(-10).forEach(t => {
    addMsg(t.text, t.role === 'user' ? 'user' : 'bot');
  });
  addMsg('Tôi nhớ cuộc trò chuyện trước của chúng ta. Bạn cần tư vấn thêm không? 💙', 'bot',
    ['Hỏi triệu chứng mới', 'Xem chỉ số hiện tại']);
} else {
  // Lần đầu vào
  chatbox.innerHTML = '';
  addMsg(`Xin chào! Tôi là **Bác sĩ AI 24/7** 🩺\n\nTôi có thể tư vấn về triệu chứng, đọc chỉ số sinh lý, và hướng dẫn sơ cứu. Hãy mô tả tự nhiên — không cần điền form!\n\n*Lưu ý: Đây là hỗ trợ thông tin, không thay thế bác sĩ thực tế.*`, 'bot',
    ['Tôi đang bị sốt', 'Tim đập bất thường', 'Khó thở', 'Đau đầu']);
}

sendBtn.onclick = sendMessage;
chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(); });

/* ── HealthStore subscriber: CHỈ cập nhật sync badge, KHÔNG auto-fill input ──
   Fix: subscriber cũ tự điền ha-hr, ha-temp, nkai-temp... mỗi khi HealthStore.set()
   được gọi (kể cả khi chỉ cập nhật nhiệt độ từ tempSimInput). Điều này gây ra
   tình trạng nhịp tim, SpO2 tự thay đổi theo nhiệt độ. */
if(window.HealthStore){
  HealthStore.subscribe(function(s){
    /* Chỉ hiển thị sync badge — KHÔNG fill bất kỳ input nào */
    if(s.source && s.source !== 'auto_fill'){
      const badges = document.querySelectorAll('.hs-sync-badge');
      badges.forEach(function(b){
        b.textContent = '✓ Đồng bộ từ ' + ({iot:'IoT',ha_form:'Phân tích',nkai_form:'Nhật ký',chat:'Chat'}[s.source]||s.source);
        b.style.opacity='1';
        clearTimeout(b._t);
        b._t = setTimeout(function(){ b.style.opacity='0'; }, 3000);
      });
    }
  });
}

/* ── Clear button ── */
const chatClearBtn = document.getElementById('chat-clear-btn');
if(chatClearBtn){
  chatClearBtn.onclick = () => {
    if(!confirm('Xóa toàn bộ lịch sử hội thoại?')) return;
    chatCtx.turns = [];
    chatCtx.vitals = {};
    chatCtx.askedFor = {};
    chatCtx.lastTopic = null;
    localStorage.removeItem(CHAT_LS_KEY);
    chatbox.innerHTML = '';
    const h = new Date().getHours();
    const time = h < 11 ? 'buổi sáng' : h < 13 ? 'buổi trưa' : h < 18 ? 'buổi chiều' : 'buổi tối';
    addMsg(`Chào ${time}! Cuộc trò chuyện mới bắt đầu. Tôi có thể giúp gì cho bạn? 🩺`, 'bot',
      ['Tôi đang bị sốt', 'Tim đập bất thường', 'Khó thở', 'Đau đầu']);
  };
}

</script>

<!-- Firebase module -->
<script type="module">
    import{initializeApp}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import{getDatabase,ref,onValue}from"https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    const cfg={apiKey:"AIzaSyAgGaoKNCMnDq12YzmvcQjWcRKS6MaOlvk",authDomain:"khkt-d0093.firebaseapp.com",databaseURL:"https://khkt-d0093-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"khkt-d0093",storageBucket:"khkt-d0093.firebasestorage.app",messagingSenderId:"764464014392",appId:"1:764464014392:web:ed5283f0fd22a65140b2cd"};
    const hEl=document.getElementById('heartVal'),sEl=document.getElementById('spoVal'),tEl=document.getElementById('tmpVal'),stEl=document.getElementById('healthStatus');
    /* upd(p, fromIoT): cập nhật display #heartVal/#spoVal/#tmpVal.
       fromIoT=true → chỉ push vào HealthStore khi dữ liệu từ Firebase thật.
       fromIoT=false (fallback random) → CHỈ hiển thị, KHÔNG push vào HealthStore.
       Fix: trước đây fallback() push random vào HealthStore → subscriber fill vào
       ha-hr, nkai-temp... gây các chỉ số khác tự thay đổi theo nhiệt độ giả lập. */
    function upd(p, fromIoT){
        const hr=Number(p?.heart)||0,sp=Number(p?.spo2)||0,tp=Number(p?.temp)||NaN;
        hEl.textContent=hr||'--';sEl.textContent=sp||'--';tEl.textContent=isNaN(tp)?'--':tp.toFixed(1);
        const a=[];if(hr<60||hr>110)a.push('hr');if(sp<95)a.push('sp');if(tp<36||tp>38)a.push('tp');
        if(a.length===0){stEl.textContent='Tốt';stEl.className='text-success fw-bold';}
        else if(a.length===1){stEl.textContent='Bình thường';stEl.className='text-warning fw-bold';}
        else{stEl.textContent='CẢNH BÁO!';stEl.className='text-danger fw-bold';}
        /* Chỉ sync vào HealthStore khi là dữ liệu IoT thật — KHÔNG sync dữ liệu random fallback */
        if(fromIoT && window.HealthStore){
            const patch={};
            if(hr>20)  patch.hr   = hr;
            if(sp>50)  patch.spo2 = sp;
            if(!isNaN(tp)&&tp>30) patch.temp = tp;
            if(Object.keys(patch).length) HealthStore.set(patch,'iot');
        }
    }
    let conn=false,iv=null,lh=72,ls=98,lt=37;
    function fallback(){
        /* Fallback hiển thị random để UI không trống — KHÔNG push vào HealthStore (fromIoT=false) */
        if(iv)return;lh=70+Math.floor(Math.random()*30);ls=95+Math.floor(Math.random()*5);lt=36.5+Math.round(Math.random()*10)/10;
        upd({heart:lh,spo2:ls,temp:parseFloat(lt.toFixed(1))}, false);
        iv=setInterval(()=>{if(conn){clearInterval(iv);iv=null;return;}
            lh=Math.max(78,Math.min(97,lh+(Math.random()>.5?1:-1)*Math.floor(Math.random()*2+.5)));
            ls=Math.max(95,Math.min(100,ls+(Math.random()>.5?1:-1)*Math.floor(Math.random()*1.5)));
            lt=parseFloat(Math.max(36.5,Math.min(37.5,lt+(Math.random()>.5?1:-1)*(Math.random()*.1))).toFixed(1));
            upd({heart:lh,spo2:ls,temp:lt}, false);},5000);
    }
    try{
        const app=initializeApp(cfg);const db=getDatabase(app);const dr=ref(db,'devices/esp32/latest');
        /* Firebase thật → fromIoT=true */
        onValue(dr,snap=>{const v=snap.val();if(v){conn=true;upd(v,true);}else if(!conn)fallback();},(e)=>{console.warn(e);fallback();});
        setTimeout(()=>{if(!conn)fallback();},2500);
    }catch(e){console.warn(e);fallback();}
</script>

<!-- HEALTH ANALYZER JS -->
<script>
/* ================================================================
   🤖 INTERNAL AI ENGINE — HealthScoreAI v2.0
   ================================================================
   Hoạt động hoàn toàn OFFLINE, không cần API key, không CORS.
   Logic: Clinical Scoring System với 6 chiều phân tích.

   Luồng chính:
   1. haRun()          → thu thập input, kích hoạt engine
   2. haRunEngine()    → gọi window.claude (nếu có) hoặc fallback
   3. internalAI()     → scoring engine nội bộ thuần JS
   4. haDraw()         → render kết quả ra UI
   ================================================================ */

/* ═══════════════════════════════════════════════════════
   PERFORMANCE OPTIMIZATIONS (v2):
   ✓ haRun chỉ trigger qua click — không có realtime/input listener
   ✓ Loading steps animation chạy song song bằng setTimeout (không await)
   ✓ Debounce guard _haRunning chặn double-click
   ✓ requestAnimationFrame cho scroll + bar animation (không setTimeout)
   ✓ localStorage giới hạn 50 entries
   ✓ will-change: transform trên spinner + pulse để GPU composite
   ✓ ha-fade giảm từ 0.4s → 0.25s
   ═══════════════════════════════════════════════════════ */
/* healthState được khai báo duy nhất ở SYNC ENGINE cuối file */

let haEmo='';
document.querySelectorAll('.ha-epill').forEach(p=>{
    p.addEventListener('click',()=>{
        document.querySelectorAll('.ha-epill').forEach(x=>x.classList.remove('sel'));
        p.classList.add('sel');haEmo=p.dataset.val;
        /* Write emotion/stress to HealthStore */
        if(window.HealthStore){
            const emoStressMap={normal:3,tired:5,sad:5,anxious:7,stress:8,pain:9};
            const sv=emoStressMap[p.dataset.val]||5;
            HealthStore.set({stress:sv},'ha_emotion');
        }
    });
});

/* ──────────────────────────────────────────────────────────────
   BƯỚC 1: Thu thập input và khởi động phân tích
   ────────────────────────────────────────────────────────────── */
/* ── DEBOUNCE GUARD: tránh double-click spam ── */
let _haRunning = false;

async function haRun(){
    if(_haRunning) return; // chặn gọi lại khi đang chạy
    _haRunning = true;

    /* Đọc từ healthState (nguồn duy nhất) — đã được sync realtime qua data-key */
    const hr   = parseFloat(window.healthState.heartRate)   || parseFloat(document.getElementById('ha-hr').value);
    const temp = parseFloat(window.healthState.temperature) || parseFloat(document.getElementById('ha-temp').value);
    const spo2 = parseFloat(window.healthState.spo2)        || parseFloat(document.getElementById('ha-spo2').value);
    const sym  = document.getElementById('ha-sym').value.trim()  || '';
    const hist = document.getElementById('ha-hist').value.trim() || '';
    const emo  = haEmo || 'normal';

    if(!hr||!temp||!spo2){haErr('Vui lòng điền đầy đủ Nhịp Tim, Nhiệt Độ và SpO₂.');_haRunning=false;return;}

    /* ✔ Gán vào healthState — nguồn duy nhất cho toàn bộ phân tích */
    window.healthState.heartRate    = hr;
    window.healthState.temperature  = temp;
    window.healthState.spo2         = spo2;

    /* ✔ Cập nhật theme từ healthState — chỉ gọi 1 lần tại đây */
    if(window.updateThemeByTemperature) updateThemeByTemperature(window.healthState.temperature);

    /* Ghi vào HealthStore để badge đồng bộ — không dùng để fill input */
    if(window.HealthStore) HealthStore.set({hr,temp,spo2},'ha_form');

    haClearErr();
    document.getElementById('ha-out').style.display='none';
    haLoad(true); haBtn(true);

    /* Chạy animation steps song song (không block engine) — giảm delay từ ~3.5s xuống ~0ms */
    const stepDelay = 220;
    for(let i=1;i<=5;i++){
        setTimeout(()=>{const el=document.getElementById('hs'+i);if(el)el.classList.add('done');}, stepDelay*i);
    }

    try {
        /* Check AI cache first — skip re-analysis if vitals unchanged */
        const cached = window.HealthStore ? HealthStore.getAICache() : null;
        let result;
        if(cached && !sym && !hist){
            haLoad(false);
            result = haValidate(cached, hr, temp, spo2);
            /* Add cache note to flow */
            if(result.flow && result.flow.length) result.flow[0] += ' (cache)';
        } else {
            await new Promise(r=>requestAnimationFrame(()=>setTimeout(r,0)));
            const raw = await haRunEngine({hr, temp, spo2, emo, sym, hist});
            result    = haValidate(raw, hr, temp, spo2);
            haLoad(false);
        }
        haDraw(result, hr, temp, spo2);
    } catch(err) {
        haLoad(false);
        try {
            const fallback = haFallback(hr, temp, spo2);
            haDraw(fallback, hr, temp, spo2);
        } catch(e2) {
            haErr('Lỗi phân tích: ' + err.message);
        }
    }
    /* ✔ Lưu lịch sử vào localStorage — chỉ khi user bấm nút, không tự động */
    saveHaHistory();
    haBtn(false);
    _haRunning = false;
}

/* ──────────────────────────────────────────────────────────────
   VALIDATE: Đảm bảo object result luôn có đủ trường cần thiết.
   Nếu thiếu field nào → điền giá trị mặc định an toàn.
   ────────────────────────────────────────────────────────────── */
function haValidate(r, hr, temp, spo2) {
    // Nếu r không phải object → trả về fallback hoàn toàn
    if (!r || typeof r !== 'object') return haFallback(hr, temp, spo2);

    // Helper: safe string
    const s = (v, def) => (v && typeof v === 'string') ? v : def;
    // Helper: safe array
    const a = (v, def) => (Array.isArray(v) && v.length) ? v : def;

    // Vitals — đảm bảo mỗi chỉ số có status/label/note
    const safeVital = (v, name) => ({
        status: s(v?.status, 'ok'),
        label:  s(v?.label,  name),
        note:   s(v?.note,   'Chỉ số trong giới hạn tham chiếu.'),
    });

    const vitals = {
        heartRate:   safeVital(r.vitals?.heartRate,   'Nhịp Tim'),
        temperature: safeVital(r.vitals?.temperature, 'Nhiệt Độ'),
        spo2:        safeVital(r.vitals?.spo2,        'SpO₂'),
    };

    // Risk
    const risk = {
        level:       s(r.risk?.level,       'low'),
        score:       (typeof r.risk?.score === 'number') ? r.risk.score : 0,
        label:       s(r.risk?.label,       'Thấp'),
        explanation: s(r.risk?.explanation, 'Các chỉ số trong ngưỡng bình thường.'),
    };

    // Psychology
    const psychology = {
        stressLevel:         s(r.psychology?.stressLevel,         'Trạng thái tâm lý bình thường.'),
        physiologicalImpact: s(r.psychology?.physiologicalImpact, 'Không có tác động sinh lý đáng kể.'),
    };

    // Hypotheses
    const hypotheses = a(r.hypotheses, [
        { name: 'Trạng Thái Sinh Lý Bình Thường', reason: 'Không phát hiện bất thường rõ ràng.' },
    ]);

    // Flow
    const flow = a(r.flow, [
        `Đánh giá HR ${hr} bpm, SpO₂ ${spo2}%, Nhiệt độ ${temp}°C.`,
        'Các chỉ số trong ngưỡng tham chiếu.',
        'Không có dấu hiệu nguy cơ cấp.',
        'Khuyến nghị: duy trì thói quen lành mạnh.',
        'Theo dõi định kỳ và gọi 115 nếu có triệu chứng bất thường.',
    ]);

    // Measures
    const defMeasures = {
        immediate:      ['Nghỉ ngơi và uống đủ nước', 'Tránh gắng sức nếu mệt', 'Theo dõi triệu chứng'],
        homeMonitoring: ['Đo lại chỉ số sau 2–4 giờ', 'Ghi nhật ký sức khỏe', 'Ngủ đủ 7–8 giờ/đêm'],
        seeDoctor:      ['Đến khám nếu triệu chứng kéo dài >3 ngày', 'Đo điện tim nếu nhịp bất thường', 'Xét nghiệm máu định kỳ hàng năm'],
    };
    const measures = {
        immediate:      a(r.measures?.immediate,      defMeasures.immediate),
        homeMonitoring: a(r.measures?.homeMonitoring, defMeasures.homeMonitoring),
        seeDoctor:      a(r.measures?.seeDoctor,      defMeasures.seeDoctor),
    };

    // Healing
    const defHealing = {
        music:     'Nhạc piano thiền định 70–90 BPM',
        video:     'Video bài tập thở buổi sáng 10 phút',
        breathing: 'Thở bụng: hít sâu 6 giây, thở ra 6 giây',
        message:   'Chăm sóc bản thân là ưu tiên hàng đầu. Bạn đang làm rất tốt!',
    };
    const healing = {
        music:     s(r.healing?.music,     defHealing.music),
        video:     s(r.healing?.video,     defHealing.video),
        breathing: s(r.healing?.breathing, defHealing.breathing),
        message:   s(r.healing?.message,   defHealing.message),
    };

    return { vitals, risk, psychology, hypotheses, flow, measures, healing };
}

/* ──────────────────────────────────────────────────────────────
   FALLBACK: Object mặc định khi engine crash hoàn toàn.
   ────────────────────────────────────────────────────────────── */
function haFallback(hr, temp, spo2) {
    return haValidate({
        vitals: {
            heartRate:   { status: 'ok', label: 'Đã nhận', note: `Nhịp tim: ${hr} bpm` },
            temperature: { status: 'ok', label: 'Đã nhận', note: `Nhiệt độ: ${temp}°C` },
            spo2:        { status: 'ok', label: 'Đã nhận', note: `SpO₂: ${spo2}%` },
        },
        risk: { level: 'low', score: 0, label: 'Chưa tính được', explanation: 'Engine gặp lỗi, không thể tính điểm. Vui lòng thử lại.' },
        psychology:  { stressLevel: 'Không xác định được.', physiologicalImpact: 'Vui lòng thử lại.' },
        hypotheses:  [{ name: 'Không xác định', reason: 'Engine gặp lỗi khi phân tích.' }],
        flow:        ['Dữ liệu đã nhận.', 'Engine gặp lỗi khi xử lý.', 'Vui lòng kiểm tra lại chỉ số và thử lại.', 'Nếu vẫn lỗi, tải lại trang.', 'Gọi 115 nếu có triệu chứng nguy hiểm.'],
        measures:    null,
        healing:     null,
    }, hr, temp, spo2);
}

/* ──────────────────────────────────────────────────────────────
   BƯỚC 2: Router — ưu tiên window.claude (claude.ai artifacts),
           fallback về engine nội bộ nếu không có
   ────────────────────────────────────────────────────────────── */
async function haRunEngine(inputs){
    // Nếu đang chạy trong môi trường claude.ai artifacts → dùng window.claude
    if(typeof window !== 'undefined' && window.claude && typeof window.claude.complete === 'function'){
        return await haRunWithClaudeArtifact(inputs);
    }
    // Mặc định: engine nội bộ thuần JS (hoạt động offline)
    return internalAI(inputs);
}

/* ──────────────────────────────────────────────────────────────
   BƯỚC 2b (nâng cao): Dùng window.claude nếu có
   ────────────────────────────────────────────────────────────── */
async function haRunWithClaudeArtifact({hr,temp,spo2,emo,sym,hist}){
    const prompt = `Phân tích sức khỏe (JSON only, không markdown):
HR:${hr}bpm Temp:${temp}°C SpO2:${spo2}% Emotion:${emo} Symptoms:${sym||'none'} History:${hist||'none'}
Trả về JSON đúng cấu trúc như internalAI với các trường: vitals, risk, psychology, hypotheses, flow, measures, healing.`;
    try {
        const txt = await window.claude.complete(prompt);
        const s=txt.indexOf('{'), e=txt.lastIndexOf('}');
        if(s!==-1 && e!==-1) return JSON.parse(txt.substring(s,e+1));
    } catch(e){ /* fallback nếu claude lỗi */ }
    return internalAI({hr,temp,spo2,emo,sym,hist});
}

/* ──────────────────────────────────────────────────────────────
   BƯỚC 3: INTERNAL AI ENGINE — Hệ thống chấm điểm 6 chiều
   Không dùng random. Mọi kết quả đều có logic rõ ràng.
   ────────────────────────────────────────────────────────────── */
function internalAI({hr, temp, spo2, emo, sym, hist}){

    /* === 3A. ĐÁNH GIÁ TỪNG CHỈ SỐ SINH LÝ (vitals scoring) === */

    // Nhịp tim (HR)
    let hrStatus, hrLabel, hrNote, hrScore=0;
    if     (hr < 40)                { hrStatus='bad';  hrLabel='Nguy hiểm — Quá thấp';  hrNote='Nhịp tim dưới 40 bpm có thể gây ngất xỉu, cần cấp cứu.'; hrScore=35; }
    else if(hr < 50)                { hrStatus='warn'; hrLabel='Nhịp Chậm';              hrNote='Nhịp dưới 50 bpm (nhịp chậm), theo dõi triệu chứng đi kèm.'; hrScore=15; }
    else if(hr <= 60)               { hrStatus='ok';   hrLabel='Bình thường - Thấp';     hrNote='Nhịp nghỉ lý tưởng, phổ biến ở người tập thể thao.'; hrScore=0; }
    else if(hr <= 100)              { hrStatus='ok';   hrLabel='Bình thường';             hrNote='Nhịp tim nằm trong ngưỡng sinh lý bình thường.'; hrScore=0; }
    else if(hr <= 110)              { hrStatus='warn'; hrLabel='Hơi Nhanh';               hrNote='Nhịp tim cao nhẹ, có thể do stress, vận động hoặc mất nước.'; hrScore=10; }
    else if(hr <= 130)              { hrStatus='warn'; hrLabel='Nhanh — Theo Dõi';        hrNote='Nhịp nhanh (>110 bpm), cần kiểm tra nguyên nhân.'; hrScore=20; }
    else                            { hrStatus='bad';  hrLabel='Nguy Hiểm — Nhịp Nhanh'; hrNote='Nhịp tim >130 bpm cần đánh giá y tế khẩn.'; hrScore=35; }

    // Nhiệt độ (Temp)
    let tpStatus, tpLabel, tpNote, tpScore=0;
    if     (temp < 35.0)            { tpStatus='bad';  tpLabel='Hạ Thân Nhiệt';   tpNote='Nhiệt độ <35°C — nguy cơ hạ thân nhiệt, cần ủ ấm khẩn.'; tpScore=30; }
    else if(temp < 36.0)            { tpStatus='warn'; tpLabel='Hơi Thấp';         tpNote='Nhiệt độ dưới mức bình thường, có thể do lạnh hoặc suy kiệt.'; tpScore=10; }
    else if(temp <= 37.2)           { tpStatus='ok';   tpLabel='Bình Thường';       tpNote='Nhiệt độ trong ngưỡng sinh lý bình thường.'; tpScore=0; }
    else if(temp <= 37.9)           { tpStatus='warn'; tpLabel='Sốt Nhẹ';           tpNote='Sốt nhẹ, cơ thể đang phản ứng miễn dịch. Uống nhiều nước.'; tpScore=10; }
    else if(temp <= 38.9)           { tpStatus='warn'; tpLabel='Sốt Trung Bình';    tpNote='Sốt vừa, theo dõi sát và hạ sốt nếu khó chịu.'; tpScore=20; }
    else if(temp <= 39.9)           { tpStatus='bad';  tpLabel='Sốt Cao';           tpNote='Sốt cao >39°C, cần hạ sốt tích cực và đánh giá nguyên nhân.'; tpScore=30; }
    else                            { tpStatus='bad';  tpLabel='Sốt Nguy Hiểm';     tpNote='Nhiệt độ >40°C — nguy hiểm, gọi 115 hoặc đến bệnh viện ngay.'; tpScore=40; }

    // SpO₂
    let spStatus, spLabel, spNote, spScore=0;
    if     (spo2 < 85)              { spStatus='bad';  spLabel='Nguy Hiểm';      spNote='SpO₂ <85% — suy hô hấp cấp, cần thở oxy khẩn.'; spScore=45; }
    else if(spo2 < 90)              { spStatus='bad';  spLabel='Rất Thấp';       spNote='SpO₂ 85–90% — thiếu oxy nặng, gọi cấp cứu 115.'; spScore=35; }
    else if(spo2 < 94)              { spStatus='warn'; spLabel='Thấp Nhẹ';       spNote='SpO₂ 90–94%, cần kiểm tra hô hấp và ngồi nghỉ ngơi.'; spScore=20; }
    else if(spo2 < 95)              { spStatus='warn'; spLabel='Borderline';     spNote='SpO₂ sát ngưỡng, theo dõi và tránh gắng sức.'; spScore=10; }
    else                            { spStatus='ok';   spLabel='Bình Thường';    spNote='Nồng độ oxy máu tốt, chức năng hô hấp bình thường.'; spScore=0; }

    /* === 3B. ĐIỂM TRẠNG THÁI CẢM XÚC (emotion scoring) === */
    const emoMap = { normal:0, tired:8, sad:8, anxious:15, stress:18, pain:22 };
    const emoScore = emoMap[emo] || 0;

    /* === 3C. ĐIỂM TRIỆU CHỨNG (symptom keyword scoring) === */
    const symLow    = (sym+' '+hist).toLowerCase();
    const symKeywords = [
        {kw:['đau ngực','chest pain','tức ngực'],     pts:25},
        {kw:['khó thở','shortness','thở khó'],         pts:20},
        {kw:['chóng mặt','dizziness','xây xẩm'],       pts:15},
        {kw:['đau đầu dữ','đau đầu nặng'],             pts:15},
        {kw:['buồn nôn','nôn','vomit'],                pts:10},
        {kw:['mệt mỏi','fatigue','kiệt sức'],          pts:8},
        {kw:['đau đầu nhẹ','đau đầu'],                 pts:5},
        {kw:['ít ngủ','mất ngủ','không ngủ'],          pts:8},
        {kw:['stress','căng thẳng','áp lực'],          pts:8},
        {kw:['tê bì','tê tay','tê chân'],              pts:12},
    ];
    let symScore = 0;
    for(const {kw, pts} of symKeywords){
        if(kw.some(k => symLow.includes(k))){ symScore += pts; break; }
    }
    symScore = Math.min(symScore, 35); // giới hạn tối đa

    /* === 3D. TỔNG ĐIỂM NGUY CƠ (0–100) === */
    const rawScore = hrScore + tpScore + spScore + emoScore + symScore;
    const finalScore = Math.min(Math.round(rawScore), 100);

    /* === 3E. PHÂN TẦNG NGUY CƠ === */
    let riskLevel, riskLabel, riskExplanation;
    if(finalScore >= 50){
        riskLevel = 'high';
        riskLabel = 'Cao';
        riskExplanation = `Điểm nguy cơ ${finalScore}/100 — Có chỉ số sinh lý bất thường nghiêm trọng. Nên liên hệ bác sĩ sớm hoặc gọi 115 nếu có triệu chứng cấp.`;
    } else if(finalScore >= 25){
        riskLevel = 'medium';
        riskLabel = 'Trung Bình';
        riskExplanation = `Điểm nguy cơ ${finalScore}/100 — Có một số chỉ số cần theo dõi. Nghỉ ngơi, uống đủ nước, và kiểm tra lại sau 2–4 giờ.`;
    } else {
        riskLevel = 'low';
        riskLabel = 'Thấp';
        riskExplanation = `Điểm nguy cơ ${finalScore}/100 — Các chỉ số sinh lý ổn định. Duy trì thói quen lành mạnh.`;
    }

    /* === 3F. PHÂN TÍCH TÂM LÝ === */
    const psychoMap = {
        normal:  { stress: 'Trạng thái bình thường, tâm lý ổn định.', impact: 'Không có tác động tiêu cực đáng kể lên sinh lý hiện tại.' },
        tired:   { stress: 'Cơ thể đang mệt mỏi, cần phục hồi năng lượng.', impact: 'Mệt mỏi kéo dài làm giảm miễn dịch và tăng nhịp tim nhẹ.' },
        sad:     { stress: 'Trạng thái buồn bã có thể kéo theo thiếu ngủ và ăn kém.', impact: 'Cảm xúc tiêu cực ảnh hưởng đến hệ tim mạch và miễn dịch.' },
        anxious: { stress: 'Lo âu mức trung bình đến cao, hệ thần kinh đang cảnh giác quá mức.', impact: 'Lo âu làm tăng cortisol, có thể gây nhịp tim nhanh và huyết áp tăng.' },
        stress:  { stress: 'Mức stress cao đang kích hoạt phản ứng "chiến hay chạy".', impact: 'Stress mạn tính tăng nguy cơ tim mạch, giảm khả năng phục hồi.' },
        pain:    { stress: 'Đau nhức tạo gánh nặng sinh lý và tâm lý đồng thời.', impact: 'Cơn đau kéo dài có thể làm tăng nhịp tim và huyết áp theo phản xạ.' },
    };
    const psycho = psychoMap[emo] || psychoMap.normal;

    /* === 3G. GIẢ THUYẾT CHẨN ĐOÁN (top 3 dựa trên điểm) === */
    const hypotheses = [];
    if(spScore >= 20) hypotheses.push({name:'Suy Giảm Oxy Máu', reason:'SpO₂ thấp gợi ý vấn đề hô hấp hoặc tuần hoàn cần đánh giá.'});
    if(hrScore >= 20) hypotheses.push({name:'Rối Loạn Nhịp Tim', reason:'Nhịp tim bất thường có thể do rối loạn điện giải, mất nước hoặc vấn đề tim mạch.'});
    if(tpScore >= 20) hypotheses.push({name:'Phản Ứng Nhiễm Trùng / Viêm', reason:'Sốt cao hoặc hạ thân nhiệt gợi ý phản ứng viêm hoặc bệnh nhiễm trùng.'});
    if(emoScore >= 15) hypotheses.push({name:'Rối Loạn Lo Âu / Stress Cấp', reason:'Trạng thái lo âu/stress cao ảnh hưởng trực tiếp lên nhịp tim và hô hấp.'});
    if(symLow.includes('đau đầu')) hypotheses.push({name:'Tăng Áp Lực Nội Sọ / Đau Đầu Căng Thẳng', reason:'Đau đầu trong bối cảnh này thường liên quan đến căng thẳng hoặc huyết áp.'});
    if(hypotheses.length < 3) hypotheses.push({name:'Mệt Mỏi Sinh Lý', reason:'Tình trạng chung do thiếu ngủ, mất nước hoặc gắng sức quá mức.'});
    if(hypotheses.length < 3) hypotheses.push({name:'Trạng Thái Sức Khỏe Ổn Định', reason:'Không phát hiện dấu hiệu bệnh lý rõ ràng dựa trên chỉ số hiện tại.'});

    /* === 3H. LUỒNG SUY LUẬN LÂM SÀNG (clinical reasoning flow) === */
    const flow = [
        `Đánh giá sơ bộ: HR ${hr} bpm, SpO₂ ${spo2}%, Nhiệt độ ${temp}°C, trạng thái ${emo}.`,
        `Chấm điểm nguy cơ: HR (${hrScore}đ) + Temp (${tpScore}đ) + SpO₂ (${spScore}đ) + Cảm xúc (${emoScore}đ) + Triệu chứng (${symScore}đ) = ${finalScore}/100.`,
        `Phân tầng: Mức ${riskLabel} — ${riskLevel === 'low' ? 'theo dõi định kỳ' : riskLevel === 'medium' ? 'cần chú ý và theo dõi sát' : 'cần can thiệp y tế sớm'}.`,
        `Tâm lý: ${psycho.stress}`,
        `Khuyến nghị: ${riskLevel === 'high' ? 'Liên hệ bác sĩ hoặc gọi 115 nếu triệu chứng xấu đi.' : riskLevel === 'medium' ? 'Nghỉ ngơi, uống nước, đo lại sau 2-4 giờ.' : 'Duy trì lối sống lành mạnh và theo dõi định kỳ.'}`
    ];

    /* === 3I. BIỆN PHÁP CỤ THỂ === */
    const measures = {
        immediate: riskLevel === 'high'
            ? ['Gọi 115 ngay nếu đau ngực, khó thở hoặc mất ý thức', 'Ngồi hoặc nằm yên ở vị trí thoải mái, không gắng sức', 'Thông báo ngay cho người thân hoặc người xung quanh']
            : riskLevel === 'medium'
            ? ['Nghỉ ngơi hoàn toàn trong 30–60 phút', 'Uống 1–2 ly nước (trừ khi có chống chỉ định)', 'Đo lại các chỉ số sau 30 phút']
            : ['Hít thở sâu và thư giãn 5 phút', 'Uống đủ nước (8 ly/ngày)', 'Duy trì nhịp sinh hoạt đều đặn'],
        homeMonitoring: [
            'Đo nhịp tim và SpO₂ mỗi 4 giờ nếu chỉ số hiện tại bất thường',
            'Ghi nhật ký triệu chứng: thời gian, mức độ, yếu tố kích phát',
            'Theo dõi nhiệt độ 2 lần/ngày nếu đang sốt'
        ],
        seeDoctor: riskLevel === 'high'
            ? ['Đến viện ngay hôm nay hoặc gọi 115', 'Mang theo toàn bộ lịch sử chỉ số từ thiết bị', 'Không lái xe một mình nếu chóng mặt hoặc yếu người']
            : ['Đặt lịch khám trong 1–3 ngày nếu triệu chứng không cải thiện', 'Xét nghiệm máu cơ bản nếu sốt kéo dài >3 ngày', 'Đo điện tim (ECG) nếu nhịp tim bất thường tái phát']
    };

    /* === 3J. ĐỀ XUẤT CHỮA LÀNH === */
    const healingMap = {
        high:   { music: 'Nhạc thiên nhiên nhẹ (sóng biển, rừng) — 40–60 BPM, không giai điệu phức tạp', video: 'Video hướng dẫn thở hoặc thiền định cơ bản 5 phút', breathing: 'Thở 4-7-8: hít 4 giây, giữ 7 giây, thở ra 8 giây — lặp 4 lần', message: 'Cơ thể bạn đang gửi tín hiệu quan trọng. Hãy lắng nghe và tìm sự hỗ trợ y tế sớm.' },
        medium: { music: 'Lo-fi healing 60–80 BPM, instrumental nhẹ nhàng, không lời', video: 'Video yoga nhẹ hoặc stretching 10 phút cho cơ thể mệt mỏi', breathing: 'Thở hộp vuông (box breathing): 4-4-4-4 — hít-giữ-thở ra-nghỉ', message: 'Cơ thể cần được nghỉ ngơi. Một giấc ngủ ngon và đủ nước là liều thuốc tốt nhất.' },
        low:    { music: 'Nhạc piano thiền định 70–90 BPM, giai điệu dễ chịu, uplighting', video: 'Video bài tập thở buổi sáng hoặc thiền mindfulness 10 phút', breathing: 'Thở bụng (diaphragmatic): hít sâu 6 giây bụng phình, thở ra 6 giây bụng xẹp', message: 'Sức khỏe của bạn đang tốt! Duy trì thói quen lành mạnh và tiếp tục theo dõi định kỳ.' },
    };
    const healing = healingMap[riskLevel];

    /* === 3K. TRẢ VỀ JSON CHUẨN === */
    return {
        vitals: {
            heartRate:   { status: hrStatus, label: hrLabel, note: hrNote },
            temperature: { status: tpStatus, label: tpLabel, note: tpNote },
            spo2:        { status: spStatus, label: spLabel, note: spNote },
        },
        risk: {
            level:       riskLevel,
            score:       finalScore,
            label:       riskLabel,
            explanation: riskExplanation,
        },
        psychology: {
            stressLevel:         psycho.stress,
            physiologicalImpact: psycho.impact,
        },
        hypotheses: hypotheses.slice(0, 3),
        flow,
        measures,
        healing,
    };
}

function haDraw(r, hr, temp, spo2){
    /* Lớp phòng thủ cuối: nếu r thiếu cấu trúc → validate lại */
    if (!r || !r.vitals || !r.risk) r = haValidate(r, hr, temp, spo2);

    /* Vitals — đọc an toàn qua optional chaining */
    const vHR  = r.vitals?.heartRate   || { status:'ok', label:'—', note:'—' };
    const vTP  = r.vitals?.temperature || { status:'ok', label:'—', note:'—' };
    const vSP  = r.vitals?.spo2        || { status:'ok', label:'—', note:'—' };
    const risk = r.risk || { level:'low', score:0, label:'—', explanation:'—' };
    const psy  = r.psychology || { stressLevel:'—', physiologicalImpact:'—' };
    const flow = Array.isArray(r.flow) ? r.flow : [];
    const hypo = Array.isArray(r.hypotheses) ? r.hypotheses : [];
    const meas = r.measures || { immediate:[], homeMonitoring:[], seeDoctor:[] };
    const heal = r.healing  || { music:'—', video:'—', breathing:'—', message:'—' };

    document.getElementById('ha-vs').innerHTML=`
        <div class="ha-vbox ${vHR.status}"><div class="ha-vl">❤️ Nhịp Tim</div><div class="ha-vv">${hr}<small style="font-size:13px;font-weight:600"> bpm</small></div><div class="ha-vst">${vHR.label}</div><div class="ha-vn">${vHR.note}</div></div>
        <div class="ha-vbox ${vTP.status}"><div class="ha-vl">🌡️ Nhiệt Độ</div><div class="ha-vv">${temp}<small style="font-size:13px;font-weight:600"> °C</small></div><div class="ha-vst">${vTP.label}</div><div class="ha-vn">${vTP.note}</div></div>
        <div class="ha-vbox ${vSP.status}"><div class="ha-vl">🫧 SpO₂</div><div class="ha-vv">${spo2}<small style="font-size:13px;font-weight:600"> %</small></div><div class="ha-vst">${vSP.label}</div><div class="ha-vn">${vSP.note}</div></div>`;

    document.getElementById('ha-rw').innerHTML=`
        <div class="ha-rb ${risk.level} ha-fade" style="margin-bottom:16px">
            <div><div class="ha-rbt">Phân Tầng Nguy Cơ</div><div class="ha-rbl">Mức ${risk.label}</div><div class="ha-rbex">${risk.explanation}</div><div class="ha-sbbg"><div class="ha-sbf" id="ha-sbf" style="width:0%"></div></div></div>
            <div style="text-align:center"><div class="ha-rsn">${risk.score}</div><div class="ha-rss">/ 100 điểm nguy cơ</div></div>
        </div>`;
    requestAnimationFrame(()=>requestAnimationFrame(()=>{ const b=document.getElementById('ha-sbf'); if(b) b.style.width=risk.score+'%'; }));

    document.getElementById('ha-psych').innerHTML=`
        <div class="ha-pr"><div class="ha-pl">Mức Stress</div><div class="ha-pv">${psy.stressLevel}</div></div>
        <div class="ha-pr"><div class="ha-pl">Ảnh Hưởng Sinh Lý</div><div class="ha-pv">${psy.physiologicalImpact}</div></div>`;

    const fc=['#d71921','#f57c00','#7b1fa2','#1565c0','#2e7d32'];
    document.getElementById('ha-flow').innerHTML=
        flow.map((f,i)=>`<div class="ha-fi"><span class="ha-fa" style="color:${fc[i%5]}">→</span><span class="ha-ft">${f}</span></div>`).join('');

    document.getElementById('ha-hypo').innerHTML=
        hypo.map((h,i)=>`<div class="ha-hi"><div class="ha-hn">${i+1}. ${h.name||'—'}</div><div class="ha-hr">${h.reason||'—'}</div></div>`).join('');

    const li = arr => (Array.isArray(arr) ? arr : []).map(m=>`<li>${m}</li>`).join('');
    document.getElementById('ha-meas').innerHTML=`
        <div><span class="ha-mb ha-red">⚡ Ngay Lập Tức</span><ul class="ha-ml">${li(meas.immediate)}</ul></div>
        <div><span class="ha-mb ha-org">🏠 Theo Dõi Tại Nhà</span><ul class="ha-ml">${li(meas.homeMonitoring)}</ul></div>
        <div><span class="ha-mb ha-blu">🏥 Khi Cần Đi Khám</span><ul class="ha-ml">${li(meas.seeDoctor)}</ul></div>`;

    document.getElementById('ha-heal').innerHTML=`
        <div class="ha-heit"><div class="ha-heic">🎵</div><div class="ha-hel">Nhạc Phù Hợp</div><div class="ha-hec">${heal.music}</div></div>
        <div class="ha-heit"><div class="ha-heic">📹</div><div class="ha-hel">Video Chữa Lành</div><div class="ha-hec">${heal.video}</div></div>
        <div class="ha-heit"><div class="ha-heic">🌬️</div><div class="ha-hel">Bài Tập Thở</div><div class="ha-hec">${heal.breathing}</div></div>
        <div class="ha-heit"><div class="ha-heic">💬</div><div class="ha-hel">Thông Điệp Hỗ Trợ</div><div class="ha-hec">${heal.message}</div></div>`;

    document.getElementById('ha-out').style.display='block';
    requestAnimationFrame(()=>{ document.getElementById('ha-out').scrollIntoView({behavior:'smooth',block:'start'}); });
    /* Cache AI result in HealthStore */
    if(window.HealthStore) HealthStore.setAICache(r);
}

function haLoad(v){document.getElementById('ha-load').classList.toggle('vis',v);if(!v)document.querySelectorAll('.ha-lstep').forEach(s=>s.classList.remove('done'));}
function haErr(m){document.getElementById('ha-errtxt').textContent=m;document.getElementById('ha-err').classList.add('vis');}
function haClearErr(){document.getElementById('ha-err').classList.remove('vis');}
function haBtn(d){document.getElementById('ha-abtn').disabled=d;document.getElementById('ha-spin').style.display=d?'block':'none';document.getElementById('ha-btxt').textContent=d?'Đang phân tích...':'🔍 PHÂN TÍCH NGAY';}
function haWait(ms){return new Promise(r=>setTimeout(r,ms));}

/* ═══════════════════════════════════════════════════════════════
   HA HISTORY — Lưu lịch sử phân tích AI Consultation
   Chỉ lưu khi user bấm nút "Phân tích". Không auto-fill. Không auto-set state.
   ═══════════════════════════════════════════════════════════════ */
const HA_HISTORY_KEY = 'healthHistory';

function saveHaHistory() {
    try {
        var history = JSON.parse(localStorage.getItem(HA_HISTORY_KEY)) || [];
        history.push({
            heartRate:   window.healthState.heartRate   || '',
            temperature: window.healthState.temperature || '',
            spo2:        window.healthState.spo2        || '',
            sleep:       window.healthState.sleep       || '',
            stress:      window.healthState.stress      || '',
            time:        new Date().toLocaleString('vi-VN')
        });
        // Giữ tối đa 50 bản ghi
        if (history.length > 50) history = history.slice(-50);
        localStorage.setItem(HA_HISTORY_KEY, JSON.stringify(history));
        renderHaHistory();
    } catch(e) {}
}

function loadHaHistory() {
    /* Chỉ đọc để hiển thị — KHÔNG set input, KHÔNG set state, KHÔNG đổi theme */
    try {
        var history = JSON.parse(localStorage.getItem(HA_HISTORY_KEY)) || [];
        renderHaHistory(history);
    } catch(e) {}
}

function renderHaHistory(history) {
    var wrap = document.getElementById('ha-history-wrap');
    var list = document.getElementById('ha-history-list');
    if (!wrap || !list) return;
    try {
        history = history || JSON.parse(localStorage.getItem(HA_HISTORY_KEY)) || [];
    } catch(e) { history = []; }
    if (!history.length) { wrap.style.display = 'none'; return; }
    wrap.style.display = 'block';
    list.innerHTML = '';
    // Hiển thị 8 bản ghi gần nhất (đảo ngược để mới nhất lên đầu)
    history.slice().reverse().slice(0, 8).forEach(function(entry) {
        var div = document.createElement('div');
        div.className = 'ha-hist-item';
        var vals = [];
        if (entry.heartRate)   vals.push('❤️ ' + entry.heartRate + ' bpm');
        if (entry.temperature) vals.push('🌡️ ' + entry.temperature + '°C');
        if (entry.spo2)        vals.push('💧 ' + entry.spo2 + '%');
        div.innerHTML =
            '<span class="ha-hist-item-time">' + (entry.time || '') + '</span>' +
            '<span class="ha-hist-item-vals">' + (vals.join(' · ') || '—') + '</span>';
        list.appendChild(div);
    });
}

function haClearHistory() {
    if (!confirm('Xóa toàn bộ lịch sử phân tích?')) return;
    localStorage.removeItem(HA_HISTORY_KEY);
    renderHaHistory([]);
}

/* Load history khi trang sẵn sàng — chỉ hiển thị, không động đến input/state/theme */
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadHaHistory);
} else {
    loadHaHistory();
}

/* ── HealthStore.bindInput cũ đã được thay bằng syncInputs() bên dưới ──
   Không dùng HealthStore để sync giữa hai form nữa.
   Sync trực tiếp qua data-key, không qua store trung gian. */
</script>
<!-- HEALING ENGINE JS v3 — Bubble Infographic -->
<script>
// ── Data ──────────────────────────────────────────────────────
const BREATH_PROGRAMS = {
  '4-7-8': {
    name:'Kỹ thuật 4-7-8',
    desc:'Kích hoạt hệ thần kinh phó giao cảm, giảm nhiệt và nhịp tim. Khuyến nghị khi sốt và lo âu.',
    phases:[
      {label:'Hít vào', secs:4, cls:'inhale', dot:'',       icon:'🫁'},
      {label:'Giữ hơi', secs:7, cls:'hold',   dot:'hold',   icon:'⏸'},
      {label:'Thở ra',  secs:8, cls:'exhale', dot:'exhale', icon:'💨'},
    ]
  },
  'box':{
    name:'Thở hộp vuông',
    desc:'Phương pháp Navy SEALs. 4 bước đều nhau giúp kiểm soát lo âu và tăng tập trung.',
    phases:[
      {label:'Hít vào', secs:4, cls:'inhale', dot:'',       icon:'🫁'},
      {label:'Giữ',     secs:4, cls:'hold',   dot:'hold',   icon:'⏸'},
      {label:'Thở ra',  secs:4, cls:'exhale', dot:'exhale', icon:'💨'},
      {label:'Nghỉ',    secs:4, cls:'hold',   dot:'hold',   icon:'⏸'},
    ]
  },
};

const PLAYLISTS = {
  fever: [
    {name:'Raindrop Lullaby',emoji:'🌧️',genre:'Piano Ambient',  artist:'Healing Sounds',bpm:52,mood:'recovery'},
    {name:'Forest Breath',   emoji:'🌲',genre:'Nature Ambient', artist:'Earth Tones',    bpm:58,mood:'calm'},
    {name:'Warm Tea',        emoji:'🍵',genre:'Lo-fi Healing',  artist:'Studio Mood',    bpm:65,mood:'cozy'},
    {name:'Ocean Tide',      emoji:'🌊',genre:'Oceanic',        artist:'Deep Rest',      bpm:48,mood:'sleep'},
  ],
  stress:[
    {name:'Still Waters',    emoji:'🏞️',genre:'Meditation',artist:'Zen Studio',  bpm:55,mood:'peaceful'},
    {name:'Breathing Space', emoji:'🫧',genre:'Binaural',   artist:'Delta Waves', bpm:63,mood:'focus'},
    {name:'Zen Garden',      emoji:'⛩️',genre:'Zen Japan',  artist:'Koto Masters',bpm:50,mood:'calm'},
  ],
  tired:[
    {name:'Soft Reset',  emoji:'🌙',genre:'Sleep Music',artist:'Night Studio',bpm:45,mood:'sleep'},
    {name:'Deep Valley', emoji:'🏔️',genre:'Ambient',     artist:'Mountain Air', bpm:55,mood:'restore'},
  ],
  normal:[
    {name:'Morning Light',emoji:'🌤️',genre:'Acoustic',  artist:'Guitar Duo',bpm:72,mood:'fresh'},
    {name:'City Rain',    emoji:'🏙️',genre:'Jazz Café', artist:'Blue Note',  bpm:80,mood:'cozy'},
  ],
};

const TIPS_DATA = {
  fever:[
    {emoji:'💧',title:'Uống nước đều đặn',desc:'200ml mỗi 30 phút. Cơ thể mất nước nhanh khi sốt.'},
    {emoji:'🛏️',title:'Nghỉ ngơi hoàn toàn',desc:'Cho hệ miễn dịch dùng toàn bộ năng lượng phục hồi.'},
    {emoji:'📵',title:'Giảm ánh sáng màn hình',desc:'Ánh sáng xanh làm não khó nghỉ. Bật night mode.'},
    {emoji:'🍋',title:'Bổ sung Vitamin C',desc:'Cam, chanh hoặc điện giải giúp phục hồi nhanh hơn.'},
  ],
  stress:[
    {emoji:'🚶',title:'Đi bộ nhẹ 10 phút',desc:'Vận động nhẹ giải phóng endorphin, giảm cortisol.'},
    {emoji:'📵',title:'Tắt thông báo',desc:'Ngắt kết nối 30 phút giúp não reset hoàn toàn.'},
    {emoji:'🍵',title:'Uống trà thảo mộc',desc:'Hoa cúc, bạc hà có tác dụng thư giãn thần kinh.'},
    {emoji:'✍️',title:'Ghi nhật ký cảm xúc',desc:'Viết ra những lo lắng giúp giải phóng tâm trí.'},
  ],
  tired:[
    {emoji:'💤',title:'Ngủ đủ giấc',desc:'Cơ thể mệt cần ưu tiên nghỉ ngơi hơn bất cứ điều gì.'},
    {emoji:'🍌',title:'Bổ sung năng lượng nhẹ',desc:'Chuối, hạt, nước ép tự nhiên phục hồi nhanh.'},
    {emoji:'🌿',title:'Hít thở không khí tươi',desc:'Ra ngoài 10 phút tăng oxygen cho não đáng kể.'},
    {emoji:'📴',title:'Nghỉ ngơi kỹ thuật số',desc:'Tắt màn hình, để não được thực sự nghỉ ngơi.'},
  ],
  normal:[
    {emoji:'💤',title:'Ngủ đủ 7-8 tiếng',desc:'Duy trì giờ ngủ đều đặn để cơ thể phục hồi tốt nhất.'},
    {emoji:'🥗',title:'Ăn đủ dinh dưỡng',desc:'Rau xanh, protein, và uống đủ 2 lít nước mỗi ngày.'},
    {emoji:'🏃',title:'Vận động 30 phút/ngày',desc:'Đi bộ, yoga hoặc bơi lội duy trì sức khỏe tim mạch.'},
    {emoji:'😊',title:'Kết nối xã hội',desc:'Dành thời gian cho người thân và bạn bè.'},
  ],
};

const STORIES = {
  fever: `Hôm nay cơ thể bạn đang làm điều gì đó <em>rất dũng cảm</em> — mỗi tế bào bạch cầu đang lao vào cuộc chiến, tạo ra nhiệt như những ngọn đuốc nhỏ bé bảo vệ bạn từ bên trong.<br><br>Đó không phải yếu đuối. Đó là <em>sức mạnh sinh học đang hoạt động</em>. Hãy để cơ thể được nghỉ ngơi — cơn sốt này sẽ qua.`,
  stress:`Trái tim bạn đang gõ mạnh bởi nó đang nỗ lực bảo vệ bạn. Hệ thần kinh không hỏng — nó chỉ đang làm chính xác những gì được lập trình.<br><br>Nhưng bây giờ, bạn không cần chạy thoát hay chiến đấu. Chỉ cần đặt tay lên ngực và nói: <em>"Chúng ta đang an toàn."</em>`,
  tired: `Mệt mỏi là tín hiệu cơ thể gửi đến — không phải thất bại mà là một lời nhắc nhở yêu thương: <em>hãy dừng lại và chăm sóc bản thân.</em><br><br>Nghỉ ngơi không phải lãng phí thời gian. Đó là đầu tư cho năng lượng của ngày mai.`,
  normal:`Hàng tỷ tế bào đang làm việc nhịp nhàng như một dàn nhạc — tim bơm đều đặn, phổi trao đổi oxy, não điều phối mọi thứ.<br><br>Tất cả chỉ để <em>bạn có thể là chính mình hôm nay</em>. Hãy trân trọng khoảnh khắc khỏe mạnh này.`,
};

const STATE_CONFIG = {
  fever:  {label:'SỐT — ĐANG PHỤC HỒI',   highlight:'breath', hormones:['endorphin']},
  stress: {label:'CĂNG THẲNG CAO',          highlight:'breath', hormones:['serotonin','oxytocin']},
  tired:  {label:'MỆT MỎI',                highlight:'story',  hormones:['dopamine','endorphin']},
  normal: {label:'BÌNH THƯỜNG',             highlight:'music',  hormones:['dopamine','serotonin']},
};

let _breathRunning=false, _breathTimer=null;
let _hsPlaylist=[], _hsCurrentTrack=-1;
let _currentData=null;

// ── RENDER MAIN BUBBLES ────────────────────────────────────
function renderHealingSection(data) {
  _stopBreath(true);
  hsStopMusic(true);
  _hsPlaylist = data.playlist;
  _currentData = data;

  const sc = STATE_CONFIG[data.state] || STATE_CONFIG.normal;
  const sl = document.getElementById('hsStateLine');
  if(sl) sl.textContent = '▸ ' + sc.label;

  document.getElementById('healingGrid').innerHTML =
    _buildStoryBubble(data)  +
    _buildBreathBubble(data) +
    _buildMusicBubble(data)  +
    _buildTipsBubble(data);

  // AI highlight
  setTimeout(()=>{
    document.querySelectorAll('.hcard').forEach(c=>c.classList.remove('ai-highlight'));
    const hi = document.querySelector('.hcard-' + sc.highlight);
    if(hi) hi.classList.add('ai-highlight');
    // Hormone highlight
    document.querySelectorAll('.hormone-bubble').forEach(b=>b.classList.remove('active'));
    sc.hormones.forEach(h=>{
      const hb = document.getElementById('hb-'+h);
      if(hb) hb.classList.add('active');
    });
  }, 600);

  // Attach click handlers
  ['story','breath','music','tips'].forEach(type=>{
    const el = document.querySelector('.hcard-'+type);
    if(el) el.addEventListener('click', ()=>hsOpenDetail(type, data));
  });
}

// ── BUBBLE BUILDERS ───────────────────────────────────────
function _buildStoryBubble(data) {
  const preview = data.healing_story.replace(/<[^>]+>/g,'').slice(0,120)+'…';
  return `<div class="hcard hcard-story" tabindex="0" role="button" aria-label="Câu chuyện chữa lành">
    <div class="hcard-head">
      <span class="hcard-head-icon">🌸</span>
      <div>
        <div class="hcard-head-title">Câu Chuyện</div>
        <div class="hcard-head-sub">Cá nhân hoá</div>
      </div>
    </div>
    <div class="hcard-body">
      <div class="hs-story-preview">${preview}</div>
    </div>
  </div>`;
}

function _buildBreathBubble(data) {
  const bp = BREATH_PROGRAMS[data.breathing_exercise.type] || BREATH_PROGRAMS['4-7-8'];
  const phaseStr = bp.phases.map(p=>p.label+' '+p.secs+'s').join(' · ');
  return `<div class="hcard hcard-breath" tabindex="0" role="button" aria-label="Bài thở thư giãn">
    <div class="hcard-head">
      <span class="hcard-head-icon">🌬️</span>
      <div>
        <div class="hcard-head-title">Bài Thở</div>
        <div class="hcard-head-sub">${bp.name}</div>
      </div>
    </div>
    <div class="hcard-body">
      <div class="hcard-breath-mini-ring">🌿</div>
      <div class="hcard-breath-preview">${phaseStr}</div>
      <button class="hcard-breath-start" onclick="event.stopPropagation();hsOpenDetail('breath',window._currentHealData)">▶ Bắt đầu</button>
    </div>
  </div>`;
}

function _buildMusicBubble(data) {
  const tracks = data.playlist.slice(0,3);
  const tracksHTML = tracks.map((t,i)=>`
    <div class="hcard-music-track-mini" onclick="event.stopPropagation();hsPlayTrack(${i})">
      <span class="tni">${t.emoji}</span>
      <span class="tmn">${t.name}</span>
      <span class="tbp">${t.bpm} BPM</span>
      <span class="tpl">▶</span>
    </div>`).join('');
  return `<div class="hcard hcard-music" tabindex="0" role="button" aria-label="Playlist AI chữa lành">
    <div class="hcard-head">
      <span class="hcard-head-icon">🎵</span>
      <div>
        <div class="hcard-head-title">Playlist AI</div>
        <div class="hcard-head-sub">Theo nhịp tim</div>
      </div>
    </div>
    <div class="hcard-body">
      <div class="hcard-music-tracks">${tracksHTML}</div>
    </div>
  </div>`;
}

function _buildTipsBubble(data) {
  const tips = data.tips.slice(0,4);
  const tipsHTML = tips.map(t=>`
    <div class="hcard-tip-mini">
      <span class="tpi">${t.emoji}</span>
      <span class="tpt">${t.title}</span>
    </div>`).join('');
  return `<div class="hcard hcard-tips" tabindex="0" role="button" aria-label="Gợi ý sức khỏe hôm nay">
    <div class="hcard-head">
      <span class="hcard-head-icon">✨</span>
      <div>
        <div class="hcard-head-title">Gợi Ý Hôm Nay</div>
        <div class="hcard-head-sub">4 tips thiết thực</div>
      </div>
    </div>
    <div class="hcard-body">
      <div class="hcard-tips-mini">${tipsHTML}</div>
    </div>
  </div>`;
}

// ── DETAIL PANEL ─────────────────────────────────────────
window._currentHealData = null;
function hsOpenDetail(type, data) {
  if(!data) return;
  window._currentHealData = data;
  const panel = document.getElementById('hsDetailPanel');
  const icon  = document.getElementById('hsDetailIcon');
  const title = document.getElementById('hsDetailTitle');
  const sub   = document.getElementById('hsDetailSub');
  const body  = document.getElementById('hsDetailBody');
  if(!panel) return;

  const cfg = {
    story:  {icon:'🌸', title:'Câu chuyện chữa lành', sub:'Cá nhân hoá cho bạn'},
    breath: {icon:'🌬️', title:'Bài thở thư giãn',      sub:'Hướng dẫn từng bước'},
    music:  {icon:'🎵', title:'Playlist chữa lành',     sub:'AI gợi ý theo nhịp tim'},
    tips:   {icon:'✨', title:'Gợi ý sức khỏe',         sub:'Hôm nay'},
  }[type] || {icon:'🌿',title:'Chi tiết',sub:''};

  icon.textContent  = cfg.icon;
  title.textContent = cfg.title;
  sub.textContent   = cfg.sub;

  if(type==='story') {
    body.innerHTML = `
      <p class="hs-story-text">${data.healing_story}</p>
      <div class="hs-author">✦ Healing AI · HealthAI Pro</div>`;
  } else if(type==='breath') {
    const bp = BREATH_PROGRAMS[data.breathing_exercise.type] || BREATH_PROGRAMS['4-7-8'];
    const phases = bp.phases.map(p=>`
      <div class="hs-phase-row">
        <span class="hs-phase-dot ${p.dot}"></span>
        <span>${p.label} — <strong>${p.secs}s</strong></span>
      </div>`).join('');
    body.innerHTML = `
      <div class="hs-breath-layout">
        <div class="hs-breath-visual">
          <div class="hs-breath-ring">
            <div class="hs-breath-circle" id="hsBreathCircle">🌿</div>
          </div>
          <div class="hs-breath-label" id="hsBreathLabel">Sẵn sàng</div>
          <div class="hs-breath-secs"  id="hsBreathSecs"></div>
        </div>
        <div class="hs-breath-info">
          <div class="hs-breath-name">${bp.name}</div>
          <div class="hs-breath-desc">${bp.desc}</div>
          <div class="hs-breath-phases">${phases}</div>
          <button class="btn-breath-start" id="hsBreathBtn">▶ BẮT ĐẦU</button>
        </div>
      </div>`;
    const btn = document.getElementById('hsBreathBtn');
    if(btn) btn.addEventListener('click',()=>{
      _breathRunning ? _stopBreath() : _startBreath(data.breathing_exercise.type);
    });
  } else if(type==='music') {
    const moods = [...new Set(data.playlist.map(t=>t.mood))];
    const moodsH = moods.map(m=>`<span class="hs-mood-tag">${m}</span>`).join('');
    const tracksH = data.playlist.map((t,i)=>`
      <div class="hs-track" id="hsTrack${i}" onclick="hsPlayTrack(${i})">
        <span class="hs-track-num">${i+1}</span>
        <span class="hs-track-emoji">${t.emoji}</span>
        <div class="hs-track-info">
          <div class="hs-track-name">${t.name}</div>
          <div class="hs-track-meta">${t.genre} · ${t.artist}</div>
        </div>
        <span class="hs-track-bpm">${t.bpm} BPM</span>
        <span class="hs-play-icon">▶</span>
      </div>`).join('');
    body.innerHTML = `
      <div class="hs-mood-row">${moodsH}</div>
      <div class="hs-track-list">${tracksH}</div>`;
    // Restore playing state
    if(_hsCurrentTrack>=0) {
      const el=document.getElementById('hsTrack'+_hsCurrentTrack);
      if(el) el.classList.add('playing');
    }
  } else if(type==='tips') {
    const tipsH = data.tips.map(t=>`
      <div class="hs-tip">
        <div class="hs-tip-icon">${t.emoji}</div>
        <div>
          <div class="hs-tip-title">${t.title}</div>
          <div class="hs-tip-desc">${t.desc}</div>
        </div>
      </div>`).join('');
    body.innerHTML = `<div class="hs-tips">${tipsH}</div>`;
  }

  panel.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function hsCloseDetail() {
  const panel = document.getElementById('hsDetailPanel');
  if(panel) panel.classList.remove('open');
  document.body.style.overflow = '';
  _stopBreath(true);
}
window.hsCloseDetail = hsCloseDetail;

// Escape key to close
document.addEventListener('keydown', e=>{ if(e.key==='Escape') hsCloseDetail(); });

// ── BREATH ENGINE ─────────────────────────────────────────
function _startBreath(type) {
  _breathRunning = true;
  const btn = document.getElementById('hsBreathBtn');
  if(btn) btn.textContent = '■ DỪNG';
  const phases = (BREATH_PROGRAMS[type]||BREATH_PROGRAMS['4-7-8']).phases;
  let idx=0;
  function step() {
    if(!_breathRunning) return;
    const p=phases[idx%phases.length];
    const c=document.getElementById('hsBreathCircle');
    const l=document.getElementById('hsBreathLabel');
    const s=document.getElementById('hsBreathSecs');
    if(c) c.className='hs-breath-circle '+p.cls;
    if(l) l.textContent=p.label+'...';
    if(s) s.textContent=p.secs+' giây';
    idx++;
    _breathTimer=setTimeout(step, p.secs*1000);
  }
  step();
}
function _stopBreath(silent) {
  _breathRunning=false;
  clearTimeout(_breathTimer);
  ['hsBreathCircle','hsBreathLabel','hsBreathSecs','hsBreathBtn'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    if(id==='hsBreathCircle') el.className='hs-breath-circle';
    if(id==='hsBreathLabel'&&!silent) el.textContent='Sẵn sàng';
    if(id==='hsBreathSecs') el.textContent='';
    if(id==='hsBreathBtn'&&!silent) el.textContent='▶ BẮT ĐẦU';
  });
}

// ── MUSIC ENGINE ─────────────────────────────────────────
function hsPlayTrack(i) {
  const t=_hsPlaylist[i]; if(!t) return;
  _hsCurrentTrack=i;
  document.querySelectorAll('.hs-track').forEach(el=>el.classList.remove('playing'));
  const el=document.getElementById('hsTrack'+i);
  if(el) el.classList.add('playing');
  // Also update bubble mini tracks
  document.querySelectorAll('.hcard-music-track-mini').forEach((el,j)=>{
    el.classList.toggle('playing', j===i);
  });
  const np=document.getElementById('hsNowPlaying');
  if(np) np.classList.add('show');
  const nn=document.getElementById('hsNpName');
  const ns=document.getElementById('hsNpSub');
  if(nn) nn.textContent=t.emoji+' '+t.name;
  if(ns) ns.textContent=t.genre+' · '+t.bpm+' BPM · '+t.mood;
}
window.hsPlayTrack=hsPlayTrack;

function hsStopMusic(silent) {
  _hsCurrentTrack=-1;
  document.querySelectorAll('.hs-track,.hcard-music-track-mini').forEach(el=>el.classList.remove('playing'));
  const np=document.getElementById('hsNowPlaying');
  if(np) np.classList.remove('show');
}
window.hsStopMusic=hsStopMusic;

// ── AUTO-RENDER ──────────────────────────────────────────
window.addEventListener('DOMContentLoaded',()=>{
  setTimeout(()=>{
    renderHealingSection({
      state:'normal',
      healing_story: STORIES.normal,
      breathing_exercise:{type:'4-7-8'},
      playlist: PLAYLISTS.normal,
      tips: TIPS_DATA.normal,
    });
  }, 800);
});

// ── HEALTHSTORE INTEGRATION ──────────────────────────────
(function(){
  let _lastState='normal';
  function detectState(hr,sp,tp){
    if(tp&&tp>=38)  return 'fever';
    if(hr&&hr>100)  return 'stress';
    if(sp&&sp<95)   return 'tired';
    return 'normal';
  }
  function tryUpdate(storeData){
    const hr=storeData.hr,sp=storeData.spo2,tp=storeData.temp;
    if(!hr&&!sp) return;
    const state=detectState(hr,sp,tp);
    if(state!==_lastState){
      _lastState=state;
      renderHealingSection({
        state,
        healing_story:STORIES[state],
        breathing_exercise:{type:state==='stress'?'box':'4-7-8'},
        playlist:PLAYLISTS[state],
        tips:TIPS_DATA[state],
      });
    }
  }
  if(window.HealthStore){
    HealthStore.subscribe(tryUpdate);
    tryUpdate(HealthStore.get());
  } else {
    setInterval(()=>{
      const hr=parseInt(document.getElementById('heartVal')?.textContent)||0;
      const sp=parseInt(document.getElementById('spoVal')?.textContent)||0;
      const tp=parseFloat(document.getElementById('tmpVal')?.textContent)||NaN;
      if(hr<1||sp<1) return;
      tryUpdate({hr,spo2:sp,temp:tp});
    },8000);
  }
})();
</script>



<script id="nkai-script">
(function(){
'use strict';
var VM={'dot quy':'SKs8EKh_3SQ','đột quỵ':'SKs8EKh_3SQ','ngưng tim':'inkRQZPO51Y','cpr':'inkRQZPO51Y','hồi sức':'inkRQZPO51Y','chảy máu':'ueGVsVE5ZLk','ngưng thở':'Ei1UsHqtUvo','hô hấp':'Ei1UsHqtUvo','nghẹn':'zWHyVGUHX7U','choking':'zWHyVGUHX7U','gãy xương':'nsZkiTZPVM4','gãy chân':'nsZkiTZPVM4','huyết áp':'NQrnzq8jcHQ','tụt huyết áp':'NQrnzq8jcHQ'};
function ytId(u){var m=u.match(/(?:v=|\/embed\/|\.be\/)([A-Za-z0-9_-]{6,})/);return m?m[1]:null;}
window.nkaiPlayVideo=function(vid,title){
  var link=document.getElementById('nkai-video-link');
  var placeholder=document.getElementById('nkai-video-placeholder');
  var linkTitle=document.getElementById('nkai-video-link-title');
  if(link&&placeholder){
    placeholder.style.display='none';
    link.href='https://www.youtube.com/watch?v='+vid;
    if(linkTitle)linkTitle.textContent=title||vid;
    link.style.display='flex';
    // Also open immediately in new tab
    window.open('https://www.youtube.com/watch?v='+vid,'_blank','noopener,noreferrer');
  } else {
    window.open('https://www.youtube.com/watch?v='+vid,'_blank','noopener,noreferrer');
  }
};
window.nkaiSearchVideo=function(){var q=(document.getElementById('nkai-vq').value||'').trim();if(!q)return;var id=ytId(q);if(id){window.open('https://www.youtube.com/watch?v='+id,'_blank','noopener,noreferrer');return;}var k=q.toLowerCase();if(VM[k]){window.open('https://www.youtube.com/watch?v='+VM[k],'_blank','noopener,noreferrer');return;}for(var key in VM){if(k.indexOf(key)!==-1||key.indexOf(k)!==-1){window.open('https://www.youtube.com/watch?v='+VM[key],'_blank','noopener,noreferrer');return;}}window.open('https://www.youtube.com/results?search_query='+encodeURIComponent(q),'_blank','noopener,noreferrer');};
document.getElementById('nkai-vq').addEventListener('keydown',function(e){if(e.key==='Enter')nkaiSearchVideo();});
var LSK='nkai_diary_v1';
function loadH(){try{return JSON.parse(localStorage.getItem(LSK))||[];}catch(e){return[];}}
function saveH(l){try{const trimmed=Array.isArray(l)?l.slice(-50):l;localStorage.setItem(LSK,JSON.stringify(trimmed));}catch(e){}}
function evalStatus(hr,temp,spo2,sleep,stress){var r=0,w=[];
if(hr){if(hr<50||hr>120){r+=2;w.push('nhịp tim bất thường');}else if(hr<60||hr>100){r+=1;w.push('nhịp tim hơi lệch');}}
if(temp){if(temp>38.5||temp<35.5){r+=2;w.push('nhiệt độ nguy hiểm');}else if(temp>37.5){r+=1;w.push('hơi sốt');}}
if(spo2){if(spo2<90){r+=3;w.push('SpO₂ nguy hiểm');}else if(spo2<95){r+=2;w.push('SpO₂ thấp');}}
if(sleep!==''&&sleep!==null){if(sleep<4){r+=2;w.push('thiếu ngủ nghiêm trọng');}else if(sleep<6){r+=1;w.push('thiếu ngủ nhẹ');}}
if(stress>=8){r+=2;w.push('stress rất cao');}else if(stress>=6){r+=1;w.push('stress cao');}
if(r>=4)return{code:'risk',label:'⚠ NGUY CƠ – Cần chú ý y tế',css:'status-risk',warnings:w};
if(r>=2)return{code:'watch',label:'⚡ CẦN THEO DÕI – Có dấu hiệu bất thường',css:'status-watch',warnings:w};
return{code:'ok',label:'✅ ỔN ĐỊNH – Sức khỏe bình thường',css:'status-ok',warnings:w};}
function buildText(hr,temp,spo2,sleep,stress,note,status){
var now=new Date(),ts=now.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}),s=[];
s.push('Vào lúc '+ts+', AI đã ghi nhận và phân tích các chỉ số sức khỏe của bạn.');
var v=[];if(hr)v.push('nhịp tim '+hr+' bpm');if(temp)v.push('nhiệt độ '+temp+'°C');if(spo2)v.push('SpO₂ '+spo2+'%');
if(v.length)s.push('Các chỉ số sinh lý ghi nhận: '+v.join(', ')+'.');
if(sleep!==''&&sleep!==null){var sq=sleep>=7?'đủ giấc':sleep>=5?'hơi thiếu ngủ':'thiếu ngủ đáng kể';s.push('Thời gian ngủ '+sleep+' giờ — trạng thái '+sq+'.');}
var sd=stress<=3?'rất nhẹ':stress<=5?'trung bình':stress<=7?'khá cao':'rất cao';
s.push('Mức stress '+sd+' ('+stress+'/10).');
if(status.code==='ok')s.push('Tình trạng sức khỏe hôm nay ổn định, bạn có thể duy trì thói quen bình thường.');
else if(status.code==='watch')s.push('Có chỉ số cần theo dõi'+(status.warnings.length?' ('+status.warnings.join(', ')+')'  :'')+' — hãy nghỉ ngơi và uống đủ nước.');
else s.push('Một số chỉ số nằm ngoài ngưỡng bình thường — nên tham khảo bác sĩ hoặc gọi 115 nếu có triệu chứng.');
if(note&&note.trim())s.push('Ghi chú: '+note.trim()+'.');
return s.join(' ');}
function chips(e){var c='';if(e.hr)c+='<span class="nkai-metric-chip">❤️ '+e.hr+' bpm</span>';if(e.temp)c+='<span class="nkai-metric-chip">🌡️ '+e.temp+'°C</span>';if(e.spo2)c+='<span class="nkai-metric-chip">🫧 SpO₂ '+e.spo2+'%</span>';if(e.sleep!==''&&e.sleep!==null)c+='<span class="nkai-metric-chip">💤 '+e.sleep+'h</span>';c+='<span class="nkai-metric-chip">😓 Stress '+e.stress+'/10</span>';return c;}
function renderEntry(e,container){var d=document.createElement('div');d.className='nkai-diary-entry';d.innerHTML='<div class="nkai-entry-top '+e.css+'"><span><span class="nkai-entry-status-dot"></span>'+e.label+'</span><span style="font-size:11px;opacity:.75">'+e.dateStr+'</span></div><div class="nkai-entry-body"><div class="nkai-entry-text">'+e.text+'</div><div class="nkai-entry-metrics">'+chips(e)+'</div></div><div class="nkai-entry-footer">🤖 Phân tích bởi AI • Chỉ mang tính tham khảo</div>';container.appendChild(d);}
function renderHistory(){var l=loadH(),w=document.getElementById('nkai-history-wrap'),ul=document.getElementById('nkai-history-list');ul.innerHTML='';if(!l.length){w.style.display='none';return;}w.style.display='block';l.slice(0,8).forEach(function(e){var li=document.createElement('div');li.className='nkai-hist-item';li.innerHTML='<span class="nkai-hist-dot '+e.code+'"></span><span class="nkai-hist-date">'+e.dateStr+'</span><span class="nkai-hist-preview">'+e.text.substring(0,70)+'…</span>';ul.appendChild(li);});}
window.nkaiGenerate=function(){
/* Đọc từ healthState (nguồn duy nhất) — đã sync realtime qua data-key */
var hr=parseFloat(window.healthState.heartRate)||parseFloat(document.getElementById('nkai-hr').value)||null;
var temp=parseFloat(window.healthState.temperature)||parseFloat(document.getElementById('nkai-temp').value)||null;
var spo2=parseFloat(window.healthState.spo2)||parseFloat(document.getElementById('nkai-spo2').value)||null;
var sl=window.healthState.sleep!==''?window.healthState.sleep:document.getElementById('nkai-sleep').value;sl=sl!==''?parseFloat(sl):'';
var stress=parseInt(window.healthState.stress,10)||parseInt(document.getElementById('nkai-stress').value,10);
var note=document.getElementById('nkai-note').value||'';
if(!hr&&!temp&&!spo2&&sl===''){alert('Vui lòng nhập ít nhất một chỉ số sức khỏe.');return;}

/* ✔ Gán vào healthState — nguồn duy nhất, dùng chung với banner & phân tích */
if(hr)   window.healthState.heartRate   = hr;
if(temp) window.healthState.temperature = temp;
if(spo2) window.healthState.spo2        = spo2;
if(stress) window.healthState.stress    = stress;

/* ✔ Cập nhật theme từ healthState — chỉ gọi 1 lần tại đây */
if(window.healthState.temperature && window.updateThemeByTemperature){
  updateThemeByTemperature(window.healthState.temperature);
}
/* Ghi vào HealthStore để badge đồng bộ */
if(window.HealthStore){const patch={stress};if(hr)patch.hr=hr;if(temp)patch.temp=temp;if(spo2)patch.spo2=spo2;HealthStore.set(patch,'nkai_form');}
var btn=document.getElementById('nkai-btn'),spin=document.getElementById('nkai-spin'),btxt=document.getElementById('nkai-btxt');
btn.disabled=true;spin.style.display='block';btxt.textContent='Đang phân tích...';
document.getElementById('nkai-loading').classList.add('visible');
document.getElementById('nkai-output').classList.remove('visible');
setTimeout(function(){
var status=evalStatus(hr,temp,spo2,sl,stress);
var now=new Date(),ds=now.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'})+' '+now.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
var entry={hr:hr,temp:temp,spo2:spo2,sleep:sl,stress:stress,note:note,code:status.code,css:status.css,label:status.label,text:buildText(hr,temp,spo2,sl,stress,note,status),dateStr:ds,ts:now.getTime()};
var hist=loadH();hist.unshift(entry);if(hist.length>30)hist=hist.slice(0,30);saveH(hist);
document.getElementById('nkai-loading').classList.remove('visible');
var container=document.getElementById('nkai-entry-container');container.innerHTML='';
document.getElementById('nkai-output').classList.add('visible');
renderEntry(entry,container);renderHistory();
btn.disabled=false;spin.style.display='none';btxt.textContent='✦ Tạo Nhật Ký AI';
document.getElementById('nkai-output').scrollIntoView({behavior:'smooth',block:'nearest'});
},1400);};
window.nkaiClearHistory=function(){if(!confirm('Xóa toàn bộ lịch sử?'))return;localStorage.removeItem(LSK);renderHistory();};
renderHistory();
var h=loadH();if(h.length){document.getElementById('nkai-output').classList.add('visible');renderEntry(h[0],document.getElementById('nkai-entry-container'));}
})();
</script>

<script>
/* ═══════════════════════════════════════════════════════════════
   HealthAI Pro — Premium UI Animations & Micro-interactions
   ═══════════════════════════════════════════════════════════════ */

// ── Intersection Observer for fade-in-up animations ──
(function() {
  const style = document.createElement('style');
  style.textContent = `
    .reveal-up {
      opacity: 0;
      transform: translateY(28px);
      transition: opacity 0.6s cubic-bezier(0.16,1,0.3,1), transform 0.6s cubic-bezier(0.16,1,0.3,1);
    }
    .reveal-up.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .reveal-up.delay-1 { transition-delay: 0.1s; }
    .reveal-up.delay-2 { transition-delay: 0.2s; }
    .reveal-up.delay-3 { transition-delay: 0.3s; }

    /* Premium page load animation */
    @keyframes fadeSlideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .navbar { animation: fadeSlideDown 0.5s ease; }

    /* Glow pulse for IoT connected state */
    @keyframes iotGlow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.3), 0 8px 32px rgba(46,125,50,0.12); }
      50% { box-shadow: 0 0 0 8px rgba(34,197,94,0), 0 8px 32px rgba(46,125,50,0.12); }
    }
    .vitals-box.iot-ok { animation: iotGlow 3s ease-in-out infinite; }
    .vitals-box.iot-warn { animation: iotGlow 2s ease-in-out infinite; }

    /* Hero section parallax */
    .header-banner { perspective: 1000px; }

    /* Shimmer loading */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .metric-loading {
      background: linear-gradient(90deg, #c8e6c9 25%, #dcedc8 50%, #c8e6c9 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    /* Card hover 3D effect */
    .sidebar-card, .ha-card, .nkai-card, .hs-card, .card {
      transform-style: preserve-3d;
    }

    /* IoT status indicators */
    .iot-status-ok .metric-big { filter: drop-shadow(0 0 8px rgba(46,125,50,0.3)); }
    .iot-status-warn .metric-big { filter: drop-shadow(0 0 8px rgba(245,158,11,0.4)); }
    .iot-status-bad .metric-big { filter: drop-shadow(0 0 8px rgba(46,125,50,0.6)); animation: metricDanger 0.5s ease infinite alternate; }
    @keyframes metricDanger {
      from { filter: drop-shadow(0 0 4px rgba(46,125,50,0.4)); }
      to { filter: drop-shadow(0 0 16px rgba(46,125,50,0.8)); }
    }

    /* Premium input focus ring */
    .ha-inp:focus, .nkai-inp:focus {
      transform: scale(1.01);
    }

    /* Smooth section transitions */
    section, [id^="section-"] {
      scroll-margin-top: 80px;
    }
    
    /* Number counter animation */
    @keyframes countUp {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    .metric-big { animation: countUp 0.4s cubic-bezier(0.34,1.56,0.64,1); }
    
    /* IoT card border glow states */
    #section-giam-sat .sidebar-card {
      transition: all 0.4s ease;
    }
    .vitals-safe { border-color: rgba(34,197,94,0.3) !important; }
    .vitals-warn { border-color: rgba(245,158,11,0.4) !important; box-shadow: 0 0 0 2px rgba(245,158,11,0.1) !important; }
    .vitals-danger { border-color: rgba(46,125,50,0.5) !important; box-shadow: 0 0 20px rgba(46,125,50,0.2) !important; }
  `;
  document.head.appendChild(style);

  // Intersection Observer for reveal animations
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        e.target.classList.add('visible');
        observer.unobserve(e.target);
      }
    });
  }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

  // Apply reveal to all major sections after DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    const targets = document.querySelectorAll('.sidebar-card, .ha-card, .nkai-card, .card, .ha-sc, .hs-card');
    targets.forEach((el, i) => {
      el.classList.add('reveal-up');
      if (i % 3 === 1) el.classList.add('delay-1');
      if (i % 3 === 2) el.classList.add('delay-2');
      observer.observe(el);
    });
  });

  // ── 3D card tilt effect ──
  document.addEventListener('mousemove', (e) => {
    const cards = document.querySelectorAll('.sidebar-card, .ha-card, .hs-card, .nkai-card');
    cards.forEach(card => {
      const rect = card.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const dx = (e.clientX - cx) / rect.width;
      const dy = (e.clientY - cy) / rect.height;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < 1) {
        card.style.transform = `perspective(800px) rotateY(${dx * 4}deg) rotateX(${-dy * 4}deg) translateY(-4px)`;
      } else {
        card.style.transform = '';
      }
    });
  });

  // ── IoT Vitals Status Glow ──
  function updateIoTGlow(hr, spo2, temp) {
    const scard = document.querySelector('#section-giam-sat .sidebar-card');
    if (!scard) return;
    const isOk = hr >= 60 && hr <= 110 && spo2 >= 95 && temp >= 36 && temp <= 38;
    const isWarn = !isOk && (spo2 >= 90) && (hr >= 40 && hr <= 130);
    scard.classList.remove('vitals-safe', 'vitals-warn', 'vitals-danger');
    if (isOk) scard.classList.add('vitals-safe');
    else if (isWarn) scard.classList.add('vitals-warn');
    else scard.classList.add('vitals-danger');
  }

  // Subscribe to HealthStore changes to update glow
  if (window.HealthStore) {
    HealthStore.subscribe(s => {
      if (s.hr && s.spo2 && s.temp) updateIoTGlow(s.hr, s.spo2, s.temp);
    });
  }

  // ── Parallax Hero ──
  window.addEventListener('scroll', () => {
    const hero = document.querySelector('.header-banner');
    if (!hero) return;
    const scroll = window.scrollY;
    const stickers = hero.querySelectorAll('.hero-sticker');
    stickers.forEach((s, i) => {
      const speed = 0.15 + (i % 3) * 0.08;
      s.style.transform += ` translateY(${scroll * speed}px)`;
    });
  }, { passive: true });

  // ── Smooth number counter for metrics ──
  function animateNumber(el, end, duration) {
    const start = parseFloat(el.textContent) || 0;
    const diff = end - start;
    const startTime = performance.now();
    function update(now) {
      const progress = Math.min((now - startTime) / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      el.textContent = Number.isInteger(end) 
        ? Math.round(start + diff * eased)
        : (start + diff * eased).toFixed(1);
      if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
  }

  // Observe metric updates from HealthStore
  if (window.HealthStore) {
    HealthStore.subscribe(s => {
      const hEl = document.getElementById('heartVal');
      const sEl = document.getElementById('spoVal');
      const tEl = document.getElementById('tmpVal');
      if (hEl && s.hr && hEl.textContent !== '--') animateNumber(hEl, s.hr, 600);
      if (sEl && s.spo2 && sEl.textContent !== '--') animateNumber(sEl, s.spo2, 600);
      if (tEl && s.temp && tEl.textContent !== '--') animateNumber(tEl, s.temp, 600);
    });
  }

  // ── Button ripple effect ──
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-hero-primary, .ha-btn, .nkai-btn');
    if (!btn) return;
    const ripple = document.createElement('span');
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    Object.assign(ripple.style, {
      position: 'absolute',
      width: size + 'px', height: size + 'px',
      left: (e.clientX - rect.left - size/2) + 'px',
      top: (e.clientY - rect.top - size/2) + 'px',
      background: 'rgba(255,255,255,0.3)',
      borderRadius: '50%',
      transform: 'scale(0)',
      animation: 'rippleEffect 0.5s ease-out forwards',
      pointerEvents: 'none',
    });
    btn.style.position = 'relative';
    btn.style.overflow = 'hidden';
    btn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  });
  
  const rippleStyle = document.createElement('style');
  rippleStyle.textContent = '@keyframes rippleEffect { to { transform: scale(2); opacity: 0; } }';
  document.head.appendChild(rippleStyle);

})();
</script>


<script>
/* ═══════════════════════════════════════════════════════════════
   HealthAI Pro — Input Empty State (simplified)
   Đảm bảo tất cả input bắt đầu trống khi load trang.
   Subscriber mới đã không còn auto-fill, nên chỉ cần clear 1 lần.
   ═══════════════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', function() {
  ['ha-hr','ha-spo2','ha-temp','ha-sym','ha-hist',
   'nkai-hr','nkai-temp','nkai-spo2','nkai-sleep','nkai-note',
   'tempSimInput'].forEach(function(id) {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
});
</script>

<!-- VIDEO: Cards open YouTube directly in new tab -->

<style>
/* ── YouTube Card Styles ── */
.yt-card {
  display: inline-flex;
  flex-direction: column;
  min-width: 200px;
  max-width: 220px;
  border-radius: 10px;
  overflow: hidden;
  text-decoration: none;
  color: inherit;
  background: #fff;
  border: 1px solid #e8edf3;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  flex-shrink: 0;
}
.yt-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 28px rgba(46,125,50,0.18);
  text-decoration: none;
  color: inherit;
}
.yt-thumb-wrap {
  position: relative;
  overflow: hidden;
  aspect-ratio: 16/9;
  background: #111;
}
.yt-thumb-wrap img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.25s ease;
}
.yt-card:hover .yt-thumb-wrap img { transform: scale(1.06); }
.yt-play-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}
.yt-card:hover .yt-play-overlay { opacity: 1; }
.yt-play-icon {
  width: 46px;
  height: 46px;
  background: rgba(46,125,50,0.92);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 18px;
  padding-left: 3px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.35);
}
.yt-card-body {
  padding: 8px 10px 10px;
  flex: 1;
}
.yt-card-title {
  font-size: 12px;
  font-weight: 700;
  color: #1a1a2e;
  margin-bottom: 4px;
  line-height: 1.4;
}
.yt-card-link {
  font-size: 11px;
  color: #2e7d32;
  font-weight: 600;
}

/* nkai quick btn as link */
.nkai-yt-btn {
  display: inline-block;
  padding: 4px 10px;
  border: 1px solid var(--primary, #d71921);
  color: var(--primary, #d71921);
  background: #fff0f0;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  text-decoration: none;
  transition: background 0.15s, color 0.15s;
}
.nkai-yt-btn:hover {
  background: var(--primary, #d71921);
  color: #fff;
  text-decoration: none;
}

@keyframes skelShimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
.chat-input-bar {
  display: flex;
  align-items: center;
  gap: 5px;
  background: rgba(255,255,255,0.9);
  border: 1.5px solid rgba(46,125,50,0.2);
  border-radius: 14px;
  padding: 5px 8px;
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 12px rgba(46,125,50,0.08);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.chat-input-bar:focus-within {
  border-color: rgba(46,125,50,0.5);
  box-shadow: 0 2px 20px rgba(46,125,50,0.15);
}
.chat-main-input {
  flex: 1;
  border: none;
  background: transparent;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.88rem;
  color: #1a1a2e;
  outline: none;
  padding: 4px 4px;
  min-width: 0;
}
.chat-main-input::placeholder { color: #aaa; }
.chat-tool-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 5px;
  border-radius: 8px;
  color: #888;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: background 0.15s, color 0.15s;
  flex-shrink: 0;
}
.chat-tool-btn:hover { background: rgba(46,125,50,0.1); color: #0a68ff; }
.chat-send-btn {
  background: #0a68ff;
  border: none;
  color: #fff;
  border-radius: 10px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.15s, transform 0.1s;
}
.chat-send-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
.chat-send-btn:active { transform: scale(0.95); }

/* Mic glow when recording */
.chat-mic-btn.recording {
  color: #0a68ff !important;
  animation: micGlow 1s infinite;
}
@keyframes micGlow {
  0%,100% { box-shadow: 0 0 0 0 rgba(46,125,50,0.4); background: rgba(46,125,50,0.1); }
  50% { box-shadow: 0 0 0 8px rgba(46,125,50,0); background: rgba(46,125,50,0.2); }
}

/* Emoji picker */
#chat-emoji-picker { display:flex; }
.ep { font-size:20px; cursor:pointer; padding:3px; border-radius:6px; transition:background .1s; line-height:1; }
.ep:hover { background:rgba(46,125,50,0.1); }

/* Image preview in chat */
.chat-img-preview-item {
  display: inline-flex;
  position: relative;
  margin-right: 6px;
  margin-bottom: 4px;
}
.chat-img-preview-item img {
  width: 56px; height: 56px;
  object-fit: cover;
  border-radius: 8px;
  border: 1.5px solid rgba(46,125,50,0.3);
}
.chat-img-remove {
  position: absolute;
  top: -4px; right: -4px;
  background: #2e7d32;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 16px; height: 16px;
  font-size: 9px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  line-height: 1;
}

/* Chat image bubble */
.bubble-img { border-radius: 12px; overflow: hidden; margin-top: 4px; }
.bubble-img img {
  max-width: 180px; max-height: 140px;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  display: block;
}

/* TTS button in bot bubble */
.tts-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: #bbb;
  font-size: 12px;
  padding: 2px 5px;
  border-radius: 6px;
  transition: color .15s, background .15s;
  margin-left: 4px;
  vertical-align: middle;
}
.tts-btn:hover { color: #0a68ff; background: rgba(46,125,50,0.08); }
.tts-btn.speaking { color: #0a68ff; animation: ttsPulse .6s infinite; }
@keyframes ttsPulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* Fade-in for chat bubbles */
.bubble-row { animation: bubbleFadeIn 0.25s ease both; }
@keyframes bubbleFadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* Glass bubble enhancement */
.bubble-bot {
  background: rgba(255,255,255,0.92) !important;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.bubble-user {
  background: linear-gradient(135deg, #0a68ff, #1b5e20) !important;
  backdrop-filter: blur(4px);
}

/* Video card skeleton */
.vid-card-skeleton {
  background: linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);
  background-size: 400% 100%;
  animation: skelShimmer 1.5s infinite;
  border-radius: 8px;
  min-width:220px;
  height:180px;
}

/* Video cards — handled by .yt-card styles */
</style>

/* Video: all YouTube links open in new tab via <a target="_blank"> or window.open */

<script>
/* ═══════════════════════════════════════════════════════════════
   CHATBOT UPGRADE v2: IMAGE AI PIPELINE + VOICE + TTS
   - Ảnh → base64 → Anthropic API (vision)
   - Text-only → local AI engine (không đổi)
   - Text + ảnh → Anthropic API với multimodal message
   ═══════════════════════════════════════════════════════════════ */
(function() {

  /* ── State ── */
  let pendingImages   = [];   // [{file, dataUrl, mediaType, base64}]
  let isRecording     = false;
  let recognition     = null;
  let currentTTSUtt   = null;
  let _chatImgSending = false;

  const chatImgInput  = document.getElementById('chatImgInput');
  const chatImgPrev   = document.getElementById('chat-img-preview');
  const chatMicBtn    = document.getElementById('chatMicBtn');
  const chatEmojiBtn  = document.getElementById('chatEmojiBtn');
  const emojiPicker   = document.getElementById('chat-emoji-picker');
  const voiceStatus   = document.getElementById('chat-voice-status');
  const chatInput     = document.getElementById('chatInput');
  const chatbox       = document.getElementById('chatbox');
  const sendBtn       = document.getElementById('sendBtn');

  /* ════════════════════════════════════════════════════════
     1. IMAGE UPLOAD — convert to base64
     ════════════════════════════════════════════════════════ */
  chatImgInput.addEventListener('change', function() {
    Array.from(this.files).forEach(file => {
      if (!file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        // e.target.result = "data:image/jpeg;base64,XXXX"
        const dataUrl  = e.target.result;
        const base64   = dataUrl.split(',')[1];
        const mediaType = file.type; // e.g. "image/jpeg"
        pendingImages.push({ file, dataUrl, base64, mediaType });
        renderImgPreview();
      };
      reader.readAsDataURL(file);
    });
    this.value = '';
  });

  function renderImgPreview() {
    chatImgPrev.innerHTML = '';
    if (!pendingImages.length) { chatImgPrev.style.display = 'none'; return; }
    chatImgPrev.style.display = 'block';
    pendingImages.forEach((item, idx) => {
      const wrap = document.createElement('div');
      wrap.className = 'chat-img-preview-item';
      const img = document.createElement('img');
      img.src = item.dataUrl;
      const rm  = document.createElement('button');
      rm.className = 'chat-img-remove';
      rm.textContent = '✕';
      rm.onclick = () => { pendingImages.splice(idx, 1); renderImgPreview(); };
      wrap.appendChild(img);
      wrap.appendChild(rm);
      chatImgPrev.appendChild(wrap);
    });
  }

  /* ════════════════════════════════════════════════════════
     2. UI HELPERS
     ════════════════════════════════════════════════════════ */
  function chatTs() {
    const d = new Date();
    return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
  }

  /** Thêm ảnh vào bubble cuối cùng của user */
  function appendImagesToLastUserBubble(dataUrls) {
    const lastWrap = chatbox.querySelector('.bubble-row.user:last-child .bubble-wrap');
    if (!lastWrap) return;
    const imgDiv = document.createElement('div');
    imgDiv.className = 'bubble-img';
    dataUrls.forEach(url => {
      const im = document.createElement('img');
      im.src = url;
      imgDiv.appendChild(im);
    });
    const ts = lastWrap.querySelector('.bubble-ts');
    ts ? lastWrap.insertBefore(imgDiv, ts) : lastWrap.appendChild(imgDiv);
  }

  /** Thêm nút TTS vào bubble bot vừa thêm */
  function attachTtsToLastBot(plainText) {
    requestAnimationFrame(() => {
      const tsEl = chatbox.querySelector('.bubble-row.bot:last-child .bubble-wrap .bubble-ts');
      if (!tsEl || tsEl.querySelector('.tts-btn')) return;
      const btn = document.createElement('button');
      btn.className = 'tts-btn';
      btn.title = 'Đọc to';
      btn.innerHTML = '🔊';
      btn.addEventListener('click', () => speakText(plainText, btn));
      tsEl.appendChild(btn);
    });
  }

  /** Typing indicator */
  function showTypingIndicator(label) {
    label = label || 'Đang trả lời...';
    const row = document.createElement('div');
    row.className = 'bubble-row bot';
    row.id = 'ai-typing-indicator';
    row.innerHTML = `
      <div class="bubble-avatar">🩺</div>
      <div class="bubble-wrap">
        <div class="bubble-bot bubble-typing">
          <div style="display:flex;align-items:center;gap:8px;font-size:12px;color:#999;">
            <div class="typing-dots">
              <span class="typing-dot"></span>
              <span class="typing-dot"></span>
              <span class="typing-dot"></span>
            </div>
            <span id="ai-typing-label">${label}</span>
          </div>
        </div>
      </div>`;
    chatbox.appendChild(row);
    chatbox.scrollTop = chatbox.scrollHeight;
    return row;
  }

  function removeTypingIndicator() {
    const el = document.getElementById('ai-typing-indicator');
    if (el) el.remove();
  }

  function updateTypingLabel(text) {
    const el = document.getElementById('ai-typing-label');
    if (el) el.textContent = text;
  }

  /** Render markdown-safe bot bubble */
  function addBotBubble(text) {
    const row  = document.createElement('div');
    row.className = 'bubble-row bot';
    const avatar = document.createElement('div');
    avatar.className = 'bubble-avatar';
    avatar.textContent = '🩺';
    const wrap = document.createElement('div');
    wrap.className = 'bubble-wrap';
    const bubble = document.createElement('div');
    bubble.className = 'bubble-bot';
    try { bubble.innerHTML = marked.parse(text); } catch(e) { bubble.textContent = text; }
    const ts = document.createElement('div');
    ts.className = 'bubble-ts';
    ts.textContent = chatTs();
    wrap.appendChild(bubble);
    wrap.appendChild(ts);
    row.appendChild(avatar);
    row.appendChild(wrap);
    chatbox.appendChild(row);
    chatbox.scrollTop = chatbox.scrollHeight;
    return text;
  }

  /* ════════════════════════════════════════════════════════
     3. ANTHROPIC API CALL — text + image (vision)
     ════════════════════════════════════════════════════════ */
  const CLAUDE_MODEL = 'claude-sonnet-4-6';
  const HEALTH_SYSTEM = `Bạn là Bác sĩ AI 24/7, trợ lý sức khỏe thông minh viết bằng tiếng Việt.
Nhiệm vụ:
- Tư vấn triệu chứng, bệnh lý thường gặp
- Đọc và giải thích chỉ số sinh lý (nhịp tim, SpO₂, nhiệt độ, huyết áp)
- Hướng dẫn sơ cứu cơ bản
- Phân tích hình ảnh liên quan sức khỏe: vết thương, phát ban, kết quả xét nghiệm, thuốc, thực phẩm
- Đưa ra khuyến nghị nhẹ nhàng, không thay thế bác sĩ thực tế

Khi nhận ảnh:
1. Mô tả ngắn gọn những gì nhìn thấy liên quan sức khỏe
2. Nhận xét sơ bộ (nếu là vết thương, phát ban, thuốc, xét nghiệm…)
3. Đưa khuyến nghị: "Nên theo dõi thêm" / "Đến cơ sở y tế" / "Có thể xử lý tại nhà"
4. Nếu ảnh không liên quan sức khỏe, trả lời thân thiện và hỏi thêm

Luôn:
- Trả lời bằng tiếng Việt
- Ngắn gọn, rõ ràng, có cấu trúc
- Thêm disclaimer: "Đây là tư vấn thông tin, không thay thế bác sĩ"
- Nếu nguy hiểm → nhắc gọi 115`;

  async function callClaudeVision(userText, imageItems) {
    // Build content array: images first, then text
    const contentParts = [];

    imageItems.forEach(item => {
      contentParts.push({
        type: 'image',
        source: {
          type: 'base64',
          media_type: item.mediaType,
          data: item.base64,
        }
      });
    });

    const textPrompt = userText
      ? userText
      : 'Hãy phân tích hình ảnh này liên quan đến sức khỏe và đưa ra nhận xét.';

    contentParts.push({ type: 'text', text: textPrompt });

    const body = {
      model: CLAUDE_MODEL,
      max_tokens: 1000,
      system: HEALTH_SYSTEM,
      messages: [{ role: 'user', content: contentParts }]
    };

    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!resp.ok) {
      const err = await resp.text();
      throw new Error('API error ' + resp.status + ': ' + err.slice(0,200));
    }

    const data = await resp.json();
    // Extract text from content blocks
    return data.content
      .filter(b => b.type === 'text')
      .map(b => b.text)
      .join('\n') || '(Không có phản hồi)';
  }

  /* ════════════════════════════════════════════════════════
     4. INTERCEPT sendMessage — route to AI vision or local
     ════════════════════════════════════════════════════════ */
  function wrapSendMessage() {
    const origSend = window.sendMessage;
    if (!origSend) return;

    window.sendMessage = async function() {
      // If has images → AI vision pipeline
      if (pendingImages.length > 0) {
        if (_chatImgSending) return;
        _chatImgSending = true;

        const userText  = chatInput.value.trim();
        const imgs      = pendingImages.slice();
        const dataUrls  = imgs.map(i => i.dataUrl);

        // Clear state
        pendingImages = [];
        renderImgPreview();
        chatInput.value = '';
        chatInput.disabled = true;
        sendBtn.disabled  = true;

        // ── Show user bubble ──
        const displayText = userText || '📷 Gửi ảnh để phân tích';
        if (window.addMsg) {
          window.addMsg(displayText, 'user');
        } else {
          const row = document.createElement('div');
          row.className = 'bubble-row user';
          row.innerHTML = `<div class="bubble-avatar">👤</div>
            <div class="bubble-wrap">
              <div class="bubble-user">${displayText}</div>
              <div class="bubble-ts">${chatTs()}</div>
            </div>`;
          chatbox.appendChild(row);
        }

        // ── Append image previews to user bubble ──
        setTimeout(() => appendImagesToLastUserBubble(dataUrls), 30);

        // ── Typing indicator with stages ──
        showTypingIndicator('AI đang phân tích ảnh…');

        try {
          // Stage labels
          const stages = [
            { delay: 800,  label: 'Đang xử lý hình ảnh…' },
            { delay: 2000, label: 'Đang phân tích sức khỏe…' },
            { delay: 4000, label: 'Đang chuẩn bị phản hồi…' },
          ];
          stages.forEach(s => setTimeout(() => updateTypingLabel(s.label), s.delay));

          const aiReply = await callClaudeVision(userText, imgs);

          removeTypingIndicator();
          const plainText = addBotBubble(aiReply);
          attachTtsToLastBot(plainText);

          // Save to chatCtx if available
          if (window.chatCtx) {
            chatCtx.turns.push({ role:'user', text: displayText, ts: Date.now() });
            chatCtx.turns.push({ role:'bot',  text: aiReply,     ts: Date.now() });
            if (window.chatSaveHistory) chatSaveHistory();
          }

        } catch(err) {
          removeTypingIndicator();
          const errMsg = err.message.includes('API error 401')
            ? '🔑 Cần API key để phân tích ảnh. Vui lòng cấu hình Anthropic API key.'
            : err.message.includes('API error 4')
            ? '⚠️ Không thể phân tích ảnh lúc này: ' + err.message.split(':')[0]
            : '🌐 Không thể kết nối AI. Hãy kiểm tra kết nối mạng và thử lại.';
          addBotBubble(errMsg);
          console.error('[ChatVision]', err);
        }

        chatInput.disabled = false;
        sendBtn.disabled   = false;
        chatInput.focus();
        _chatImgSending = false;

      } else {
        // No images → use original local AI engine (unchanged)
        await origSend();
      }
    };
  }

  /* ════════════════════════════════════════════════════════
     5. PATCH addMsg — add TTS button to every bot bubble
     ════════════════════════════════════════════════════════ */
  const _globalAddMsg = window.addMsg;
  if (_globalAddMsg) {
    window.addMsg = function(text, type, suggests) {
      _globalAddMsg(text, type, suggests);
      if (type === 'bot') attachTtsToLastBot(text);
    };
  }

  /* ════════════════════════════════════════════════════════
     6. TEXT TO SPEECH
     ════════════════════════════════════════════════════════ */
  function speakText(text, btn) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    if (btn && btn.classList.contains('speaking')) {
      btn.classList.remove('speaking'); btn.innerHTML = '🔊';
      currentTTSUtt = null; return;
    }
    const clean = text.replace(/\*\*(.+?)\*\*/g,'$1').replace(/\*(.+?)\*/g,'$1')
                      .replace(/#{1,6}\s/g,'').replace(/\n+/g,' ').trim();
    const utter = new SpeechSynthesisUtterance(clean);
    utter.lang = 'vi-VN'; utter.rate = 1.05; utter.pitch = 1;
    const viVoice = window.speechSynthesis.getVoices().find(v => v.lang.startsWith('vi'));
    if (viVoice) utter.voice = viVoice;
    if (btn) { btn.classList.add('speaking'); btn.innerHTML = '⏹️'; }
    const done = () => { if(btn){btn.classList.remove('speaking');btn.innerHTML='🔊';} currentTTSUtt=null; };
    utter.onend = done; utter.onerror = done;
    currentTTSUtt = utter;
    window.speechSynthesis.speak(utter);
  }

  /* ════════════════════════════════════════════════════════
     7. SPEECH TO TEXT (Web Speech API)
     ════════════════════════════════════════════════════════ */
  function initVoice() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { chatMicBtn.style.display = 'none'; return; }
    recognition = new SR();
    recognition.lang = 'vi-VN';
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.onresult = (e) => {
      let final = '', interim = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        e.results[i].isFinal ? (final += t) : (interim += t);
      }
      chatInput.value = final || interim;
    };
    recognition.onend = () => {
      isRecording = false;
      chatMicBtn.classList.remove('recording');
      voiceStatus.style.display = 'none';
      if (chatInput.value.trim()) setTimeout(() => window.sendMessage && window.sendMessage(), 300);
    };
    recognition.onerror = () => {
      isRecording = false;
      chatMicBtn.classList.remove('recording');
      voiceStatus.style.display = 'none';
    };
  }

  chatMicBtn.addEventListener('click', function() {
    if (!recognition) { initVoice(); if (!recognition) return; }
    if (isRecording) {
      recognition.stop();
    } else {
      isRecording = true;
      chatMicBtn.classList.add('recording');
      voiceStatus.style.display = 'block';
      chatInput.value = '';
      recognition.start();
    }
  });

  /* ════════════════════════════════════════════════════════
     8. EMOJI PICKER
     ════════════════════════════════════════════════════════ */
  chatEmojiBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
  });
  document.querySelectorAll('.ep').forEach(ep => {
    ep.addEventListener('click', () => {
      chatInput.value += ep.getAttribute('data-e');
      chatInput.focus();
      emojiPicker.style.display = 'none';
    });
  });
  document.addEventListener('click', (e) => {
    if (!emojiPicker.contains(e.target) && e.target !== chatEmojiBtn)
      emojiPicker.style.display = 'none';
  });

  /* ════════════════════════════════════════════════════════
     9. INIT
     ════════════════════════════════════════════════════════ */
  initVoice();
  // Wrap sendMessage after the original is registered
  setTimeout(wrapSendMessage, 300);

})();
</script>


<!-- ════════════════════════════════════════════════════
     GOOGLE TRANSLATE — VN ↔ EN
     - Hides native GT UI
     - Waits for .goog-te-combo to be ready before trigger
     - Saves choice to localStorage (key: hai_lang)
     - Restores on page load
     - Falls back gracefully if GT unavailable
════════════════════════════════════════════════════ -->


<!-- ══════════════════════════════════════════════════════════════
     HealthAI Pro — i18n Translation System v3
     ✔ TreeWalker: duyệt toàn bộ text node trong DOM
     ✔ Substring scan: tìm key trong text node dài (không chỉ exact match)
     ✔ Persistent node map: lưu trạng thái gốc, restore chính xác 100%
     ✔ Attribute scan: placeholder, title, aria-label, aria-placeholder, value
     ✔ MutationObserver: tự động dịch content thêm vào sau khi load
     ✔ localStorage: nhớ ngôn ngữ sau reload
     ✔ 0 external deps, offline-ready, không gây lỗi console
════════════════════════════════════════════════════════════════ -->
<script>
/**
 * ═══════════════════════════════════════════════════════════════════════
 *  HealthAI Pro — VN ↔ EN Translation Engine v3
 *  Tác giả: HealthAI Pro Team
 *  Chiến lược:
 *    1. Exact-match: tra cứu trimmed text node
 *    2. Substring-replace: thay từng key xuất hiện trong text node dài
 *    3. Attribute scan: placeholder / title / aria-label / alt
 *    4. MutationObserver: dịch tự động nội dung JS động
 *    5. nodeMap: lưu {original, translated} theo WeakMap → restore chuẩn
 * ═══════════════════════════════════════════════════════════════════════
 */
(function () {
  'use strict';

  /* ═══════════════════════════════════════════════════════════════
     §1  DICTIONARY  —  Vietnamese → English
         Sắp xếp từ dài → ngắn để tránh partial-match conflict
         (substring replace sẽ dùng thứ tự này)
  ═══════════════════════════════════════════════════════════════ */
  var D = {

    // ── Brand / Page Title ────────────────────────────────────────
    'HealthAI Pro — Nền Tảng Sức Khỏe Thông Minh': 'HealthAI Pro — Smart Health Platform',

    // ── Navbar ────────────────────────────────────────────────────
    'Bệnh Cấp Cứu':                    'Emergency Diseases',
    'Tổng quan các bệnh':              'Disease Overview',
    '🧠 Đột quỵ / Nhồi máu não':       '🧠 Stroke / Brain Infarction',
    '❤️ Nhồi máu cơ tim':              '❤️ Heart Attack',
    '🩸 Huyết áp cao / thấp':           '🩸 High / Low Blood Pressure',
    '🫁 Ngưng thở / Choking':           '🫁 Respiratory Arrest / Choking',
    '⚡ Sốc (Shock)':                   '⚡ Shock',
    '🩹 Chảy máu nặng':                '🩹 Severe Bleeding',
    'Hướng Dẫn Sơ Cứu':               'First Aid Guide',
    'Tổng quan sơ cứu':                'First Aid Overview',
    '🫀 CPR / Hồi sức tim phổi':        '🫀 CPR / Cardiopulmonary Resuscitation',
    '🤲 Nghiệm pháp Heimlich':          '🤲 Heimlich Maneuver',
    '🦴 Sơ cứu gãy xương':             '🦴 Fracture First Aid',
    '🩺 Những việc nên làm hằng ngày':  '🩺 Daily Health Habits',
    'Tìm kiếm video':                  'Search Videos',
    '▶ Xử lý đột quỵ':                '▶ Stroke Management',
    '▶ Xử lý ngưng tim':              '▶ Cardiac Arrest Management',
    '▶ Xử lý chảy máu':               '▶ Bleeding Management',
    '▶ Sơ cứu gãy xương':             '▶ Fracture First Aid',
    'Giám Sát Sức Khỏe':              'Health Monitoring',
    'Trực tiếp (Live)':                'Live',
    '💓 Nhịp tim':                     '💓 Heart Rate',
    '🩸 SpO₂ (Oxy máu)':               '🩸 SpO₂ (Blood Oxygen)',
    '🌡️ Nhiệt độ cơ thể':              '🌡️ Body Temperature',
    '📊 Kiểm tra tình trạng':          '📊 Check Status',
    'Tư Vấn AI':                       'AI Consultation',
    '🌿 Chữa Lành':                    '🌿 Healing',

    // ── Hero section ──────────────────────────────────────────────
    '⊕ AI-Powered Healthcare Platform':'⊕ AI-Powered Healthcare Platform',
    'Hệ Thống Giám Sát &':            'Monitoring &',
    'Phân Tích Sức Khỏe':             'Health Analysis',
    'Thông Minh':                     'Smart',
    'Hệ Thống Giám Sát & Phân Tích Sức Khỏe Thông Minh':
      'Smart Health Monitoring & Analysis System',
    'Giám sát thời gian thực từ IoT · Tư vấn AI 24/7 · Phòng chống đột quỵ & bệnh cấp cứu hiệu quả.':
      'Real-time IoT monitoring · 24/7 AI consultation · Effective stroke & emergency prevention.',
    'Phân Tích Ngay':                 'Analyze Now',
    'Phân Tích Ngay →':               'Analyze Now →',
    'Trải Nghiệm AI':                 'Try AI',
    '📡 Trải Nghiệm AI':              '📡 Try AI',
    '🔍 Phân Tích Ngay':              '🔍 Analyze Now',
    'AI Hỗ Trợ':                      'AI Support',
    'Bước Phân Tích':                 'Analysis Steps',
    'Nhịp Tim':                       'Heart Rate',
    'Nhiệt Độ':                       'Temperature',
    'Trạng thái: Bình thường · ESP32 kết nối':
      'Status: Normal · ESP32 connected',
    'AI Phân Tích':                   'AI Analysis',
    'Hỗ trợ tức thì':                 'Instant support',
    'Dr. AI 24/7':                    'Dr. AI 24/7',

    // ── Feature section ───────────────────────────────────────────
    'Tính Năng':                      'Features',
    'Toàn Bộ Sức Khỏe Trong Một Nền Tảng':
      'Complete Healthcare in One Platform',
    'Từ giám sát IoT thời gian thực đến AI tư vấn thông minh, tất cả được thiết kế để bảo vệ sức khỏe bạn.':
      'From real-time IoT monitoring to smart AI consultation, all designed to protect your health.',
    'Giám Sát IoT Trực Tiếp':         'Live IoT Monitoring',
    'Theo dõi nhịp tim, SpO₂ và nhiệt độ cơ thể realtime từ thiết bị ESP32 qua Firebase.':
      'Monitor heart rate, SpO₂ and body temperature in real time from ESP32 device via Firebase.',
    'Bác Sĩ AI 24/7':                 'AI Doctor 24/7',
    'Chat thông minh với AI hỗ trợ ảnh, giọng nói. Phân tích triệu chứng và tư vấn tức thì.':
      'Smart chat with AI supporting images and voice. Symptom analysis and instant consultation.',
    'Phân Tích AI 7 Bước':            '7-Step AI Analysis',
    'Nhập chỉ số sinh lý, AI đánh giá toàn diện qua 7 bước lâm sàng chính xác và khoa học.':
      'Enter physiological metrics, AI evaluates comprehensively through 7 accurate clinical steps.',
    'Chữa Lành & Thư Giãn':           'Healing & Relaxation',
    'Nội dung cá nhân hoá — nhạc chữa lành, hít thở, hormone hạnh phúc theo chỉ số sức khỏe.':
      'Personalised content — healing music, breathing, happiness hormones based on health metrics.',

    // ── Dashboard preview section ─────────────────────────────────
    'Giao Diện Rõ Ràng,':             'Clear Interface,',
    'Dữ Liệu Tức Thì':               'Instant Data',
    'Giao Diện Rõ Ràng, Dữ Liệu Tức Thì': 'Clear Interface, Instant Data',
    'Mọi chỉ số sức khỏe của bạn được hiển thị trực quan, dễ đọc như phần mềm SaaS chuyên nghiệp.':
      'All your health metrics are displayed visually, as easy to read as professional SaaS software.',
    'Cập Nhật Thời Gian Thực':        'Real-Time Updates',
    'Dữ liệu từ ESP32 qua Firebase Realtime DB':
      'Data from ESP32 via Firebase Realtime DB',
    'Cảnh Báo Thông Minh':            'Smart Alerts',
    'Phát hiện tự động khi chỉ số vượt ngưỡng':
      'Automatic detection when metrics exceed threshold',
    'Phân Tích Xu Hướng':             'Trend Analysis',
    'Biểu đồ lịch sử và dự đoán sức khỏe':
      'Historical charts and health predictions',
    'Chỉ số sức khỏe':                'Health Metrics',
    'Tất cả bình thường':             'All normal',
    'Kết nối ESP32 live':             'ESP32 live connected',
    'Claude AI sẵn sàng':             'Claude AI ready',
    '↑ Bình thường':                  '↑ Normal',
    '✓ Tốt':                          '✓ Good',

    // ── AI Highlight section ──────────────────────────────────────
    'Tư Vấn AI 7 Bước Lâm Sàng':     '7-Step Clinical AI Consultation',
    'Nhập chỉ số nhịp tim, SpO₂, nhiệt độ và triệu chứng — AI phân tích toàn diện qua 7 bước khoa học. Được hỗ trợ bởi Claude AI (Anthropic). Không thay thế chẩn đoán y tế chuyên nghiệp.':
      'Enter heart rate, SpO₂, temperature and symptoms — AI analyses comprehensively through 7 scientific steps. Powered by Claude AI (Anthropic). Does not replace professional medical diagnosis.',

    // ── Article / WHO ─────────────────────────────────────────────
    'Cập nhật 04/12/2025':            'Updated 04/12/2025',
    'Hệ thống giám sát sức khỏe và xử trí khẩn cấp':
      'Health Monitoring & Emergency Response System',
    'Trang này cung cấp thông tin về các bệnh cấp cứu phổ biến như':
      'This page provides information about common emergencies such as',
    'đột quỵ, nhồi máu não, huyết áp cao, sốc, ngưng thở':
      'stroke, brain infarction, high blood pressure, shock, respiratory arrest',
    'và các tình huống khẩn cấp khác. Gọi ngay':
      'and other emergency situations. Call immediately',
    'khi có dấu hiệu cảnh báo!':      'when warning signs appear!',
    'Bài viết & Hướng dẫn sơ cứu':   'Articles & First Aid Guides',
    'Trang chính thức của tổ chức Y tế Thế Giới':
      'Official website of the World Health Organization',
    'WHO (World Health Organization) cung cấp thông tin y tế tin cậy, hướng dẫn xử trí và cập nhật chuyên môn.':
      'WHO (World Health Organization) provides reliable health information, treatment guidelines and professional updates.',
    'Chuyển đến (WHO)':               'Go to (WHO)',

    // ── Video section ─────────────────────────────────────────────
    'Video hướng dẫn (Tìm theo từ khóa)':
      'Instructional Videos (Search by keyword)',
    'Nhập từ khóa (ví dụ: đột quỵ, CPR, ngưng tim) hoặc chọn một video gợi ý bên dưới.':
      'Enter keyword (e.g.: stroke, CPR, cardiac arrest) or select a suggested video below.',
    'Tìm':                            'Search',
    '▶ Xem trên YouTube':             '▶ Watch on YouTube',
    'Xử lý đột quỵ':                  'Stroke Treatment',
    'Xử lý ngưng tim':                'Cardiac Arrest Treatment',
    'Xử lý chảy máu nhiều':           'Heavy Bleeding Treatment',
    'Ngưng thở / Hô hấp khẩn cấp':   'Respiratory Arrest / Emergency Breathing',
    'Nghẹn / Choking':                'Choking',
    'Sơ cứu gãy xương':               'Fracture First Aid',
    'Xử lý tụt huyết áp':            'Low Blood Pressure Treatment',
    'Bấm vào card để xem video trực tiếp trên YouTube. Bạn cũng có thể dán link YouTube vào ô tìm kiếm.':
      'Click a card to watch on YouTube. You can also paste a YouTube link into the search box.',
    '📌 bảng ghi chú y tế':           '📌 medical notes board',
    'Video tìm hiểu sâu hơn':         'In-depth Video Learning',
    'Sử dụng tính năng tìm kiếm video ở trên để xem các hướng dẫn cụ thể.':
      'Use the video search above to view specific guides.',
    'Mẹo:':                           'Tip:',
    'Nhập từ khóa như':               'Enter keywords like',
    '"đột quỵ"':                      '"stroke"',
    '"ngưng tim"':                    '"cardiac arrest"',
    '"chảy máu"':                     '"bleeding"',
    '"gãy xương"':                    '"fracture"',
    'để xem video hướng dẫn xử trí cụ thể.': 'to see specific treatment guides.',

    // ── Emergency cards ───────────────────────────────────────────
    'Các bệnh cấp cứu thường gặp':    'Common Emergency Conditions',
    'Đột quỵ':                        'Stroke',
    'Méo mặt, nói khó, yếu nửa người — cần xử trí trong 3 giờ đầu':
      'Facial drooping, difficulty speaking, weakness — act within the first 3 hours',
    'Nhồi máu cơ tim':                'Heart Attack',
    'Đau ngực, khó thở, nổi mồ hôi — liên hệ cấp cứu ngay':
      'Chest pain, shortness of breath, sweating — call emergency immediately',
    'Huyết áp cao/thấp':              'High/Low Blood Pressure',
    'Chóng mặt, nhức đầu, buồn nôn — cần theo dõi liên tục':
      'Dizziness, headache, nausea — requires continuous monitoring',
    'Ngưng thở/choking':              'Respiratory Arrest / Choking',
    'Không thể nói, mặt tím — thực hiện Heimlich ngay':
      'Unable to speak, blue face — perform Heimlich immediately',
    'Sốc (shock)':                    'Shock',
    'Mất ý thức, mạch yếu, da lạnh — nằm yên và gọi cấp cứu':
      'Loss of consciousness, weak pulse, cold skin — lie still and call emergency',
    'Chảy máu nặng':                  'Severe Bleeding',
    'Chảy máu không dừng, chóng mặt — rằn chặt và nhấc cao':
      'Unstoppable bleeding, dizziness — apply pressure and elevate',
    'Những việc nên làm hằng ngày':   'Daily Health Habits',
    'Kiểm soát huyết áp, đường huyết, cân nặng':
      'Monitor blood pressure, blood sugar, body weight',
    'Ngưng hút thuốc, hạn chế rượu bia, căng thẳng':
      'Quit smoking, limit alcohol and stress',
    'Tập thể dục 30 phút/ngày, ăn nhạt, nhiều rau quả':
      'Exercise 30 min/day, eat less salt, more fruits and vegetables',
    'Kiểm tra sức khỏe định kỳ, theo dõi các triệu chứng lạ':
      'Regular health checkups, monitor unusual symptoms',
    'Cần hỗ trợ không? 🩺':           'Need help? 🩺',

    // ── Health monitoring ─────────────────────────────────────────
    'GIÁM SÁT SỨC KHỎE TRỰC TIẾP':   'LIVE HEALTH MONITORING',
    'Kết nối:':                       'Connected:',
    'Live - Trực tiếp':               'Live',
    'Nhịp tim':                       'Heart Rate',
    'SpO₂':                           'SpO₂',
    'Tình trạng:':                    'Status:',
    'Bình thường':                    'Normal',
    'KIỂM TRA':                       'CHECK',
    'Báo cáo sức khỏe chi tiết':      'Detailed Health Report',
    'Đóng':                           'Close',
    '🔊 Phát lại âm thanh':           '🔊 Replay Audio',
    '⚠ Không bình thường':            '⚠ Abnormal',
    '✓ Bình thường':                  '✓ Normal',
    '⚠ Thấp':                         '⚠ Low',

    // ── AI Chat ───────────────────────────────────────────────────
    'BÁC SĨ AI 24/7 – HỎI GÌ CŨNG TRẢ LỜI':
      'AI DOCTOR 24/7 – ANSWERS EVERYTHING',
    '🎤 Đang nghe...':                 '🎤 Listening...',
    '● AI sức khỏe • Hỗ trợ ảnh & giọng nói':
      '● Health AI • Image & voice support',
    '🗑 Xóa':                          '🗑 Clear',
    'Gửi ảnh':                        'Send image',
    'Giọng nói':                      'Voice',
    'Xóa lịch sử':                    'Clear history',
    'Đọc to':                         'Read aloud',
    'Đang trả lời...':                'Responding...',
    'Nên theo dõi thêm':              'Should monitor further',
    'Đến cơ sở y tế':                 'Visit a medical facility',
    'Có thể xử lý tại nhà':           'Can be managed at home',
    'Đây là tư vấn thông tin, không thay thế bác sĩ':
      'This is informational advice, not a substitute for a doctor',
    '📷 Gửi ảnh để phân tích':        '📷 Send photo for analysis',
    'AI đang phân tích ảnh…':         'AI is analyzing the photo…',
    'Đang xử lý hình ảnh…':           'Processing image…',
    'Đang phân tích sức khỏe…':       'Analyzing health data…',
    'Đang chuẩn bị phản hồi…':        'Preparing response…',

    // ── Health Journal ────────────────────────────────────────────
    '📓 Nhật Ký Sức Khỏe AI':         '📓 AI Health Journal',
    'AI Powered':                     'AI Powered',
    '🎬 Video tìm hiểu sâu hợn':      '🎬 In-Depth Video Learning',
    '▶ Tìm':                          '▶ Search',
    'Nhập từ khóa hoặc chọn video gợi ý — bấm ẵ mở YouTube':
      'Enter keyword or select suggested video — click to open YouTube',
    'Bấm để xem trên YouTube ↗':      'Click to watch on YouTube ↗',
    'Ngưng tim':                      'Cardiac Arrest',
    'Chảy máu':                       'Bleeding',
    'Ngưng thở':                      'Respiratory Arrest',
    'Nghẹn':                          'Choking',
    'Huyết áp':                       'Blood Pressure',
    'Tạo Nhật Ký Sức Khỏe AI':       'Create AI Health Journal',
    '✓ Đồng bộ':                      '✓ Synced',
    'Nhiệt độ':                       'Temperature',
    '(giờ)':                          '(hrs)',
    'Giấc ngủ':                       'Sleep',
    'Mức độ stress':                  'Stress Level',
    'Ghi chú thêm':                   'Additional Notes',
    '(tùy chọn)':                     '(optional)',
    '📝 Tạo Nhật Ký AI':              '📝 Create AI Journal',
    'AI đang phân tích & viết nhật ký sức khỏe của bạn...':
      'AI is analyzing & writing your health journal...',
    '📋 Lịch sử nhật ký':             '📋 Journal History',
    'Xóa tất cả':                     'Clear All',
    '✦ Tạo Nhật Ký AI':              '✦ Create AI Journal',
    'Xóa toàn bộ lịch sử?':          'Clear all history?',
    'Xóa toàn bộ lịch sử hội thoại?':'Clear all conversation history?',

    // ── AI Analysis 7-step ────────────────────────────────────────
    '🤖 TƯ VẤN AI — HỆ THỐNG PHÂN TÍCH SỨC KHỎE THÔNG MINH 7 BƯỚC':
      '🤖 AI CONSULTATION — 7-STEP SMART HEALTH ANALYSIS SYSTEM',
    'Lưu ý:':                         'Note:',
    'Công cụ hỗ trợ đánh giá ban đầu — không thay thế chẩn đoán y tế chuyên nghiệp. Gọi':
      'Initial assessment tool — does not replace professional medical diagnosis. Call',
    'khi có dấu hiệu khẩn cấp!':      'when emergency signs appear!',
    '📋 Nhập Dữ Liệu Sinh Lý':        '📋 Enter Physiological Data',
    'Nhịp Tim':                       'Heart Rate',
    'Nhiệt Độ Cơ Thể':                'Body Temperature',
    'Trạng Thái Cảm Xúc':             'Emotional State',
    'Căng thẳng':                     'Stressed',
    'Lo âu':                          'Anxious',
    'Buồn bã':                        'Sad',
    'Mệt mỏi':                        'Fatigued',
    'Đau nhức':                       'In Pain',
    'Triệu Chứng':                    'Symptoms',
    'Tiền Sử / Lịch Sử Gần Đây':     'Medical History / Recent History',
    'Nhập chỉ số của bạn để AI phân tích':
      'Enter your metrics for AI analysis',
    '⊕ PHÂN TÍCH BẰNG AI':            '⊕ ANALYZE WITH AI',
    'Đang Phân Tích Dữ Liệu...':      'Analyzing Data...',
    'Hệ thống AI đang xử lý chỉ số sức khỏe của bạn':
      'AI system is processing your health metrics',
    '→ Đánh giá các chỉ số sinh lý...': '→ Evaluating physiological metrics...',
    '→ Phân tích trạng thái tâm lý...': '→ Analyzing psychological state...',
    '→ Nhận diện pattern triệu chứng...':'→ Identifying symptom patterns...',
    '→ Phân tầng nguy cơ lâm sàng...':  '→ Stratifying clinical risk...',
    '→ Tổng hợp biện pháp khuyến nghị...':'→ Synthesizing recommendations...',
    '📊 Đánh Giá Chỉ Số Sinh Lý':     '📊 Physiological Metrics Assessment',
    '🧠 Phân Tích Tâm Lý':            '🧠 Psychological Analysis',
    '🔄 Sơ Đồ Suy Luận':              '🔄 Reasoning Diagram',
    '🔬 Giả Thuyết Nguy Cơ — Differential Reasoning':
      '🔬 Risk Hypotheses — Differential Reasoning',
    '📋 Biện Pháp Đề Nghị':           '📋 Recommended Measures',
    '✨ Can Thiệp Tinh Thần — AI Healing':'✨ Mental Intervention — AI Healing',
    '📏 Phạm Vi Chỉ Số Bình Thường':  '📏 Normal Metrics Range',
    '❤️ Nhịp Tim':                    '❤️ Heart Rate',
    '🌡️ Nhiệt Độ':                    '🌡️ Temperature',
    '⚡ Khẩn cấp HR':                  '⚡ Emergency HR',
    '🚨 Sốt cao':                      '🚨 High Fever',
    '⛔ SpO₂ nguy hiểm':               '⛔ Dangerous SpO₂',
    '⚙️ Quy Trình Phân Tích 7 Bước':  '⚙️ 7-Step Analysis Process',
    'BƯỚC 1–3':                       'STEPS 1–3',
    'Đánh giá sinh lý, phân tích tâm lý, nhận diện pattern triệu chứng':
      'Physiological assessment, psychological analysis, symptom pattern recognition',
    'BƯỚC 4–5':                       'STEPS 4–5',
    'Phân tầng nguy cơ, sơ đồ suy luận lâm sàng':
      'Risk stratification, clinical reasoning diagram',
    'BƯỚC 6–7':                       'STEPS 6–7',
    'Biện pháp khuyến nghị & can thiệp tinh thần':
      'Recommended measures & mental intervention',
    '🤖 Được hỗ trợ bởi Claude AI (Anthropic)':
      '🤖 Powered by Claude AI (Anthropic)',
    'Mô hình AI suy luận lâm sàng theo quy trình khoa học. Kết quả chỉ mang tính tham khảo ban đầu.':
      'AI clinical reasoning model following a scientific process. Results are for initial reference only.',
    '🚑 Gọi Cấp Cứu Ngay':            '🚑 Call Emergency Now',
    'Khi: đau ngực dữ dội, khó thở cấp, bất tỉnh, SpO₂ < 90%, nhịp tim bất thường nghiêm trọng':
      'When: severe chest pain, acute shortness of breath, unconsciousness, SpO₂ < 90%, seriously abnormal heart rate',

    // ── Dynamic analysis results ──────────────────────────────────
    'Đang phân tích...':              'Analyzing...',
    '🔍 PHÂN TÍCH NGAY':              '🔍 ANALYZE NOW',
    'Chỉ số trong giới hạn tham chiếu.':  'Metrics within reference range.',
    'Các chỉ số trong ngưỡng bình thường.':'All metrics within normal range.',
    'Trạng thái tâm lý bình thường.': 'Normal psychological state.',
    'Không có tác động sinh lý đáng kể.': 'No significant physiological impact.',
    'Trạng Thái Sinh Lý Bình Thường': 'Normal Physiological State',
    'Không phát hiện bất thường rõ ràng.': 'No obvious abnormalities detected.',
    'Các chỉ số trong ngưỡng tham chiếu.': 'Metrics within reference range.',
    'Không có dấu hiệu nguy cơ cấp.': 'No acute risk signs.',
    'Khuyến nghị: duy trì thói quen lành mạnh.':
      'Recommendation: maintain healthy habits.',
    'Theo dõi định kỳ và gọi 115 nếu có triệu chứng bất thường.':
      'Monitor regularly and call 115 if abnormal symptoms occur.',
    'Nghỉ ngơi và uống đủ nước':      'Rest and stay hydrated',
    'Tránh gắng sức nếu mệt':         'Avoid exertion if tired',
    'Theo dõi triệu chứng':           'Monitor symptoms',
    'Đo lại chỉ số sau 2–4 giờ':      'Re-check metrics after 2–4 hours',
    'Ghi nhật ký sức khỏe':           'Keep a health journal',
    'Ngủ đủ 7–8 giờ/đêm':             'Sleep 7–8 hours/night',
    'Đến khám nếu triệu chứng kéo dài >3 ngày':
      'See a doctor if symptoms persist >3 days',
    'Đo điện tim nếu nhịp bất thường': 'Get an ECG if heart rhythm is abnormal',
    'Xét nghiệm máu định kỳ hàng năm': 'Annual blood tests',
    'CẢNH BÁO!':                      'WARNING!',
    'Vui lòng điền đầy đủ Nhịp Tim, Nhiệt Độ và SpO₂.':
      'Please fill in Heart Rate, Temperature and SpO₂.',
    'Lỗi phân tích: ':                'Analysis error: ',
    'Thấp':                           'Low',
    'Trung Bình':                     'Moderate',
    'Nhịp Chậm':                      'Bradycardia',
    'Nhịp dưới 50 bpm (nhịp chậm), theo dõi triệu chứng đi kèm.':
      'Heart rate below 50 bpm (bradycardia), monitor accompanying symptoms.',
    'Hơi Nhanh':                      'Slightly Fast',
    'Nhịp tim cao nhẹ, có thể do stress, vận động hoặc mất nước.':
      'Slightly elevated heart rate, may be due to stress, exercise or dehydration.',
    'Nhanh — Theo Dõi':               'Fast — Monitor',
    'Nhịp nhanh (>110 bpm), cần kiểm tra nguyên nhân.':
      'Tachycardia (>110 bpm), cause should be investigated.',
    'Hơi Thấp':                       'Slightly Low',
    'Nhiệt độ dưới mức bình thường, có thể do lạnh hoặc suy kiệt.':
      'Temperature below normal, may be due to cold or exhaustion.',
    'Sốt Nhẹ':                        'Mild Fever',
    'Sốt nhẹ, cơ thể đang phản ứng miễn dịch. Uống nhiều nước.':
      'Mild fever, immune response. Drink plenty of water.',
    'Sốt Trung Bình':                 'Moderate Fever',
    'Sốt vừa, theo dõi sát và hạ sốt nếu khó chịu.':
      'Moderate fever, monitor closely and reduce fever if uncomfortable.',
    'Thấp Nhẹ':                       'Slightly Low',
    'SpO₂ 90–94%, cần kiểm tra hô hấp và ngồi nghỉ ngơi.':
      'SpO₂ 90–94%, check breathing and rest.',
    'SpO₂ sát ngưỡng, theo dõi và tránh gắng sức.':
      'SpO₂ near threshold, monitor and avoid exertion.',
    'Suy Giảm Oxy Máu':               'Blood Oxygen Deficiency',
    'SpO₂ thấp gợi ý vấn đề hô hấp hoặc tuần hoàn cần đánh giá.':
      'Low SpO₂ suggests respiratory or circulatory issues needing assessment.',
    'Rối Loạn Nhịp Tim':              'Heart Rhythm Disorder',
    'Nhịp tim bất thường có thể do rối loạn điện giải, mất nước hoặc vấn đề tim mạch.':
      'Abnormal heart rate may be due to electrolyte disorder, dehydration or cardiac issues.',
    'Phản Ứng Nhiễm Trùng / Viêm':   'Infection / Inflammatory Response',
    'Sốt cao hoặc hạ thân nhiệt gợi ý phản ứng viêm hoặc bệnh nhiễm trùng.':
      'High fever or hypothermia suggests inflammatory response or infectious disease.',
    'Rối Loạn Lo Âu / Stress Cấp':   'Anxiety Disorder / Acute Stress',
    'Trạng thái lo âu/stress cao ảnh hưởng trực tiếp lên nhịp tim và hô hấp.':
      'High anxiety/stress directly affects heart rate and breathing.',
    'Tăng Áp Lực Nội Sọ / Đau Đầu Căng Thẳng':
      'Increased Intracranial Pressure / Tension Headache',
    'Đau đầu trong bối cảnh này thường liên quan đến căng thẳng hoặc huyết áp.':
      'Headache in this context is often related to stress or blood pressure.',
    'Mệt Mỏi Sinh Lý':               'Physiological Fatigue',
    'Tình trạng chung do thiếu ngủ, mất nước hoặc gắng sức quá mức.':
      'General condition due to sleep deprivation, dehydration or excessive exertion.',
    'Trạng Thái Sức Khỏe Ổn Định':   'Stable Health State',
    'Không phát hiện dấu hiệu bệnh lý rõ ràng dựa trên chỉ số hiện tại.':
      'No obvious pathological signs based on current metrics.',
    '⚠ NGUY CƠ – Cần chú ý y tế':   '⚠ RISK – Medical attention needed',
    '⚡ CẦN THEO DÕI – Có dấu hiệu bất thường':
      '⚡ MONITOR – Abnormal signs detected',
    'Liên hệ bác sĩ hoặc gọi 115 nếu triệu chứng xấu đi.':
      'Contact a doctor or call 115 if symptoms worsen.',
    'Nghỉ ngơi, uống nước, đo lại sau 2-4 giờ.':
      'Rest, drink water, re-check after 2-4 hours.',
    'Duy trì lối sống lành mạnh và theo dõi định kỳ.':
      'Maintain a healthy lifestyle and monitor regularly.',
    'Gọi 115 ngay nếu đau ngực, khó thở hoặc mất ý thức':
      'Call 115 immediately if chest pain, shortness of breath or loss of consciousness',
    'Ngồi hoặc nằm yên ở vị trí thoải mái, không gắng sức':
      'Sit or lie still in a comfortable position, avoid exertion',
    'Thông báo ngay cho người thân hoặc người xung quanh':
      'Immediately notify family members or nearby people',
    'Nghỉ ngơi hoàn toàn trong 30–60 phút':
      'Rest completely for 30–60 minutes',
    'Uống 1–2 ly nước (trừ khi có chống chỉ định)':
      'Drink 1–2 glasses of water (unless contraindicated)',
    'Đo lại các chỉ số sau 30 phút': 'Re-check all metrics after 30 minutes',
    'Hít thở sâu và thư giãn 5 phút': 'Deep breathing and relax for 5 minutes',
    'Uống đủ nước (8 ly/ngày)':       'Stay hydrated (8 glasses/day)',
    'Duy trì nhịp sinh hoạt đều đặn': 'Maintain a regular daily routine',
    'Đo nhịp tim và SpO₂ mỗi 4 giờ nếu chỉ số hiện tại bất thường':
      'Check heart rate and SpO₂ every 4 hours if current metrics are abnormal',
    'Ghi nhật ký triệu chứng: thời gian, mức độ, yếu tố kích phát':
      'Log symptoms: time, severity, triggers',
    'Theo dõi nhiệt độ 2 lần/ngày nếu đang sốt':
      'Monitor temperature twice daily if having a fever',
    'Đến viện ngay hôm nay hoặc gọi 115':
      'Go to hospital today or call 115',
    'Mang theo toàn bộ lịch sử chỉ số từ thiết bị':
      'Bring full metric history from your device',
    'Không lái xe một mình nếu chóng mặt hoặc yếu người':
      'Do not drive alone if dizzy or weak',
    'Đặt lịch khám trong 1–3 ngày nếu triệu chứng không cải thiện':
      'Schedule a checkup within 1–3 days if symptoms do not improve',
    'Xét nghiệm máu cơ bản nếu sốt kéo dài >3 ngày':
      'Basic blood test if fever persists >3 days',
    'Đo điện tim (ECG) nếu nhịp tim bất thường tái phát':
      'ECG if abnormal heart rhythm recurs',
    'Không xác định được.':           'Could not be determined.',
    'Vui lòng thử lại.':              'Please try again.',
    'Không xác định':                 'Unknown',
    'Engine gặp lỗi khi phân tích.':  'Engine error during analysis.',
    'Dữ liệu đã nhận.':               'Data received.',
    'Engine gặp lỗi khi xử lý.':      'Engine processing error.',
    'Vui lòng kiểm tra lại chỉ số và thử lại.':
      'Please check your metrics and try again.',
    'Nếu vẫn lỗi, tải lại trang.':   'If still failing, reload the page.',
    'Gọi 115 nếu có triệu chứng nguy hiểm.':
      'Call 115 if dangerous symptoms appear.',
    'Cơ thể đang mệt mỏi, cần phục hồi năng lượng.':
      'Body is fatigued, needs energy recovery.',
    'Mệt mỏi kéo dài làm giảm miễn dịch và tăng nhịp tim nhẹ.':
      'Prolonged fatigue reduces immunity and slightly increases heart rate.',
    'Trạng thái buồn bã có thể kéo theo thiếu ngủ và ăn kém.':
      'Sadness can lead to sleep deprivation and poor appetite.',
    'Cảm xúc tiêu cực ảnh hưởng đến hệ tim mạch và miễn dịch.':
      'Negative emotions affect the cardiovascular system and immunity.',
    'Lo âu mức trung bình đến cao, hệ thần kinh đang cảnh giác quá mức.':
      'Moderate to high anxiety, nervous system is over-alert.',
    'Lo âu làm tăng cortisol, có thể gây nhịp tim nhanh và huyết áp tăng.':
      'Anxiety increases cortisol, which can cause rapid heart rate and elevated blood pressure.',
    'Đau nhức tạo gánh nặng sinh lý và tâm lý đồng thời.':
      'Pain creates simultaneous physiological and psychological burden.',
    'Cơn đau kéo dài có thể làm tăng nhịp tim và huyết áp theo phản xạ.':
      'Prolonged pain can reflexively increase heart rate and blood pressure.',

    // ── Healing section ───────────────────────────────────────────
    'AI GENERATED':                   'AI GENERATED',
    'Chữa Lành & Thư Giãn AI':       'AI Healing & Relaxation',
    'Nội dung cá nhân hoá theo chỉ số sức khỏe của bạn — cập nhật tự động':
      'Personalized content based on your health metrics — auto-updated',
    '▸ Đang phân tích chỉ số...':     '▸ Analyzing metrics...',
    'Đang phân tích dữ liệu sức khỏe...': 'Analyzing health data...',
    'Vận động · Thành tích':          'Movement · Achievement',
    'Ánh sáng · Thiên nhiên':         'Sunlight · Nature',
    'Ôm · Kết nối':                   'Hugs · Connection',
    'Cười · Tập thể dục':             'Laughter · Exercise',
    '■ Dừng':                         '■ Stop',
    'Chi tiết':                       'Details',
    'Kỹ thuật 4-7-8':                 '4-7-8 Technique',
    'Kích hoạt hệ thần kinh phó giao cảm, giảm nhiệt và nhịp tim. Khuyến nghị khi sốt và lo âu.':
      'Activates parasympathetic nervous system, reduces heat and heart rate. Recommended for fever and anxiety.',
    'Hít vào':                        'Inhale',
    'Giữ hơi':                        'Hold',
    'Thở ra':                         'Exhale',
    'Thở hộp vuông':                  'Box Breathing',
    'Phương pháp Navy SEALs. 4 bước đều nhau giúp kiểm soát lo âu và tăng tập trung.':
      'Navy SEALs method. 4 equal steps help control anxiety and increase focus.',
    'Nghỉ':                           'Rest',
    'Chúng ta đang an toàn.':         'We are safe.',
    'SỐT — ĐANG PHỤC HỒI':           'FEVER — RECOVERING',
    'CĂNG THẲNG CAO':                 'HIGH STRESS',
    'MỆT MỎI':                        'FATIGUE',
    'BÌNH THƯỜNG':                    'NORMAL',
    '■ DỪNG':                         '■ STOP',
    ' giây':                          ' sec',
    'Sẵn sàng':                       'Ready',
    '▶ BẮT ĐẦU':                      '▶ START',
    'Nhạc piano thiền định 70–90 BPM':'Meditation piano 70–90 BPM',
    'Video bài tập thở buổi sáng 10 phút':
      'Morning breathing exercise video 10 minutes',
    'Thở bụng: hít sâu 6 giây, thở ra 6 giây':
      'Belly breathing: inhale deep 6 sec, exhale 6 sec',
    'Chăm sóc bản thân là ưu tiên hàng đầu. Bạn đang làm rất tốt!':
      'Self-care is the top priority. You are doing great!',
    'Nhạc thiên nhiên nhẹ (sóng biển, rừng) — 40–60 BPM, không giai điệu phức tạp':
      'Light nature sounds (ocean, forest) — 40–60 BPM, no complex melody',
    'Video hướng dẫn thở hoặc thiền định cơ bản 5 phút':
      'Basic breathing or meditation guide video 5 minutes',
    'Thở 4-7-8: hít 4 giây, giữ 7 giây, thở ra 8 giây — lặp 4 lần':
      '4-7-8 breathing: inhale 4 sec, hold 7 sec, exhale 8 sec — repeat 4 times',
    'Cơ thể bạn đang gửi tín hiệu quan trọng. Hãy lắng nghe và tìm sự hỗ trợ y tế sớm.':
      'Your body is sending important signals. Listen and seek medical support soon.',
    'Lo-fi healing 60–80 BPM, instrumental nhẹ nhàng, không lời':
      'Lo-fi healing 60–80 BPM, gentle instrumental, no lyrics',
    'Video yoga nhẹ hoặc stretching 10 phút cho cơ thể mệt mỏi':
      'Light yoga or stretching video 10 minutes for a tired body',
    'Thở hộp vuông (box breathing): 4-4-4-4 — hít-giữ-thở ra-nghỉ':
      'Box breathing: 4-4-4-4 — inhale-hold-exhale-rest',
    'Cơ thể cần được nghỉ ngơi. Một giấc ngủ ngon và đủ nước là liều thuốc tốt nhất.':
      'Your body needs rest. A good sleep and proper hydration are the best medicine.',
    'Thở bụng (diaphragmatic): hít sâu 6 giây bụng phình, thở ra 6 giây bụng xẹp':
      'Diaphragmatic breathing: inhale deep 6 sec belly out, exhale 6 sec belly in',
    'Sức khỏe của bạn đang tốt! Duy trì thói quen lành mạnh và tiếp tục theo dõi định kỳ.':
      'Your health is good! Maintain healthy habits and continue regular monitoring.',

    // ── Chat quick replies & dynamic content ──────────────────────
    'Hướng dẫn CPR':                  'CPR Guide',
    'Dấu hiệu đột quỵ':               'Stroke Signs',
    'Sốt 38 độ':                      'Fever 38°C',
    'Sốt 39 độ':                      'Fever 39°C',
    'Chưa đo nhiệt độ':               'Temperature not measured',
    'Liều paracetamol bao nhiêu?':    'What is the paracetamol dose?',
    'Có cần nhập viện không?':        'Do I need hospitalization?',
    'Sốt bao lâu rồi?':               'How long have I had fever?',
    'Có triệu chứng nào khác không?': 'Any other symptoms?',
    'Có ho thêm':                     'Also coughing',
    'Đau đầu thêm':                   'Also headache',
    'Chỉ sốt thôi':                   'Only fever',
    'Tim đập nhanh':                  'Rapid heartbeat',
    'Tim đập loạn':                   'Irregular heartbeat',
    'Đau tức ngực':                   'Chest tightness/pain',
    'Gọi 115':                        'Call 115',
    'Tôi không đau ngực':             'I have no chest pain',
    'Vừa tập thể dục':                'Just exercised',
    'Đang căng thẳng':                'Currently stressed',
    'Không vận động gì':              'No physical activity',
    'Gọi 115 ngay':                   'Call 115 now',
    'Khó thở khi nằm':                'Shortness of breath when lying down',
    'Có tiếng khò khè':               'Wheezing',
    'Khó thở cả ngày':                'Shortness of breath all day',
    'Đau thái dương':                 'Temple pain',
    'Đau sau gáy':                    'Back of neck pain',
    'Đau đầu + buồn nôn':             'Headache + nausea',
    'Đau thượng vị':                  'Epigastric pain',
    'Tiêu chảy nhiều lần':            'Frequent diarrhea',
    'Buồn nôn không nôn được':        'Nausea without vomiting',
    'Mất ngủ nhiều ngày':             'Insomnia for many days',
    'Lo lắng không rõ nguyên nhân':   'Anxiety without clear cause',
    'Mệt mỏi toàn thân':              'Whole-body fatigue',
    'Huyết áp 150/90':                'Blood pressure 150/90',
    'Đau đầu gáy':                    'Neck/occipital headache',
    'Chóng mặt':                      'Dizziness',
    'Cầm máu vết thương':             'Stop wound bleeding',
    'Sơ cứu bỏng':                    'Burns first aid',
    'Nghẹn hóc dị vật':               'Choking on foreign object',
    'CPR ngưng tim':                  'Cardiac arrest CPR',
    'Tôi đang bị sốt':                'I have a fever',
    'Tim đập bất thường':             'Abnormal heartbeat',
    'Khó thở':                        'Shortness of breath',
    'Đau đầu':                        'Headache',
    'Hỏi thêm về sức khỏe':          'Ask more about health',
    'Kiểm tra chỉ số hiện tại':       'Check current metrics',
    'Phân tích nhịp tim':             'Analyze heart rate',
    'Kiểm tra SpO₂':                  'Check SpO₂',
    'Giải thích về nhịp tim':         'Explain heart rate',
    'Khi nào cần gọi 115?':           'When should I call 115?',
    'Đang cảm thấy ổn':               'Feeling fine',
    'Có thêm triệu chứng':            'More symptoms',
    'Cần gọi 115?':                   'Need to call 115?',
    'Tôi bị sốt':                     'I have a fever',
    'Triệu chứng mới xuất hiện':      'New symptoms appeared',
    'Đã uống thuốc rồi':              'Already took medicine',
    'Cần đi khám không?':             'Should I see a doctor?',
    'Hỏi triệu chứng mới':            'Ask about new symptoms',
    'Xem chỉ số hiện tại':            'View current metrics',

    // ── Days / time ───────────────────────────────────────────────
    'Chủ Nhật': 'Sunday',
    'Thứ Hai':  'Monday',
    'Thứ Ba':   'Tuesday',
    'Thứ Tư':   'Wednesday',
    'Thứ Năm':  'Thursday',
    'Thứ Sáu':  'Friday',
    'Thứ Bảy':  'Saturday',
    'buổi sáng':'morning',
    'buổi trưa':'noon',
    'buổi chiều':'afternoon',
    'buổi tối': 'evening',

    // ── Footer ────────────────────────────────────────────────────
    'Healing AI':                     'Healing AI',
    'Hệ thống giám sát và phân tích sức khỏe thông minh. Cung cấp thông tin y tế tin cậy, tư vấn AI 24/7 và giám sát sức khỏe thời gian thực.':
      'Smart health monitoring and analysis system. Reliable medical information, 24/7 AI consultation and real-time health monitoring.',
    'Hệ thống giám sát và phân tích sức khỏe thông minh. Cung cấp thông tin y tế tin cậy, tư vấn AI 24/7 ':
      'Smart health monitoring and analysis system. Reliable medical information, 24/7 AI consultation ',
    '● Đang hoạt động':              '● Active',
    'Gọi cấp cứu:':                  'Emergency call:',
    'Điều hướng':                     'Navigation',
    'Liên kết hữu ích':              'Useful Links',
    'WHO – Tổ chức Y tế Thế giới':   'WHO – World Health Organization',
    'Bộ Y tế Việt Nam':              'Vietnam Ministry of Health',
    'Bệnh viện 108':                  '108 Military Hospital',
    'Bệnh viện Bạch Mai':             'Bach Mai Hospital',
    'Khẩn cấp':                       'Emergency',
    '🚨 Cấp cứu 115':                 '🚨 Emergency 115',
    'Gọi ngay khi có dấu hiệu nguy hiểm':
      'Call immediately when danger signs appear',
    '🔴 Đột quỵ: F.A.S.T':           '🔴 Stroke: F.A.S.T',
    'Face · Arms · Speech · Time':   'Face · Arms · Speech · Time',
    '© 2025 Sức Khỏe 24H. Thông tin chỉ mang tính chất tham khảo.':
      '© 2025 HealthAI Pro. Information is for reference only.',
    'Dữ liệu từ ESP32 · Firebase Realtime DB · AI Engine Nội Bộ (Offline-ready)':
      'Data from ESP32 · Firebase Realtime DB · Internal AI Engine (Offline-ready)',

    // ── Placeholders ──────────────────────────────────────────────
    'Nhập từ khóa hoặc dán link YouTube...':
      'Enter keyword or paste YouTube link...',
    'Mô tả triệu chứng...':           'Describe symptoms...',
    'vd: 7 giờ':                      'e.g.: 7 hrs',
    'mô tả triệu chứng nếu có...':   'describe symptoms if any...',
    'tiền sử, hoạt động gần đây...':  'medical history, recent activities...',

    // ── Title / aria attributes ───────────────────────────────────
    'Tiếng Việt':                     'Vietnamese',
    'Dopamine — Phần thưởng & Động lực': 'Dopamine — Reward & Motivation',
    'Serotonin — Hạnh phúc & Bình yên':  'Serotonin — Happiness & Peace',
    'Oxytocin — Kết nối & Yêu thương':   'Oxytocin — Connection & Love',
    'Endorphin — Giảm đau & Vui vẻ':     'Endorphin — Pain Relief & Joy',

    // ── Misc dynamic strings ──────────────────────────────────────
    'Ghi chú:':                       'Note:',
    'Dữ liệu từ ESP32/Firebase. Nếu "Xấu" vui lòng gọi':
      'Data from ESP32/Firebase. If "Bad" please call',
    'Xấu':                            'Bad',
  };

  /* ═══════════════════════════════════════════════════════════════
     §2  SORTED KEYS  (dài trước, ngắn sau)
         Tránh partial-match: "Nhịp Tim" không thay trong
         "Nhịp Tim bất thường" nếu key dài hơn được thử trước
  ═══════════════════════════════════════════════════════════════ */
  /** @type {string[]} */
  var KEYS_VI = Object.keys(D).sort(function (a, b) { return b.length - a.length; });

  /* ═══════════════════════════════════════════════════════════════
     §3  REVERSE DICTIONARY  (English → Vietnamese)
         Xây tự động từ D
  ═══════════════════════════════════════════════════════════════ */
  var D_REV = {};
  KEYS_VI.forEach(function (vi) { D_REV[D[vi]] = vi; });
  var KEYS_EN = Object.keys(D_REV).sort(function (a, b) { return b.length - a.length; });

  /* ═══════════════════════════════════════════════════════════════
     §4  STATE
  ═══════════════════════════════════════════════════════════════ */
  var LS_KEY      = 'healthai_lang';
  var LANG_EN     = 'en';
  var LANG_VI     = 'vi';
  var currentLang = LANG_VI;

  /* Tags whose content we NEVER touch */
  var SKIP = { SCRIPT:1, STYLE:1, NOSCRIPT:1, CODE:1, PRE:1, SVG:1, MATH:1 };

  /* WeakMap: text-node → original string (set once, never overwritten) */
  var nodeOrigin = typeof WeakMap !== 'undefined' ? new WeakMap() : null;

  /* WeakMap: element → { attr: originalValue } */
  var attrOrigin = typeof WeakMap !== 'undefined' ? new WeakMap() : null;

  /* ═══════════════════════════════════════════════════════════════
     §5  CORE HELPERS
  ═══════════════════════════════════════════════════════════════ */

  /**
   * applyDict(str, dict, keys) → translated string
   * Chiến lược:
   *  1. Exact match (trimmed)
   *  2. Substring replace (theo thứ tự key dài → ngắn)
   */
  function applyDict(str, dict, keys) {
    var trimmed = str.trim();
    // 1. Exact match
    if (dict[trimmed] !== undefined) {
      // Giữ nguyên whitespace bao quanh
      var lead  = str.match(/^(\s*)/)[1];
      var trail = str.match(/(\s*)$/)[1];
      return lead + dict[trimmed] + trail;
    }
    // 2. Substring replace
    var result = str;
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      if (result.indexOf(k) !== -1) {
        // Escape special regex chars
        var escaped = k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        result = result.replace(new RegExp(escaped, 'g'), dict[k]);
      }
    }
    return result !== str ? result : null; // null nếu không thay gì cả
  }

  /**
   * Translate a single text node
   */
  function translateTextNode(node, dict, keys) {
    var raw = node.nodeValue;
    if (!raw || !raw.trim()) return;
    // Lưu gốc một lần duy nhất
    if (nodeOrigin && !nodeOrigin.has(node)) nodeOrigin.set(node, raw);
    var result = applyDict(raw, dict, keys);
    if (result !== null) node.nodeValue = result;
  }

  /**
   * Restore a text node về gốc
   */
  function restoreTextNode(node) {
    if (!nodeOrigin) return;
    var orig = nodeOrigin.get(node);
    if (orig !== undefined) node.nodeValue = orig;
  }

  /**
   * Translate attributes: placeholder, title, aria-label, aria-placeholder, alt, value(button/submit)
   */
  var ATTRS = ['placeholder', 'title', 'aria-label', 'aria-placeholder', 'alt'];

  function translateAttrs(el, dict, keys) {
    ATTRS.forEach(function (attr) {
      var val = el.getAttribute(attr);
      if (!val) return;
      // Lưu gốc
      if (attrOrigin) {
        var saved = attrOrigin.get(el) || {};
        if (!saved[attr]) { saved[attr] = val; attrOrigin.set(el, saved); }
      }
      var result = applyDict(val, dict, keys);
      if (result !== null) el.setAttribute(attr, result);
    });
  }

  function restoreAttrs(el) {
    if (!attrOrigin) return;
    var saved = attrOrigin.get(el);
    if (!saved) return;
    Object.keys(saved).forEach(function (attr) {
      el.setAttribute(attr, saved[attr]);
    });
  }

  /**
   * Walk subtree: duyệt text nodes + elements có attr cần dịch
   */
  function walk(root, toEN) {
    var dict = toEN ? D     : D_REV;
    var keys = toEN ? KEYS_VI : KEYS_EN;

    // ── Text nodes ──
    var tw = document.createTreeWalker(
      root,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode: function (n) {
          var p = n.parentNode;
          while (p && p !== root) {
            if (p.nodeType === 1 && SKIP[p.tagName]) return NodeFilter.FILTER_REJECT;
            p = p.parentNode;
          }
          return NodeFilter.FILTER_ACCEPT;
        }
      },
      false
    );
    var n;
    while ((n = tw.nextNode())) {
      if (toEN) translateTextNode(n, dict, keys);
      else      restoreTextNode(n);
    }

    // ── Attribute-bearing elements ──
    var sel = '[placeholder],[title],[aria-label],[aria-placeholder],[alt]';
    var els = root.querySelectorAll ? root.querySelectorAll(sel) : [];
    for (var i = 0; i < els.length; i++) {
      if (SKIP[els[i].tagName]) continue;
      if (toEN) translateAttrs(els[i], dict, keys);
      else      restoreAttrs(els[i]);
    }
    // Root element itself
    if (root.getAttribute) {
      if (toEN) translateAttrs(root, dict, keys);
      else      restoreAttrs(root);
    }
  }

  /* ═══════════════════════════════════════════════════════════════
     §6  PUBLIC API  —  changeLanguage(lang)
  ═══════════════════════════════════════════════════════════════ */
  window.changeLanguage = function (lang) {
    currentLang = lang;
    localStorage.setItem(LS_KEY, lang);

    // Tắt observer tạm (tránh vòng lặp vô tận khi chúng ta tự sửa DOM)
    observer.disconnect();

    if (lang === LANG_EN) {
      walk(document.body, true);
    } else {
      walk(document.body, false);
    }

    // Bật lại observer
    observer.observe(document.body, OBS_CONFIG);

    _updateButtons(lang);
  };

  /* ═══════════════════════════════════════════════════════════════
     §7  MUTATION OBSERVER  —  tự động dịch content JS thêm vào
  ═══════════════════════════════════════════════════════════════ */
  var OBS_CONFIG = { childList: true, subtree: true };

  var observer = new MutationObserver(function (mutations) {
    if (currentLang === LANG_VI) return; // không cần làm gì

    // Tắt observer trong khi xử lý để tránh recursive trigger
    observer.disconnect();

    mutations.forEach(function (m) {
      m.addedNodes.forEach(function (added) {
        if (added.nodeType === 1) {          // Element node
          walk(added, true);
        } else if (added.nodeType === 3) {   // Text node
          translateTextNode(added, D, KEYS_VI);
        }
      });
    });

    observer.observe(document.body, OBS_CONFIG);
  });

  observer.observe(document.body, OBS_CONFIG);

  /* ═══════════════════════════════════════════════════════════════
     §8  BUTTON STATE
  ═══════════════════════════════════════════════════════════════ */
  function _updateButtons(lang) {
    var bVN = document.getElementById('langBtnVN');
    var bEN = document.getElementById('langBtnEN');
    if (!bVN || !bEN) return;
    bVN.classList.toggle('active', lang === LANG_VI);
    bEN.classList.toggle('active', lang === LANG_EN);
  }

  /* ═══════════════════════════════════════════════════════════════
     §9  INIT  —  khôi phục ngôn ngữ đã lưu sau reload
  ═══════════════════════════════════════════════════════════════ */
  function _init() {
    var saved = localStorage.getItem(LS_KEY) || LANG_VI;
    currentLang = saved;
    _updateButtons(saved);
    if (saved === LANG_EN) {
      // Tắt observer trước khi dịch lần đầu
      observer.disconnect();
      walk(document.body, true);
      observer.observe(document.body, OBS_CONFIG);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', _init);
  } else {
    _init();
  }

}());
</script>

<!-- ═══════════════════════════════════════════════
     THEME SETTINGS FAB BUTTON
═══════════════════════════════════════════════ -->
<button id="theme-settings-fab" title="Cài đặt giao diện" onclick="toggleThemePanel()">🎨</button>

<!-- ═══════════════════════════════════════════════
     THEME SETTINGS PANEL
═══════════════════════════════════════════════ -->
<div id="theme-settings-panel">
  <div class="tsp-header">
    <span class="tsp-title">🎨 Cài đặt giao diện</span>
    <button class="tsp-close" onclick="toggleThemePanel()">✕</button>
  </div>
  <div class="tsp-body">

    <!-- Color picker -->
    <div class="tsp-row">
      <span class="tsp-label">Màu chủ đạo</span>
      <div class="tsp-colors" id="tspColorBtns">
        <button class="tsp-color-btn active" data-color="#0a68ff" style="background:#0a68ff" title="Xanh y tế"></button>
        <button class="tsp-color-btn" data-color="#0ea56b" style="background:#0ea56b" title="Xanh lá"></button>
        <button class="tsp-color-btn" data-color="#7c3aed" style="background:#7c3aed" title="Tím"></button>
        <button class="tsp-color-btn" data-color="#db2777" style="background:#db2777" title="Hồng"></button>
        <button class="tsp-color-btn" data-color="#ea580c" style="background:#ea580c" title="Cam"></button>
        <button class="tsp-color-btn" data-color="#0891b2" style="background:#0891b2" title="Teal"></button>
        <!-- Custom color picker -->
        <input type="color" id="tspCustomColor" title="Tùy chỉnh màu"
          style="width:32px;height:32px;border-radius:50%;border:3px solid transparent;cursor:pointer;padding:1px;background:none;">
      </div>
    </div>

    <!-- Dark mode toggle -->
    <div class="tsp-row">
      <div class="tsp-toggle-row">
        <span class="tsp-toggle-lbl">🌙 Chế độ tối</span>
        <input type="checkbox" class="tsp-toggle" id="tspDarkMode">
      </div>
    </div>

    <!-- Auto-theme by temperature toggle -->
    <div class="tsp-row">
      <div class="tsp-toggle-row">
        <span class="tsp-toggle-lbl">🌡️ Tự đổi màu theo nhiệt độ</span>
        <input type="checkbox" class="tsp-toggle" id="tspAutoTheme" checked>
      </div>
    </div>

    <!-- Theme status -->
    <div class="tsp-row" id="tspThemeStatusRow" style="background:var(--bg-main);border-radius:8px;padding:10px 12px;">
      <span class="tsp-label">Trạng thái theme hiện tại</span>
      <span id="tspCurrentTheme" style="font-size:0.85rem;font-weight:700;color:var(--primary);">🟢 Bình thường</span>
    </div>

  </div>
</div>

<!-- Theme alert banner -->
<div id="theme-alert-banner"></div>

<!-- ═══════════════════════════════════════════════
     DYNAMIC THEME SYSTEM — JS
═══════════════════════════════════════════════ -->
<script>
/* ─────────────────────────────────────────────────
   THEME SYSTEM — HealthAI Pro
   updateThemeByTemperature(temp):
     - 36.0–37.5°C → theme-normal (blue)
     - 37.6–38.4°C → theme-warning (orange)
     - ≥ 38.5°C    → theme-danger (red)
   Saves to localStorage, restores on reload.
   Supports: custom primary color, dark mode.
───────────────────────────────────────────────── */

(function() {
  'use strict';

  /* ── Constants ── */
  const LS_KEY = 'healthai_theme_v1';
  const TRANSITION_MS = 500;

  /* ── Default settings ── */
  const DEFAULT_SETTINGS = {
    autoTheme: true,
    darkMode: false,
    customColor: null,
    activeColorBtn: '#0a68ff',
    currentTheme: 'normal',
  };

  /* ── Load settings from localStorage ── */
  function loadSettings() {
    try {
      const raw = JSON.parse(localStorage.getItem(LS_KEY));
      return Object.assign({}, DEFAULT_SETTINGS, raw);
    } catch(e) {}
    return Object.assign({}, DEFAULT_SETTINGS);
  }

  /* ── Save settings ── */
  function saveSettings(s) {
    try { localStorage.setItem(LS_KEY, JSON.stringify(s)); } catch(e) {}
  }

  let settings = loadSettings();

  /* ─────────────────────────────────────────────
     lastTemperature — global guard to prevent redundant theme updates
  ───────────────────────────────────────────── */
  let lastTemperature = null;

  /* ─────────────────────────────────────────────
     updateThemeByTemperature(temp)
     Core function — determines + applies theme
  ───────────────────────────────────────────── */
  window.updateThemeByTemperature = function(temp) {
    // Safety check: if empty or NaN, do nothing
    if (temp === '' || temp === null || temp === undefined) return;
    const t = parseFloat(temp);
    if (isNaN(t)) return;

    // Only run if auto-theme is enabled
    if (!settings.autoTheme) return;

    // Skip if temperature hasn't changed
    if (t === lastTemperature) return;
    lastTemperature = t;

    let newTheme;
    if (t >= 38.5) {
      newTheme = 'danger';
    } else if (t >= 37.6) {
      newTheme = 'warning';
    } else if (t >= 36.0) {
      newTheme = 'normal';
    } else {
      newTheme = 'normal'; // sub-normal also normal theme
    }

    applyTheme(newTheme);
  };

  /* ─────────────────────────────────────────────
     applyTheme(themeName)
     Removes old classes, adds new class, shows banner
  ───────────────────────────────────────────── */
  function applyTheme(themeName) {
    const body = document.body;

    // Remove all theme classes
    body.classList.remove('theme-normal', 'theme-warning', 'theme-danger');

    // Add new theme class with transition
    // (CSS transition 0.5s on body handles the smooth change)
    body.classList.add('theme-' + themeName);

    // Update settings
    settings.currentTheme = themeName;
    saveSettings(settings);

    // Show banner notification if theme changed
    showThemeBanner(themeName);

    // Update panel status label
    updateThemeStatusLabel(themeName);
  }

  /* ─────────────────────────────────────────────
     showThemeBanner(themeName)
  ───────────────────────────────────────────── */
  let _bannerTimer = null;
  function showThemeBanner(theme) {
    const banner = document.getElementById('theme-alert-banner');
    if (!banner) return;

    const messages = {
      normal:  '✅ Nhiệt độ bình thường — Trạng thái tốt',
      warning: '⚠️ Nhiệt độ tăng — Cần theo dõi',
      danger:  '🚨 Nhiệt độ cao nguy hiểm — Cần xử lý ngay!',
    };
    banner.textContent = messages[theme] || '';
    banner.classList.add('show');

    clearTimeout(_bannerTimer);
    _bannerTimer = setTimeout(() => {
      banner.classList.remove('show');
    }, 3000);
  }

  /* ─────────────────────────────────────────────
     updateThemeStatusLabel
  ───────────────────────────────────────────── */
  function updateThemeStatusLabel(theme) {
    const el = document.getElementById('tspCurrentTheme');
    if (!el) return;
    const labels = {
      normal:  '🟢 Bình thường',
      warning: '🟡 Cảnh báo',
      danger:  '🔴 Nguy hiểm',
    };
    el.textContent = labels[theme] || labels.normal;
    el.style.color = 'var(--primary)';
  }

  /* ─────────────────────────────────────────────
     applyCustomColor(hex)
     Override --primary variable with custom color
  ───────────────────────────────────────────── */
  function applyCustomColor(hex) {
    if (!hex) {
      // Remove custom override — rely on theme class
      document.documentElement.style.removeProperty('--primary');
      document.documentElement.style.removeProperty('--primary-dark');
      document.documentElement.style.removeProperty('--primary-light');
    } else {
      document.documentElement.style.setProperty('--primary', hex);
      // Darken for primary-dark
      document.documentElement.style.setProperty('--primary-dark', shiftColor(hex, -30));
      document.documentElement.style.setProperty('--primary-light', shiftColor(hex, +30));
    }
    settings.customColor = hex;
    saveSettings(settings);
  }

  /* Simple hex color lightness shift */
  function shiftColor(hex, amount) {
    const num = parseInt(hex.replace('#',''), 16);
    const r = Math.max(0, Math.min(255, (num >> 16) + amount));
    const g = Math.max(0, Math.min(255, ((num >> 8) & 0xff) + amount));
    const b = Math.max(0, Math.min(255, (num & 0xff) + amount));
    return '#' + ((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1);
  }

  /* ─────────────────────────────────────────────
     Dark mode
  ───────────────────────────────────────────── */
  function applyDarkMode(enabled) {
    document.body.classList.toggle('dark-mode', enabled);
    settings.darkMode = enabled;
    saveSettings(settings);
  }

  /* ─────────────────────────────────────────────
     toggleThemePanel() — open/close the panel
  ───────────────────────────────────────────── */
  window.toggleThemePanel = function() {
    const panel = document.getElementById('theme-settings-panel');
    if (panel) panel.classList.toggle('open');
  };

  /* ─────────────────────────────────────────────
     Restore settings on load
  ───────────────────────────────────────────── */
  function restoreSettings() {
    // NOTE: Theme is intentionally NOT restored from localStorage.
    // Theme only changes when user inputs a temperature and clicks a button.
    // Remove all stale theme classes so body starts clean (no auto-coloring).
    document.body.classList.remove('theme-normal', 'theme-warning', 'theme-danger');

    // Apply dark mode
    if (settings.darkMode) {
      document.body.classList.add('dark-mode');
    }

    // Apply custom color
    if (settings.customColor) {
      applyCustomColor(settings.customColor);
    }

    // Sync panel controls
    const darkToggle = document.getElementById('tspDarkMode');
    if (darkToggle) darkToggle.checked = !!settings.darkMode;

    const autoToggle = document.getElementById('tspAutoTheme');
    if (autoToggle) autoToggle.checked = settings.autoTheme !== false;

    updateThemeStatusLabel(settings.currentTheme || 'normal');

    // Mark saved color button as active
    if (settings.activeColorBtn) {
      const btns = document.querySelectorAll('.tsp-color-btn[data-color]');
      btns.forEach(b => b.classList.toggle('active', b.dataset.color === settings.activeColorBtn));
    }
  }

  /* ─────────────────────────────────────────────
     Event listeners — Panel controls
  ───────────────────────────────────────────── */
  document.addEventListener('DOMContentLoaded', function() {
    restoreSettings();

    /* Color preset buttons */
    const colorBtns = document.querySelectorAll('.tsp-color-btn[data-color]');
    colorBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        colorBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const hex = this.dataset.color;
        settings.activeColorBtn = hex;
        // Only apply if auto-theme is OFF, else let theme control primary
        if (!settings.autoTheme) {
          applyCustomColor(hex);
        } else {
          // Store preference; when auto is re-enabled this gets reset
          settings.customColor = null;
          saveSettings(settings);
          // Temporarily apply as override
          applyCustomColor(hex);
        }
      });
    });

    /* Custom color input */
    const customColorInput = document.getElementById('tspCustomColor');
    if (customColorInput) {
      customColorInput.addEventListener('input', function() {
        colorBtns.forEach(b => b.classList.remove('active'));
        applyCustomColor(this.value);
        settings.activeColorBtn = null;
        saveSettings(settings);
      });
      if (settings.customColor) customColorInput.value = settings.customColor;
    }

    /* Dark mode toggle */
    const darkToggle = document.getElementById('tspDarkMode');
    if (darkToggle) {
      darkToggle.addEventListener('change', function() {
        applyDarkMode(this.checked);
      });
    }

    /* Auto-theme toggle */
    const autoToggle = document.getElementById('tspAutoTheme');
    if (autoToggle) {
      autoToggle.addEventListener('change', function() {
        settings.autoTheme = this.checked;
        saveSettings(settings);
        if (!this.checked) {
          // When disabling auto-theme, revert to normal
          document.body.classList.remove('theme-normal','theme-warning','theme-danger');
          document.body.classList.add('theme-normal');
        }
      });
    }

    /* ── Temperature simulation input ── */
    const tempSimInput = document.getElementById('tempSimInput');
    const tempSimBtn = document.getElementById('tempSimBtn');

    function handleTempSimulate() {
      if (!tempSimInput) return;
      const val = tempSimInput.value.trim();

      // Safety check: empty or NaN — do nothing
      if (!val || val === '') return;
      const t = parseFloat(val);
      if (isNaN(t)) return;

      // ✔ Cập nhật healthState — nguồn dữ liệu duy nhất
      window.healthState.temperature = t;

      // ✔ Cập nhật display #tmpVal
      const tmpEl = document.getElementById('tmpVal');
      if (tmpEl) tmpEl.textContent = t.toFixed(1);

      // ✔ Cập nhật theme từ healthState
      updateThemeByTemperature(t);

      // Ghi vào HealthStore để badge — KHÔNG trigger subscriber fill input
      // (subscriber mới chỉ cập nhật badge, không fill input nữa)
      if (window.HealthStore) {
        HealthStore.set({ temp: t }, 'manual_sim');
      }
    }

    if (tempSimBtn) {
      tempSimBtn.addEventListener('click', handleTempSimulate);
    }

    if (tempSimInput) {
      // Only fire on Enter key press, not on every keystroke
      tempSimInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') handleTempSimulate();
      });
      // Ensure input starts empty — no default value
      tempSimInput.value = '';
    }

    /* ── MutationObserver on #tmpVal intentionally REMOVED ──
       Reason: auto-firing updateThemeByTemperature when Firebase/fallback
       updates #tmpVal causes theme to change without user interaction.
       Theme only changes when user types a temperature AND clicks a button.
    ── */

  }); // end DOMContentLoaded

  // Apply immediately (before DOMContentLoaded) to avoid flash
  // NOTE: theme is intentionally NOT restored here — only dark mode is.
  // Theme is only applied when user inputs a temperature and clicks a button.
  (function earlyApply() {
    const s = loadSettings();
    if (s.darkMode) document.documentElement.classList.add('dark-mode-pre');
    // Do NOT restore s.currentTheme here — prevents auto-theme on load
  })();

})();
</script>

<script>
/* ═══════════════════════════════════════════════════════════════
   HEALTH FORM SYNC ENGINE v2
   Nguồn dữ liệu DUY NHẤT toàn hệ thống: window.healthState
   Áp dụng cho cả 2 form: AI Journal + AI Consultation
   ═══════════════════════════════════════════════════════════════ */

/* Khai báo healthState DUY NHẤT — không khai báo lại ở bất kỳ nơi nào khác */
if (!window.healthState) {
  window.healthState = {
    heartRate:   "",
    temperature: "",
    spo2:        "",
    sleep:       "",
    stress:      ""
  };
}

/* ── syncAllInputs(key): gán value đồng bộ cho tất cả [data-key=key] ── */
function syncAllInputs(key) {
  var val = window.healthState[key];
  document.querySelectorAll('[data-key="' + key + '"]').forEach(function(el) {
    if (el.value !== String(val)) {
      el.value = val;
    }
  });
  /* Stress slider: cập nhật label đi kèm */
  if (key === "stress") {
    var lbl = document.getElementById("nkai-stress-lbl");
    var valEl = document.getElementById("nkai-stress-val");
    if (lbl) lbl.textContent = val + "/10";
    if (valEl) valEl.textContent = val;
  }
}

/* ── 1 event listener duy nhất trên document (event delegation) ──
   Không gắn listener riêng cho từng input.
   Không setInterval / setTimeout / localStorage. ── */
document.addEventListener("input", function(e) {
  if (!e.target.dataset.key) return;
  var key = e.target.dataset.key;
  window.healthState[key] = e.target.value;
  syncAllInputs(key);
});

/* Expose toàn cục để haRun / nkaiGenerate đọc */
window.syncAllInputs = syncAllInputs;
</script>
</body>
</html>
